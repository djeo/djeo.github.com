/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox"],function(_1,_2,_3){_2.provide("esri.dijit.editing.SelectionHelper");_2.declare("esri.dijit.editing.SelectionHelper",null,{constructor:function(_4){this._settings=_4||{};this._sConnects=[];this._mapServiceCount=0;this._map=this._settings.map;this._tolerance=this._settings.singleSelectionTolerance;this._initMapServiceInfos(this._settings.layers);},destroy:function(){for(var _5 in this._sConnects){if(this._sConnects.hasOwnProperty(_5)){_2.disconnect(this._sConnects[_5]);}}},selectFeatures:function(_6,_7,_8,_9){if(_8===esri.layers.FeatureLayer.SELECTION_NEW){this._resetMapServiceInfos();this.getSelection(_6);}var _a=[];_2.forEach(_6,function(_b){if(_b.visible===true&&_b._isMapAtVisibleScale()===true){var _c=_8;if(_b._isSelOnly&&_c===esri.layers.FeatureLayer.SELECTION_NEW){_c=esri.layers.FeatureLayer.SELECTION_ADD;}_a.push(_b.selectFeatures(_7,_c));}});var _d=new _2.DeferredList(_a);_d.addCallback(_2.hitch(this,function(_e){var _f=[];_2.forEach(_e,function(set,idx){_2.forEach(set[1],function(_10){var _11=_10.attributes[_6[idx].objectIdField];_10=_6[idx]._mode._getFeature(_11)||null;if(_10){_f.push(_10);}},this);},this);if(!this._mapServiceCount){_9(_f);return;}var _12=_8===esri.layers.FeatureLayer.SELECTION_SUBTRACT;if(_12){this._resetMapServiceInfos();this._createLayerDefs(this._getLayerInfosFromSelection(_6));}else{this._createLayerDefs(this._getLayerInfosFromFeatures(_f));}this._updateLayerDefs(this._mapServiceInfos,false,!((_f&&_f.length)||_12),_2.hitch(this,_9,_f));}));},selectFeaturesByGeometry:function(_13,_14,_15,_16){var _17=_14;if(_14.declaredClass.indexOf("Extent")!==-1){if(_14.xmax==_14.xmin&&_14.ymax==_14.ymin){_17=new esri.geometry.Point(_14.xmax,_14.ymax);}}_17=(_17.declaredClass.indexOf("Point")!==-1)?this._extentFromPoint(_17):_17;var _18=new esri.tasks.Query();_18.geometry=_17;this.selectFeatures(_13,_18,_15,_16);},clearSelection:function(_19){var _1a=this._nonSelOnlyLayers;_2.forEach(_1a,"if (item.clearSelection){ item.clearSelection(); }");if(!this._mapServiceCount){return;}this._resetMapServiceInfos();var _1b=this._getLayerInfosFromSelection(this._settings.layers);var _1c=_2.some(_1b,"return item.oids && item.oids.length");if(_1c){this._createLayerDefs(_1b);this._updateLayerDefs(this._mapServiceInfos,true,_19||false);}},findMapService:function(_1d){var map=this._map;var _1e=map.layerIds;var _1f=(_1d&&_1d._url)?_1d._url.path.toLowerCase():"";var _20;for(var _21 in _1e){if(_1e.hasOwnProperty(_21)){_20=map.getLayer(_1e[_21]);var _22=_20._url?_20._url.path.toLowerCase().replace("mapserver","featureserver"):"";if(_1f.substr(0,_22.length)===_22&&_20.declaredClass==="esri.layers.ArcGISDynamicMapServiceLayer"){return _20;}}}},getSelection:function(_23){var _24=[];_2.forEach(_23,function(_25){if(_25._isSelOnly){_24.push(this._createLayerInfo(_25));}},this);_2.forEach(_24,function(_26){var _27=this._createMapServiceInfo(this.findMapService(_26.layer));if(_27){_27.layerInfos[_26.layer.layerId]=_26;}},this);},_initMapServiceInfos:function(_28){this._nonSelOnlyLayers=[];this._mapServiceInfos=[];_2.forEach(_28,function(_29){var _2a=this.findMapService(_29);if(_2a){this._mapServiceCount++;this._createMapServiceInfo(_2a);if(_2a){_2a.setDisableClientCaching(true);}}else{this._nonSelOnlyLayers.push(_29);}},this);},_createMapServiceInfo:function(_2b){if(!_2b){return null;}var _2c=this._mapServiceInfos;var _2d=_2c[_2b.id];if(!_2d){_2d=_2c[_2b.id]={mapService:_2b,layerInfos:[],layerDefs:_2.mixin([],_2b.layerDefinitions||[]),origLayerDefs:_2.mixin([],_2b.layerDefinitions||[])};}return _2d;},_resetMapServiceInfo:function(_2e){_2.forEach(_2e.layerInfos,this._resetLayerInfo);_2e.layerDefs=_2.mixin([],_2e.origLayerDefs||[]);},_resetMapServiceInfos:function(){var _2f=this._mapServiceInfos;for(var _30 in _2f){if(_2f.hasOwnProperty(_30)){this._resetMapServiceInfo(_2f[_30]);}}},_createLayerInfo:function(_31,_32){var _33=_31.objectIdField;var _34=_32?[]:_31.getSelectedFeatures();return {layer:_31,selectedFeatures:_34||[],oids:_2.map(_34,function(_35){return _35.attributes[_33];})};},_resetLayerInfo:function(_36){if(!_36){return;}_36.selectedFeatures=[];_36.oids=[];},_updateLayerDefs:function(_37,_38,_39,_3a){for(var _3b in _37){if(_37.hasOwnProperty(_3b)){var _3c=_37[_3b];var _3d=_3c.mapService;var _3e=_3c.layerDefs=(_38?_2.mixin([],_3c.origLayerDefs||[]):_3c.layerDefs);if(_3e){if(!_39){this._sConnects[_3d.id]=(_2.connect(_3d,"onUpdateEnd",_2.hitch(this,"_onMapServiceUpdate",_3c,_38,_3a)));}else{if(_3a){_3a();}}_3d.setLayerDefinitions(_3e,_39||false);}else{if(_3a){_3a();}}}}},_onMapServiceUpdate:function(_3f,_40,_41){_2.disconnect(this._sConnects[_3f.mapService.id]);_2.forEach(_3f.layerInfos,function(_42){if(_40){if(_42){_42.layer.clearSelection();}}else{var _43=new esri.tasks.Query();_43.objectIds=_42?_42.oids:[];if(_43.objectIds.length){_42.layer.selectFeatures(_43,esri.layers.FeatureLayer.SELECTION_SUBTRACT);}}},this);if(_40){this._resetMapServiceInfo(_3f);}if(_41){_41();}},_createLayerDefs:function(_44){_2.forEach(_44,function(_45){var _46=_45.layer;var _47=this._createMapServiceInfo(this.findMapService(_45.layer));if(!_47){return;}var _48=_47.mapService;var _49=_47.layerDefs;var _4a=_46.objectIdField;var _4b=_46.layerId;var _4c="(\""+_4a+"\" NOT IN (";var _4d=_45.oids;if(_4d&&_4d.length){_2.forEach(_45.oids,function(oid,idx){_4d=true;if(idx){_4c+=",";}_4c+="'"+oid+"'";});_4c+="))";if(_49.length&&(_49[_4b]&&_49[_4b].length)){_49[_4b]+=" AND"+_4c;}else{_49[_4b]=_4c;}}},this);},_getLayerInfosFromFeatures:function(_4e){var _4f=[];_2.forEach(_4e,function(_50){var _51=_50.getLayer();if(_51&&_51._isSelOnly){if(!_4f[_51.id]){_4f[_51.id]=this._createLayerInfo(_51,true);}_4f[_51.id].selectedFeatures.push(_50);_4f[_51.id].oids.push(_50.attributes[_51.objectIdField]);}},this);var _52=[];for(var _53 in _4f){if(_4f.hasOwnProperty(_53)){_52.push(_4f[_53]);}}return _52;},_getLayerInfosFromSelection:function(_54){var _55=[];_2.forEach(_54,function(_56){if(_56._isSelOnly){_55.push(this._createLayerInfo(_56,false));}},this);return _55;},_extentFromPoint:function(_57){var _58=this._tolerance;var map=this._map;var _59=map.toScreen(_57);var _5a=new esri.geometry.Point(_59.x-_58,_59.y+_58);var _5b=new esri.geometry.Point(_59.x+_58,_59.y-_58);var _5c=map.toMap(_5a);var _5d=map.toMap(_5b);return new esri.geometry.Extent(_5c.x,_5c.y,_5d.x,_5d.y,map.spatialReference);}});});