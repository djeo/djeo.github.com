/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dijit/_Widget,dojo/DeferredList,dojox/html/entities"],function(_1,_2,_3){_2.provide("esri.dijit.Legend");_2.require("dijit._Widget");_2.require("dojo.DeferredList");_2.require("dojox.html.entities");(function(){var _4=[_2.moduleUrl("esri.dijit","css/Legend.css")];var _5=document.getElementsByTagName("head").item(0),_6;for(var i=0,il=_4.length;i<il;i++){_6=document.createElement("link");_6.type="text/css";_6.rel="stylesheet";_6.href=_4[i].toString();_5.appendChild(_6);}}());_2.declare("esri.dijit.Legend",[_1._Widget],{widgetsInTemplate:false,layers:null,alignRight:false,_ieTimer:100,constructor:function(_7,_8){_2.mixin(this,esri.bundle.widgets.legend);_7=_7||{};if(!_7.map){console.error("esri.dijit.Legend: unable to find the 'map' property in parameters");return;}if(!_8){console.error("esri.dijit.Legend: must specify a container for the legend");return;}this.map=_7.map;this.layerInfos=_7.layerInfos;this._respectCurrentMapScale=(_7.respectCurrentMapScale===false)?false:true;this.arrangement=(_7.arrangement===esri.dijit.Legend.ALIGN_RIGHT)?esri.dijit.Legend.ALIGN_RIGHT:esri.dijit.Legend.ALIGN_LEFT;if(this.arrangement===esri.dijit.Legend.ALIGN_RIGHT){this.alignRight=true;}this.autoUpdate=(_7.autoUpdate===false)?false:true;this._surfaceItems=[];},startup:function(){this.inherited(arguments);this._initialize();if(_2.isIE){this._repaintItems=_2.hitch(this,this._repaintItems);setTimeout(this._repaintItems,this._ieTimer);}},destroy:function(){this._deactivate();this.inherited(arguments);},refresh:function(_9){if(!this.domNode){return;}if(_9){this.layerInfos=_9;this.layers=[];_2.forEach(this.layerInfos,function(_a){if(this._isSupportedLayerType(_a.layer)){if(_a.title){_a.layer._titleForLegend=_a.title;}if(_a.defaultSymbol===false){_a.layer._hideDefaultSymbolInLegend=true;}if(_a.hideLayers){_a.layer._hideLayersInLegend=_a.hideLayers;this._addSubLayersToHide(_a);}else{_a.layer._hideLayersInLegend=[];}this.layers.push(_a.layer);}},this);}else{if(this.useAllMapLayers){this.layerInfos=null;this.layers=null;}}for(var i=this.domNode.children.length-1;i>=0;i--){_2.destroy(this.domNode.children[i]);}this.startup();},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){if(this.layerInfos){this.layers=[];_2.forEach(this.layerInfos,function(_b){if(this._isSupportedLayerType(_b.layer)){if(_b.title){_b.layer._titleForLegend=_b.title;}if(_b.defaultSymbol===false){_b.layer._hideDefaultSymbol=true;}if(_b.hideLayers){_b.layer._hideLayersInLegend=_b.hideLayers;this._addSubLayersToHide(_b);}else{_b.layer._hideLayersInLegend=[];}this.layers.push(_b.layer);}},this);}this.useAllMapLayers=false;if(!this.layers){this.useAllMapLayers=true;this.layers=[];var _c=[];_2.forEach(this.map.layerIds,function(_d){var _e=this.map.getLayer(_d);if(this._isSupportedLayerType(_e)){if(_e.arcgisProps&&_e.arcgisProps.title){_e._titleForLegend=_e.arcgisProps.title;}this.layers.push(_e);}if(_e.declaredClass=="esri.layers.KMLLayer"){_2.forEach(_e.getLayers(),function(_f){_c.push(_f.id);},this);}},this);_2.forEach(this.map.graphicsLayerIds,function(_10){var _11=this.map.getLayer(_10);if(_2.indexOf(_c,_10)==-1){if(this._isSupportedLayerType(_11)&&_11._params&&_11._params.drawMode){if(_11.arcgisProps&&_11.arcgisProps.title){_11._titleForLegend=_11.arcgisProps.title;}this.layers.push(_11);}}},this);}this._createLegend();},_activate:function(){this._deactivate();if(!this.autoUpdate){return;}if(this._respectCurrentMapScale){this._ozeConnect=_2.connect(this.map,"onZoomEnd",this,"_refreshLayers");}if(this.useAllMapLayers){this._olaConnect=_2.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers");this._olrConnect=_2.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers");this._olroConnect=_2.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers");}_2.forEach(this.layers,function(_12){_12.ovcConnect=_2.connect(_12,"onVisibilityChange",this,"_refreshLayers");if(_12.declaredClass==="esri.layers.ArcGISDynamicMapServiceLayer"&&_12.supportsDynamicLayers){_12.odcConnect=_2.connect(_12,"_onDynamicLayersChange",this,"_updateDynamicLayers");}},this);},_deactivate:function(){if(this._ozeConnect){_2.disconnect(this._ozeConnect);}if(this._olaConnect){_2.disconnect(this._olaConnect);}if(this._olroConnect){_2.disconnect(this._olroConnect);}if(this._olrConnect){_2.disconnect(this._olrConnect);}_2.forEach(this.layers,function(_13){if(_13.ovcConnect){_2.disconnect(_13.ovcConnect);}if(_13.odcConnect){_2.disconnect(_13.odcConnect);}},this);},_updateDynamicLayers:function(){this._dynamicLayerChanged=true;this._refreshLayers();},_refreshLayers:function(){this.refresh();},_updateAllMapLayers:function(){this.layers=[];_2.forEach(this.map.layerIds,function(_14){var _15=this.map.getLayer(_14);if(this._isSupportedLayerType(_15)){this.layers.push(_15);}},this);_2.forEach(this.map.graphicsLayerIds,function(_16){var _17=this.map.getLayer(_16);if(this._isSupportedLayerType(_17)&&_17._params&&_17._params.drawMode){this.layers.push(_17);}},this);this.refresh();},_createLegend:function(){_2.style(this.domNode,"position","relative");_2.create("div",{id:this.id+"_msg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var _18=[];_2.forEach(this.layers,function(_19){if(_19.declaredClass=="esri.layers.KMLLayer"){_2.forEach(_19.getLayers(),function(_1a){if(_1a.declaredClass=="esri.layers.FeatureLayer"&&_19._titleForLegend){_1a._titleForLegend=_19._titleForLegend+" - ";if(_1a.geometryType=="esriGeometryPoint"){_1a._titleForLegend+="Points";}else{if(_1a.geometryType=="esriGeometryPolyline"){_1a._titleForLegend+="Lines";}else{if(_1a.geometryType=="esriGeometryPolygon"){_1a._titleForLegend+="Polygons";}}}_18.push(_1a);}});}else{_18.push(_19);}},this);var _1b=[];_2.forEach(_18,function(_1c){if(_1c.visible===true&&(_1c.layerInfos||_1c.renderer)){var d=_2.create("div",{id:this.id+"_"+_1c.id,style:"display: none;","class":"esriLegendService"});_2.create("span",{innerHTML:this._getServiceTitle(_1c),"class":"esriLegendServiceLabel"},_2.create("td",{align:(this.alignRight?"right":"")},_2.create("tr",{},_2.create("tbody",{},_2.create("table",{width:"95%"},d)))));_2.place(d,this.id,"first");if(_2.isIE){_2.style(_2.byId(this.id+"_"+_1c.id),"display","none");}if((_1c.legendResponse||_1c.renderer)&&!this._dynamicLayerChanged){this._createLegendForLayer(_1c);}else{_1b.push(this._legendRequest(_1c));}this._dynamicLayerChanged=false;}},this);if(_1b.length===0){_2.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate();}else{var _1d=new _2.DeferredList(_1b);_1d.addCallback(_2.hitch(this,function(_1e){_2.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate();}));}},_createLegendForLayer:function(_1f){if(_1f.legendResponse||_1f.renderer){var _20=false;if(_1f.legendResponse){_2.forEach(_1f.layerInfos,function(_21,i){if(!_1f._hideLayersInLegend||_2.indexOf(_1f._hideLayersInLegend,_21.id)==-1){var f=this._buildLegendItems(_1f,_21,i);_20=_20||f;}},this);}else{if(_1f.renderer){var id;if(!_1f.url){id="fc_"+_1f.id;}else{id=_1f.url.substring(_1f.url.lastIndexOf("/")+1,_1f.url.length);}var _22={id:id,name:null,subLayerIds:null,parentLayerId:-1};_20=this._buildLegendItems(_1f,_22,0);}}if(_20){_2.style(_2.byId(this.id+"_"+_1f.id),"display","block");_2.style(_2.byId(this.id+"_msg"),"display","none");}}},_legendRequest:function(_23){if(!_23.loaded){_2.connect(_23,"onLoad",_2.hitch(this,"_legendRequest"));return;}if(_23.version>=10.01){return this._legendRequestServer(_23);}else{return this._legendRequestTools(_23);}},_legendRequestServer:function(_24){var url=_24.url;var pos=url.indexOf("?");if(pos>-1){url=url.substring(0,pos)+"/legend"+url.substring(pos);}else{url+="/legend";}var _25=_24._getToken();if(_25){url+="?token="+_25;}var _26=_2.hitch(this,"_processLegendResponse");var _27={};_27.f="json";if(_24._params.dynamicLayers){_27.dynamicLayers=_24._params.dynamicLayers;if(_27.dynamicLayers==="[{}]"){_27.dynamicLayers="[]";}}var _28=esri.request({url:url,content:_27,callbackParamName:"callback",load:function(_29,_2a){_26(_24,_29,_2a);},error:esriConfig.defaults.io.errorHandler});return _28;},_legendRequestTools:function(_2b){var p=_2b.url.toLowerCase().indexOf("/rest/");var _2c=_2b.url.substring(0,p)+_2b.url.substring(p+5,_2b.url.length);var url=this._legendUrl+"?soapUrl="+escape(_2c);if(!_2.isIE||_2.isIE>8){url+="&returnbytes=true";}var _2d=_2.hitch(this,"_processLegendResponse");var _2e={};_2e.f="json";var _2f=esri.request({url:url,content:_2e,callbackParamName:"callback",load:function(_30,_31){_2d(_2b,_30,_31);},error:esriConfig.defaults.io.errorHandler});return _2f;},_processLegendResponse:function(_32,_33){if(_33&&_33.layers){_32.legendResponse=_33;this._createLegendForLayer(_32);}else{console.log("Legend could not get generated for "+_32.url+": "+_2.toJson(_33));}},_buildLegendItems:function(_34,_35,pos){var _36=false;var _37=_2.byId(this.id+"_"+_34.id);var _38=_35.subLayerIds;var _39=_35.parentLayerId;if(_38){var _3a=_2.create("div",{id:this.id+"_"+_34.id+"_"+_35.id+"_group",style:"display: none;","class":(_39==-1)?((pos>0)?"esriLegendGroupLayer":""):(this.alignRight?"esriLegendRight":"esriLegendLeft")},(_39==-1)?_37:_2.byId(this.id+"_"+_34.id+"_"+_39+"_group"));if(_2.isIE){_2.style(_2.byId(this.id+"_"+_34.id+"_"+_35.id+"_group"),"display","none");}_2.create("td",{innerHTML:_35.name.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"),align:(this.alignRight?"right":"")},_2.create("tr",{},_2.create("tbody",{},_2.create("table",{width:"95%","class":"esriLegendLayerLabel"},_3a))));}else{if(_34.visibleLayers&&(","+_34.visibleLayers+",").indexOf(","+_35.id+",")==-1){return _36;}var d=_2.create("div",{id:this.id+"_"+_34.id+"_"+_35.id,style:"display:none;","class":(_39>-1)?(this.alignRight?"esriLegendRight":"esriLegendLeft"):""},(_39==-1)?_37:_2.byId(this.id+"_"+_34.id+"_"+_39+"_group"));if(_2.isIE){_2.style(_2.byId(this.id+"_"+_34.id+"_"+_35.id),"display","none");}_2.create("td",{innerHTML:(_35.name)?_35.name.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"):"",align:(this.alignRight?"right":"")},_2.create("tr",{},_2.create("tbody",{},_2.create("table",{width:"95%","class":"esriLegendLayerLabel"},d))));if(_34.legendResponse){_36=_36||this._buildLegendItems_Tools(_34,_35,d);}else{if(_34.renderer){_36=_36||this._buildLegendItems_Renderer(_34,_35,d);}}}return _36;},_buildLegendItems_Tools:function(_3b,_3c,_3d){var _3e=_3c.parentLayerId;var _3f=esri.geometry.getScale(this.map);var _40=false;if(!this._respectCurrentMapScale||(this._respectCurrentMapScale&&this._isLayerInScale(_3b,_3c,_3f))){for(var i=0;i<_3b.legendResponse.layers.length;i++){if(_3c.id==_3b.legendResponse.layers[i].layerId){var _41=_3b.legendResponse.layers[i].legend;if(_41.length==3&&_41[0].label.replace(/\s+/g,"").indexOf(":Band_")>-1){}else{var _42=_2.create("tbody",{},_2.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_3d));_2.forEach(_41,function(_43){if((_43.url&&_43.url.indexOf("http")===0)||(_43.imageData&&_43.imageData.length>0)){_40=true;this._buildRow_Tools(_43,_42,_3b,_3c.id);}},this);}break;}}}if(_40){_2.style(_2.byId(this.id+"_"+_3b.id+"_"+_3c.id),"display","block");if(_3e>-1){_2.style(_2.byId(this.id+"_"+_3b.id+"_"+_3e+"_group"),"display","block");this._findParentGroup(_3b.id,_3b,_3e);}}return _40;},_buildRow_Tools:function(_44,_45,_46,_47){var tr=_2.create("tr",{},_45);var _48;var _49;if(this.alignRight){_48=_2.create("td",{align:"right"},tr);_49=_2.create("td",{align:"right",width:35},tr);}else{_49=_2.create("td",{width:35},tr);_48=_2.create("td",{},tr);}var src=_44.url;if((!_2.isIE||_2.isIE>8)&&_44.imageData&&_44.imageData.length>0){src="data:image/png;base64,"+_44.imageData;}else{if(_44.url.indexOf("http")!==0){src=_46.url+"/"+_47+"/images/"+_44.url;var _4a=_46._getToken();if(_4a){src+="?token="+_4a;}}}var img=_2.create("img",{src:src,border:0,style:"opacity:"+_46.opacity},_49);_2.create("td",{innerHTML:_44.label.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"),align:(this.alignRight?"right":"")},_2.create("tr",{},_2.create("tbody",{},_2.create("table",{width:"95%",dir:"ltr"},_48))));if(_2.isIE<9){img.style.filter="alpha(opacity="+(_46.opacity*100)+")";}},_buildLegendItems_Renderer:function(_4b,_4c,_4d){var _4e=_4c.parentLayerId;var _4f=esri.geometry.getScale(this.map);var _50=false;if(!this._respectCurrentMapScale||this._isLayerInScale(_4b,_4c,_4f)){var _51;if(_4b.renderer instanceof esri.renderer.UniqueValueRenderer){if(_4b.renderer.infos&&_4b.renderer.infos.length>0){_50=true;_51=_2.create("tbody",{},_2.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_4d));_2.forEach(_4b.renderer.infos,function(_52,_53){var _54=null;if(_4b._editable&&_4b.types){_54=this._getTemplateFromTypes(_4b.types,_52.value);}var _55=_52.label;if(!_55||_55.length===0){_55=_52.value;}this._buildRow_Renderer(_4b,_52.symbol,_55,_54,_51);},this);}}if(_4b.renderer instanceof esri.renderer.ClassBreaksRenderer){if(_4b.renderer.infos&&_4b.renderer.infos.length>0){_50=true;_51=_2.create("tbody",{},_2.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_4d));_2.forEach(_4b.renderer.infos,function(_56,_57){var _58=_56.label;if(!_58||_58.length===0){_58=_56.minValue+" - "+_56.maxValue;}this._buildRow_Renderer(_4b,_56.symbol,_58,null,_51);},this);}}if(_4b.renderer instanceof esri.renderer.SimpleRenderer){_50=true;_51=_2.create("tbody",{},_2.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_4d));var _59=null;if(_4b._editable&&_4b.templates&&_4b.templates.length>0){_59=_4b.templates[0];}this._buildRow_Renderer(_4b,_4b.renderer.symbol,_4b.renderer.label,_59,_51);}if(!_4b._hideDefaultSymbol&&_4b.renderer.defaultSymbol){_50=true;_51=_2.create("tbody",{},_2.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_4d));this._buildRow_Renderer(_4b,_4b.renderer.defaultSymbol,_4b.renderer.defaultLabel?_4b.renderer.defaultLabel:"others",null,_51);}}if(_50){_2.style(_2.byId(this.id+"_"+_4b.id+"_"+_4c.id),"display","block");if(_4e>-1){_2.style(_2.byId(this.id+"_"+_4b.id+"_"+_4e+"_group"),"display","block");this._findParentGroup(_4b.id,_4e);}}return _50;},_buildRow_Renderer:function(_5a,_5b,_5c,_5d,_5e){var tr=_2.create("tr",{},_5e);var _5f;var _60;if(this.alignRight){_5f=_2.create("td",{align:"right"},tr);_60=_2.create("td",{align:"right",width:35},tr);}else{_60=_2.create("td",{width:35},tr);_5f=_2.create("td",{},tr);}var _61=30;if(_5b.type=="simplemarkersymbol"){_61=Math.min(Math.max(_61,_5b.size+12),125);}else{if(_5b.type=="picturemarkersymbol"){_61=Math.min(Math.max(_61,_5b.width),125);}}var div=_2.create("div",{style:"width:"+_61+"px;height:"+_61+"px;"},_60);_2.create("td",{innerHTML:_5c?_5c.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;").replace(/^#/,""):"",align:(this.alignRight?"right":"")},_2.create("tr",{},_2.create("tbody",{},_2.create("table",{width:"95%"},_5f))));var _62=this._drawSymbol(div,_5b,_61,_61,_5d,_5a.opacity);this._surfaceItems.push(_62);},_drawSymbol:function(_63,sym,_64,_65,_66,_67){var _68=esri.symbol.fromJson(sym.toJson());if(_68.type==="simplelinesymbol"||_68.type==="cartographiclinesymbol"||_68.type==="textsymbol"){if(!_68.color){return;}var _69=_68.color.toRgba();_69[3]=_69[3]*_67;_68.color.setColor(_69);}else{if(_68.type==="simplemarkersymbol"||_68.type==="simplefillsymbol"){if(!_68.color){return;}var _69=_68.color.toRgba();_69[3]=_69[3]*_67;_68.color.setColor(_69);if(_68.outline&&_68.outline.color){_69=_68.outline.color.toRgba();_69[3]=_69[3]*_67;_68.outline.color.setColor(_69);}}else{if(_68.type==="picturemarkersymbol"){_63.style.opacity=_67;_63.style.filter="alpha(opacity=("+_67*100+"))";}}}var _6a=_3.gfx.createSurface(_63,_64,_65);if(_2.isIE){var _6b=_6a.getEventSource();_2.style(_6b,"position","relative");_2.style(_6b.parentNode,"position","relative");}var _6c=this._getDrawingToolShape(_68,_66)||esri.symbol.getShapeDescriptors(_68);var _6d;try{_6d=_6a.createShape(_6c.defaultShape).setFill(_6c.fill).setStroke(_6c.stroke);}catch(e){_6a.clear();_6a.destroy();return;}var dim=_6a.getDimensions();var _6e={dx:dim.width/2,dy:dim.height/2};var _6f=_6d.getBoundingBox(),_70=_6f.width,_71=_6f.height;if(_70>_64||_71>_65){var _72=_70>_71?_70:_71;var _73=_64<_65?_64:_65;var _74=(_73-5)/_72;_2.mixin(_6e,{xx:_74,yy:_74});}_6d.applyTransform(_6e);return _6a;},_getDrawingToolShape:function(_75,_76){var _77,_78=_76?_76.drawingTool||null:null;switch(_78){case "esriFeatureEditToolArrow":_77={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolTriangle":_77={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case "esriFeatureEditToolRectangle":_77={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case "esriFeatureEditToolCircle":_77={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":_77={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null;}return {defaultShape:_77,fill:_75.getFill(),stroke:_75.getStroke()};},_repaintItems:function(){_2.forEach(this._surfaceItems,function(_79){this._repaint(_79);},this);},_repaint:function(_7a){if(!_7a){return;}if(_7a.getStroke&&_7a.setStroke){_7a.setStroke(_7a.getStroke());}try{if(_7a.getFill&&_7a.setFill){_7a.setFill(_7a.getFill());}}catch(e){}if(_7a.children&&_2.isArray(_7a.children)){_2.forEach(_7a.children,this._repaint,this);}},_getTemplateFromTypes:function(_7b,_7c){for(var i=0;i<_7b.length;i++){if(_7b[i].id==_7c&&_7b[i].templates&&_7b[i].templates.length>0){return _7b[i].templates[0];}}return null;},_findParentGroup:function(_7d,_7e,_7f){var _80=_7e.layerInfos;for(var k=0;k<_80.length;k++){if(_7f==_80[k].id){if(_80[k].parentLayerId>-1){_2.style(_2.byId(this.id+"_"+_7d+"_"+_80[k].parentLayerId+"_group"),"display","block");this._findParentGroup(_7d,_7e,_80[k].parentLayerId);}break;}}},_addSubLayersToHide:function(_81){_2.forEach(_81.layer._hideLayersInLegend,function(_82){for(var i=0;i<_81.layer.layerInfos.length;i++){if(_81.layer.layerInfos[i].id===_82&&_81.layer.layerInfos[i].subLayerIds){_2.forEach(_81.layer.layerInfos[i].subLayerIds,function(_83){if(_2.indexOf(_81.layer._hideLayersInLegend,_83)===-1){_81.layer._hideLayersInLegend.push(_83);}});}}});},_isLayerInScale:function(_84,_85,_86){var _87=true;if(_84.legendResponse&&_84.legendResponse.layers){for(var i=0;i<_84.legendResponse.layers.length;i++){var _88=_84.legendResponse.layers[i];if(_85.id==_88.layerId){if(_88.minScale==0&&_84.tileInfo){_88.minScale=_84.tileInfo.lods[0].scale+1;}if(_88.maxScale==0&&_84.tileInfo){_88.maxScale=_84.tileInfo.lods[_84.tileInfo.lods.length-1].scale-1;}if((_88.minScale>0&&_88.minScale<_86)||_88.maxScale>_86){_87=false;}break;}}}else{if(_84.minScale||_84.maxScale){if((_84.minScale&&_84.minScale<_86)||_84.maxScale&&_84.maxScale>_86){_87=false;}}}return _87;},_getServiceTitle:function(_89){var _8a=_89._titleForLegend;if(!_8a){_8a=_89.url;if(!_89.url){_8a="";}else{if(_89.url.indexOf("/MapServer")>-1){_8a=_89.url.substring(0,_89.url.indexOf("/MapServer"));_8a=_8a.substring(_8a.lastIndexOf("/")+1,_8a.length);}else{if(_89.url.indexOf("/ImageServer")>-1){_8a=_89.url.substring(0,_89.url.indexOf("/ImageServer"));_8a=_8a.substring(_8a.lastIndexOf("/")+1,_8a.length);}else{if(_89.url.indexOf("/FeatureServer")>-1){_8a=_89.url.substring(0,_89.url.indexOf("/FeatureServer"));_8a=_8a.substring(_8a.lastIndexOf("/")+1,_8a.length);}}}}if(_89.name){if(_8a.length>0){_8a+=" - "+_89.name;}else{_8a=_89.name;}}}return _3.html.entities.encode(_8a);},_isSupportedLayerType:function(_8b){if(_8b&&(_8b.declaredClass==="esri.layers.ArcGISDynamicMapServiceLayer"||_8b.declaredClass==="esri.layers.ArcGISTiledMapServiceLayer"||_8b.declaredClass==="esri.layers.FeatureLayer"||_8b.declaredClass=="esri.layers.KMLLayer")){return true;}return false;}});_2.mixin(esri.dijit.Legend,{ALIGN_LEFT:0,ALIGN_RIGHT:1});});