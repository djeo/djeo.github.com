/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated"],function(_1,_2,_3){_2.provide("esri.dijit.editing.AttachmentEditor");_2.require("dijit._Widget");_2.require("dijit._Templated");(function(){var _4=[_2.moduleUrl("esri.dijit.editing","css/attachment.css")];var _5=document.getElementsByTagName("head").item(0),_6,i,il=_4.length;for(i=0;i<il;i++){_6=document.createElement("link");_6.type="text/css";_6.rel="stylesheet";_6.href=_4[i];_5.appendChild(_6);}}());_2.declare("esri.dijit.editing.AttachmentEditor",[_1._Widget,_1._Templated],{widgetsInTemplate:true,templateString:"<div class=\"attachmentEditor\">\r\n    <br />\r\n    <div>\r\n        <b>${NLS_attachments}</b>\r\n        <hr />\r\n        <br /> \r\n        <span dojoAttachPoint='_attachmentList' style='word-wrap: break-word;'></span>\r\n        <br><br>\r\n        <form dojoAttachPoint='_uploadForm'> ${NLS_add}:&nbsp;&nbsp;<input type='file' name='attachment' dojoAttachPoint='_uploadField' /> </form>\r\n    </div>\r\n</div>",basePath:_2.moduleUrl("esri.dijit.editing"),_listHtml:"<span id='node_${oid}_${attid}'><a href='${href}' target='_blank'>${name}</a>",_deleteBtnHtml:"(<span style='cursor:pointer;color:red;font-weight:bold;' class='deleteAttachment' id='${attid}');'>X</span>)",_endHtml:"<br/></span>",_aeConnects:[],_layerEditingCapChecked:{},_layerEditingCap:{},constructor:function(_7,_8){_2.mixin(this,esri.bundle.widgets.attachmentEditor);},startup:function(){this.inherited(arguments);this._uploadField_connect=_2.connect(this._uploadField,"onchange",this,"_addAttachment");},destroy:function(){_2.forEach(this._aeConnects,_2.disconnect);_2.disconnect(this._uploadField_connect);this.inherited(arguments);},showAttachments:function(_9,_a){var _b=this._attachmentList;_b.innerHTML=this.NLS_none;this._uploadField.value="";if(!_9){return;}this._featureLayer=_9.getLayer()||_a;if(!this._featureLayer){return;}this._currentLayerId=this._featureLayer.id;if(!this._layerEditingCapChecked[this._currentLayerId]){this._layerEditingCap[this._currentLayerId]=this._featureLayer.getEditCapabilities();this._layerEditingCapChecked[this._currentLayerId]=true;}this._featureCanUpdate=this._featureLayer.getEditCapabilities({feature:_9}).canUpdate;this._oid=_9.attributes[this._featureLayer.objectIdField];this._getAttachments(_9);},_getAttachments:function(_c){if(!this._featureLayer||!this._featureLayer.queryAttachmentInfos){return;}this._featureLayer.queryAttachmentInfos(this._oid,_2.hitch(this,"_onQueryAttachmentInfosComplete"));},_addAttachment:function(){if(!this._featureLayer||!this._featureLayer.addAttachment){return;}this._featureLayer.addAttachment(this._oid,this._uploadForm,_2.hitch(this,"_onAddAttachmentComplete"));},_deleteAttachment:function(_d,_e){this._featureLayer.deleteAttachments(_d,[_e],_2.hitch(this,"_onDeleteAttachmentComplete"));},_onQueryAttachmentInfosComplete:function(_f){var _10=this._listHtml+this._deleteBtnHtml+this._endHtml;this._uploadForm.style.display="block";if((!this._featureCanUpdate&&this._layerEditingCap[this._currentLayerId].canUpdate)||(!this._layerEditingCap[this._currentLayerId].canCreate&&!this._layerEditingCap[this._currentLayerId].canUpdate)){_10=this._listHtml+this._endHtml;this._uploadForm.style.display="none";}else{if(this._layerEditingCap[this._currentLayerId].canCreate&&!this._layerEditingCap[this._currentLayerId].canUpdate){_10=this._listHtml+this._endHtml;}}var _11=this._attachmentList,_12=_2.map(_f,_2.hitch(this,function(_13){return esri.substitute({href:_13.url,name:_13.name,oid:_13.objectId,attid:_13.id},_10);}));_11.innerHTML=_12.join("")||this.NLS_none;this._updateConnects();},_onAddAttachmentComplete:function(_14){var _15=this._uploadField;var _16=_15.value;var pos=_16.lastIndexOf("\\");if(pos>-1){_16=_16.substring(pos+1,_16.length);}_16=_16.replace(/\ /g,"_");var _17=this._attachmentList,_18=_2.objectToQuery({gdbVersion:this._featureLayer.gdbVersion,token:this._featureLayer._getToken()});var _19=this._listHtml+this._deleteBtnHtml+this._endHtml;if(this._layerEditingCap[this._currentLayerId].canCreate&&!this._layerEditingCap[this._currentLayerId].canUpdate){_19=this._listHtml+this._endHtml;}var _1a=esri.substitute({href:this._featureLayer._url.path+"/"+_14.objectId+"/attachments/"+_14.attachmentId+(_18?("?"+_18):""),name:_16,oid:_14.objectId,attid:_14.attachmentId},_19);_17.innerHTML=_17.innerHTML==this.NLS_none?_1a:(_17.innerHTML+_1a);this._updateConnects();_15.value="";},_onDeleteAttachmentComplete:function(_1b){var _1c=_2.every(_1b,function(_1d){return _1d.success;});if(_1c){_2.byId("node_"+_1b[0].objectId+"_"+_1b[0].attachmentId).innerHTML="";}},_updateConnects:function(){_2.forEach(this._aeConnects,_2.disconnect);_2.query(".deleteAttachment").forEach(function(_1e){this._aeConnects.push(_2.connect(_1e,"onclick",_2.hitch(this,"_deleteAttachment",this._oid,_1e.id)));},this);}});});