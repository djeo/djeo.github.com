/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dojo/fx,dojox/gfx,dijit/_Widget,dijit/_Templated,dijit/Editor,dijit/_editor/plugins/LinkDialog,dijit/_editor/plugins/TextColor,esri/dijit/editing/AttachmentEditor,esri/dijit/editing/Util,esri/tasks/query,dijit/form/DateTextBox,dijit/form/TextBox,dijit/form/NumberTextBox,dijit/form/FilteringSelect,dijit/form/NumberSpinner,dijit/form/Button,dijit/form/SimpleTextarea,dijit/Tooltip,dojo/data/ItemFileReadStore"],function(_1,_2,_3){_2.provide("esri.dijit.AttributeInspector");_2.require("dojo.fx");_2.require("dojox.gfx");_2.require("dijit._Widget");_2.require("dijit._Templated");_2.require("dijit.Editor");_2.require("dijit._editor.plugins.LinkDialog");_2.require("dijit._editor.plugins.TextColor");_2.require("esri.dijit.editing.AttachmentEditor");_2.require("esri.dijit.editing.Util");_2.require("esri.tasks.query");_2.require("dijit.form.DateTextBox");_2.require("dijit.form.TextBox");_2.require("dijit.form.NumberTextBox");_2.require("dijit.form.FilteringSelect");_2.require("dijit.form.NumberSpinner");_2.require("dijit.form.Button");_2.require("dijit.form.SimpleTextarea");_2.require("dijit.Tooltip");_2.require("dojo.data.ItemFileReadStore");(function(){var _4=document.createElement("link");_4.type="text/css";_4.rel="stylesheet";_4.href=_2.moduleUrl("esri","dijit/css/AttributeInspector.css");document.getElementsByTagName("head").item(0).appendChild(_4);})();_2.declare("esri.dijit.AttributeInspector",[_1._Widget,_1._Templated],{widgetsInTemplate:true,templateString:"<div class=\"esriAttributeInspector\">\r\n    <div class=\"atiLayerName\" dojoAttachPoint=\"layerName\"></div>\r\n    <div class=\"atiAttributes\" dojoAttachPoint=\"attributeTable\"></div>\r\n    <div dojoAttachPoint=\"attachmentEditor\"></div>\r\n    <div class=\"atiEditorTrackingInfo\" dojoAttachPoint=\"editorTrackingInfoDiv\"></div>\r\n    <div class=\"atiButtons\" dojoAttachPoint=\"editButtons\">\r\n        <button  dojoType=\"dijit.form.Button\" class=\"atiButton atiDeleteButton\"  dojoAttachPoint=\"deleteBtn\" dojoAttachEvent=\"onClick: onDeleteBtn\" showLabel=\"true\" type=\"button\">${NLS_deleteFeature}</button>\r\n        <div class=\"atiNavButtons\" dojoAttachPoint=\"navButtons\">\r\n            <div class=\"atiNavMessage\" dojoAttachPoint=\"navMessage\"></div>\r\n            <button  dojoType=\"dijit.form.Button\" iconClass=\"atiButton atiFirstIcon\" dojoAttachPoint=\"firstFeatureButton\" dojoAttachEvent=\"onClick: onFirstFeature\" showLabel=\"false\" type=\"button\">${NLS_first}</button>\r\n            <button  dojoType=\"dijit.form.Button\" iconClass=\"atiButton atiPrevIcon\" dojoAttachPoint=\"prevFeatureButton\" dojoAttachEvent=\"onClick: onPreviousFeature\" showLabel=\"false\" type=\"button\">${NLS_previous}</button>\r\n            <button  dojoType=\"dijit.form.Button\" iconClass=\"atiButton atiNextIcon\" dojoAttachPoint=\"nextFeatureButton\" dojoAttachEvent=\"onClick: onNextFeature\" showLabel=\"false\" type=\"button\">${NLS_next}</button>\r\n            <button  dojoType=\"dijit.form.Button\" iconClass=\"atiButton atiLastIcon\" dojoAttachPoint=\"lastFeatureButton\" dojoAttachEvent=\"onClick: onLastFeature\" showLabel=\"false\" type=\"button\">${NLS_last}</button>\r\n        </div>\r\n    </div>\r\n</div>\r\n",_navMessage:"( ${idx} ${of} ${numFeatures} )",onUpdate:function(){},onDelete:function(){},onAttributeChange:function(){},onNext:function(){},onReset:function(){},onCancel:function(){},constructor:function(_5,_6){_2.mixin(this,esri.bundle.widgets.attributeInspector);_5=_5||{};if(!_5.featureLayer&&!_5.layerInfos){console.error("esri.AttributeInspector: please provide correct parameter in the constructor");}this._userIds={};if(_5.featureLayer&&_5.featureLayer.credential){var _7=_5.featureLayer.id;this._userIds[_7]=_5.featureLayer.credential.userId;}else{if(_5.layerInfos){var _8=_5.layerInfos;_2.forEach(_8,function(_9){if(_9.featureLayer){var _a=_9.featureLayer.id;if(_9.featureLayer.credential){this._userIds[_a]=_9.featureLayer.credential.userId;}if(_9.userId){this._userIds[_a]=_9.userId;}}},this);}}this._datePackage=this._getDatePackage(_5);this._layerInfos=_5.layerInfos||[{featureLayer:_5.featureLayer,options:_5.options||[]}];this._aiConnects=[];this._selection=[];this._toolTips=[];this._numFeatures=0;this._featureIdx=0;this._currentLInfo=null;this._currentFeature=null;this._hideNavButtons=_5.hideNavButtons||false;},postCreate:function(){this._initLayerInfos();this._createAttachmentEditor();this.onFirstFeature();},destroy:function(){this._destroyAttributeTable();_2.forEach(this._aiConnects,_2.disconnect);delete this._aiConnects;if(this._attachmentEditor){this._attachmentEditor.destroy();delete this._attachmentEditor;}delete this._layerInfos;this._selection=this._currentFeature=this._currentLInfo=this._attributes=this._layerInfos=null;this.inherited(arguments);},refresh:function(){this._updateSelection();},first:function(){this.onFirstFeature();},last:function(){this.onLastFeature();},next:function(){this.onNextFeature();},previous:function(){this.onPreviousFeature();},showFeature:function(_b,_c){if(_c){this._createOnlyFirstTime=true;}this._updateSelection([_b],_c);this._updateUI();},onLayerSelectionChange:function(_d,_e,_f){this._createOnlyFirstTime=false;this._featureIdx=(_f===esri.layers.FeatureLayer.SELECTION_NEW)?0:this._featureIdx;this._updateSelection();this._updateUI();},onLayerSelectionClear:function(){if(!this._selection||this._selection.length<=0){return;}this._numFeatures=0;this._featureIdx=0;this._selection=[];this._currentFeature=null;this._currentLInfo=null;this._updateUI();},onLayerEditsComplete:function(_10,_11,_12,_13){_13=_13||[];if(_13.length){var _14=this._selection;var _15=_10.featureLayer.objectIdField;_2.forEach(_13,_2.hitch(this,function(del){_2.some(_14,_2.hitch(this,function(_16,idx){if(_16.attributes[_15]!==del.objectId){return false;}this._selection.splice(idx,1);return true;}));}));}_11=_11||[];if(_11.length){this._selection=esri.dijit.editing.Util.LayerHelper.findFeatures(_11,_10.featureLayer);this._featureIdx=0;}var _17=this._numFeatures=this._selection?this._selection.length:0;if(_11.length){var _18=_17?this._selection[this._featureIdx]:null;if(_18){var _19=_18.getLayer();var _1a=_19.getEditCapabilities();if(!(_1a.canCreate&&!_1a.canUpdate)){this._showFeature(_18);}}}this._updateUI();},onFieldValueChange:function(_1b,_1c){_1c=(typeof _1c==="undefined")?null:_1c;var _1d=_1b.field;if(_1d.type==="esriFieldTypeDate"){_1c=(_1c&&_1c.getTime)?_1c.getTime():(_1c&&_1c.toGregorian?_1c.toGregorian().getTime():_1c);}if(this._currentFeature.attributes[_1d.name]===_1c){return;}var _1e=this._currentLInfo;var _1f=this._currentFeature;var _20=_1d.name;if(_20===_1e.typeIdField){var _21=this._findFirst(_1e.types,"id",_1c);var _22=_1e.fieldInfos;_2.forEach(_22,function(_23){_1d=_23.field;if(!_1d||_1d.name===_1e.typeIdField){return;}var _24=_23.dijit;var _25=this._setFieldDomain(_24,_21,_1d);if(_25&&_24){this._setValue(_24,_1f.attributes[_1d.name]+"");if(_24.isValid()===false){this._setValue(_24,null);}}},this);}this.onAttributeChange(_1f,_20,_1c);},onDeleteBtn:function(evt){this._deleteFeature();},onNextFeature:function(evt){this._onNextFeature(1);},onPreviousFeature:function(evt){this._onNextFeature(-1);},onFirstFeature:function(evt){this._onNextFeature(this._featureIdx*-1);},onLastFeature:function(evt){this._onNextFeature((this._numFeatures-1)-this._featureIdx);},_initLayerInfos:function(){var _26=this._layerInfos;this._editorTrackingInfos={};_2.forEach(_26,this._initLayerInfo,this);},_initLayerInfo:function(_27){var _28=_27.featureLayer;this._connect(_28,"onSelectionComplete",_2.hitch(this,"onLayerSelectionChange",_27));this._connect(_28,"onSelectionClear",_2.hitch(this,"onLayerSelectionClear",_27));this._connect(_28,"onEditsComplete",_2.hitch(this,"onLayerEditsComplete",_27));_27.showAttachments=_28.hasAttachments?(esri._isDefined(_27.showAttachments)?_27.showAttachments:true):false;_27.hideFields=_27.hideFields||[];_27.htmlFields=_27.htmlFields||[];_27.isEditable=_28.isEditable()?(esri._isDefined(_27.isEditable)?_27.isEditable:true):false;_27.typeIdField=_28.typeIdField;_27.layerId=_28.id;_27.types=_28.types;if(!_27.showGlobalID&&_28.globalIdField){_27.hideFields.push(_28.globalIdField);}if(!_27.showObjectID){_27.hideFields.push(_28.objectIdField);}var _29=this._getFields(_27.featureLayer);if(!_29){return;}var _2a=_27.fieldInfos||[];_2a=_2.map(_2a,function(_2b){return _2.mixin({},_2b);});if(!_2a.length){_29=_2.filter(_29,_2.hitch(this,function(_2c){return !this._isInFields(_2c.name,_27.hideFields);}));_27.fieldInfos=_2.map(_29,_2.hitch(this,function(_2d){var _2e=(this._isInFields(_2d.name,_27.htmlFields)?esri.dijit.AttributeInspector.STRING_FIELD_OPTION_RICHTEXT:esri.dijit.AttributeInspector.STRING_FIELD_OPTION_TEXTBOX);return {"fieldName":_2d.name,"field":_2d,"stringFieldOption":_2e};}));}else{_27.fieldInfos=_2.filter(_2.map(_2a,_2.hitch(this,function(_2f){var _30=_2f.stringFieldOption||(this._isInFields(_2f.fieldName,_27.htmlFields)?esri.dijit.AttributeInspector.STRING_FIELD_OPTION_RICHTEXT:esri.dijit.AttributeInspector.STRING_FIELD_OPTION_TEXTBOX);return _2.mixin(_2f,{"field":this._findFirst(_29,"name",_2f.fieldName),"stringFieldOption":_30});})),"return item.field;");}var _31=[];if(_28.editFieldsInfo){if(_28.editFieldsInfo.creatorField){_31.push(_28.editFieldsInfo.creatorField);}if(_28.editFieldsInfo.creationDateField){_31.push(_28.editFieldsInfo.creationDateField);}if(_28.editFieldsInfo.editorField){_31.push(_28.editFieldsInfo.editorField);}if(_28.editFieldsInfo.editDateField){_31.push(_28.editFieldsInfo.editDateField);}}this._editorTrackingInfos[_28.id]=_31;},_createAttachmentEditor:function(){this._attachmentEditor=null;var _32=this._layerInfos;var _33=_2.filter(_32,"return item.showAttachments");if(!_33||!_33.length){return;}this._attachmentEditor=new esri.dijit.editing.AttachmentEditor({"class":"atiAttachmentEditor"},this.attachmentEditor);this._attachmentEditor.startup();},_setCurrentLInfo:function(_34){var _35=this._currentLInfo?this._currentLInfo.featureLayer:null;var _36=_34.featureLayer;if(_35&&_35.id===_36.id&&!_35.ownershipBasedAccessControlForFeatures){var _37=_36.getEditCapabilities();if(!(_37.canCreate&&!_37.canUpdate)){return;}}this._currentLInfo=_34;this._createTable();},_updateSelection:function(_38,_39){this._selection=_38||[];var _3a=this._layerInfos;_2.forEach(_3a,this._getSelection,this);var _3b=this._numFeatures=this._selection.length;var _3c=_3b?this._selection[this._featureIdx]:null;this._showFeature(_3c,_39);},_getSelection:function(_3d){var _3e=_3d.featureLayer.getSelectedFeatures();this._selection=this._selection.concat(_3e);},_updateUI:function(){var _3f=this._numFeatures;var _40=this._currentLInfo;this.layerName.innerHTML=(!_40||_3f===0)?this.NLS_noFeaturesSelected:(_40.featureLayer?_40.featureLayer.name:"");_2.style(this.attributeTable,"display",_3f?"":"none");_2.style(this.editButtons,"display",_3f?"":"none");_2.style(this.navButtons,"display",(!this._hideNavButtons&&(_3f>1)?"":"none"));this.navMessage.innerHTML=esri.substitute({idx:this._featureIdx+1,of:this.NLS_of,numFeatures:this._numFeatures},this._navMessage);if(this._attachmentEditor){_2.style(this._attachmentEditor.domNode,"display",((_40&&_40.showAttachments)&&_3f)?"":"none");}var _41=((_40&&_40.showDeleteButton===false)||!this._canDelete)?false:true;_2.style(this.deleteBtn.domNode,"display",_41?"":"none");if(this.domNode.parentNode&&this.domNode.parentNode.scrollTop>0){this.domNode.parentNode.scrollTop=0;}},_onNextFeature:function(_42){this._featureIdx+=_42;if(this._featureIdx<0){this._featureIdx=this._numFeatures-1;}else{if(this._featureIdx>=this._numFeatures){this._featureIdx=0;}}var _43=this._selection.length?this._selection[this._featureIdx]:null;this._showFeature(_43);this._updateUI();this.onNext(_43);},_deleteFeature:function(){this.onDelete(this._currentFeature);},_showFeature:function(_44,_45){if(!_44){return;}this._currentFeature=_44;var _46=_45?_45:_44.getLayer();var _47=_46.getEditCapabilities({feature:_44,userId:this._userIds[_46.id]});this._canUpdate=_47.canUpdate;this._canDelete=_47.canDelete;var _48=this._getLInfoFromFeatureLayer(_46);if(!_48){return;}this._setCurrentLInfo(_48);var _49=_44.attributes;var _4a=this._findFirst(_48.types,"id",_49[_48.typeIdField]);var _4b,_4c=null;var _4d=_48.fieldInfos;_2.forEach(_4d,function(_4e){_4c=_4e.field;_4b=_4e.dijit||null;if(!_4b){return;}var _4f=this._setFieldDomain(_4b,_4a,_4c);var _50=_49[_4c.name];_50=(_50&&_4f&&_4f.codedValues&&_4f.codedValues.length)?(_4f.codedValues[_50]?_4f.codedValues[_50].name:_50):_50;if(!esri._isDefined(_50)){_50="";}if(_4b.declaredClass==="dijit.form.DateTextBox"){_50=(_50==="")?null:new Date(_50);}else{if(_4b.declaredClass==="dijit.form.FilteringSelect"){_4b._lastValueReported=null;_50=_49[_4c.name]+"";}}try{this._setValue(_4b,_50);if(_4b.declaredClass==="dijit.form.FilteringSelect"&&_4b.isValid()===false){this._setValue(_4b,null);}}catch(error){_4b.set("displayedValue",this.NLS_errorInvalid,false);}},this);if(this._attachmentEditor&&_48.showAttachments){this._attachmentEditor.showAttachments(this._currentFeature);}var _51=_46.getEditSummary(_44);if(_51){this.editorTrackingInfoDiv.innerHTML=_51;esri.show(this.editorTrackingInfoDiv);}else{esri.hide(this.editorTrackingInfoDiv);}},_setFieldDomain:function(_52,_53,_54){if(!_52){return null;}var _55=_54.domain;if(_53&&_53.domains){if(_53.domains[_54.name]&&_53.domains[_54.name] instanceof esri.layers.InheritedDomain===false){_55=_53.domains[_54.name];}}if(!_55){return null;}if(_55.codedValues&&_55.codedValues.length>0){_52.set("store",this._toStore(_2.map(_55.codedValues,"return { id: item.code += '', name: item.name };")));this._setValue(_52,_55.codedValues[0].code);}else{_52.constraints={min:esri._isDefined(_55.minValue)?_55.minValue:Number.MIN_VALUE,max:esri._isDefined(_55.maxValue)?_55.maxValue:Number.MAX_VALUE};this._setValue(_52,_52.constraints.min);}return _55;},_setValue:function(_56,_57){if(!_56.set){return;}_56._onChangeActive=false;_56.set("value",_57,true);_56._onChangeActive=true;},_getFields:function(_58){var _59=_58._getOutFields();if(!_59){return null;}var _5a=_58.fields;return (_59=="*")?_5a:_2.filter(_2.map(_59,_2.hitch(this,"_findFirst",_5a,"name")),esri._isDefined);},_isInFields:function(_5b,_5c){if(!_5b||!_5c&&!_5c.length){return false;}return _2.some(_5c,function(_5d){return _5d.toLowerCase()===_5b.toLowerCase();});},_findFirst:function(_5e,_5f,_60){var _61=_2.filter(_5e,function(_62){return _62.hasOwnProperty(_5f)&&_62[_5f]===_60;});return (_61&&_61.length)?_61[0]:null;},_getLInfoFromFeatureLayer:function(_63){var _64=_63?_63.id:null;return this._findFirst(this._layerInfos,"layerId",_64);},_createTable:function(){this._destroyAttributeTable();this.attributeTable.innerHTML="";this._attributes=_2.create("table",{cellspacing:"0",cellpadding:"0"},this.attributeTable);var _65=_2.create("tbody",null,this._attributes);var _66=this._currentFeature;var _67=this._currentLInfo;var _68=this._findFirst(_67.types,"id",_66.attributes[_67.typeIdField]);var _69=_67.fieldInfos;_2.forEach(_69,_2.hitch(this,"_createField",_68,_65),this);this._createOnlyFirstTime=false;},_createField:function(_6a,_6b,_6c){var _6d=this._currentLInfo;var _6e=_6c.field;if(this._isInFields(_6e.name,_6d.hideFields)){return;}if(this._isInFields(_6e.name,this._editorTrackingInfos[_6d.featureLayer.id])){return;}var _6f=_2.create("tr",null,_6b);var td=_2.create("td",{innerHTML:_6c.label||_6e.alias||_6e.name,"class":"atiLabel"},_6f);td=_2.create("td",null,_6f);var _70=null;var _71=false;if(_6c.customField){_2.place(_6c.customField.domNode||_6c.customField,_2.create("div",null,td),"first");_70=_6c.customField;}else{if(_6d.isEditable===false||_6e.editable===false||_6c.isEditable===false||_6e.type==="esriFieldTypeOID"||_6e.type==="esriFieldTypeGlobalID"||(!this._canUpdate&&!this._createOnlyFirstTime)){_71=true;}}if(!_70&&(_6d.typeIdField&&_6e.name.toLowerCase()==_6d.typeIdField.toLowerCase())){_70=this._createTypeField(_6e,_6c,td);}else{if(!_70){_70=this._createDomainField(_6e,_6c,_6a,td);}}if(!_70){switch(_6e.type){case "esriFieldTypeString":_70=this._createStringField(_6e,_6c,td);break;case "esriFieldTypeDate":_70=this._createDateField(_6e,_6c,td);break;case "esriFieldTypeInteger":case "esriFieldTypeSmallInteger":_70=this._createIntField(_6e,_6c,td);break;case "esriFieldTypeSingle":case "esriFieldTypeDouble":_70=this._createFltField(_6e,_6c,td);break;default:_70=this._createStringField(_6e,_6c,td);break;}}if(_6c.tooltip&&_6c.tooltip.length){this._toolTips.push(new _1.Tooltip({connectId:[_70.id],label:_6c.tooltip}));}_70.onChange=_2.hitch(this,"onFieldValueChange",_6c);_70.set("disabled",_71);_6c.dijit=_70;},_createTypeField:function(_72,_73,_74){return new _1.form.FilteringSelect({"class":"atiField",name:_72.alias||_72.name,store:this._toStore(_2.map(this._currentLInfo.types,"return { id: item.id, name: item.name };")),searchAttr:"name"},_2.create("div",null,_74));},_createDomainField:function(_75,_76,_77,_78){var _79=_75.domain;if(_77&&_77.domains){if(_77.domains[_75.name]&&_77.domains[_75.name] instanceof esri.layers.InheritedDomain===false){_79=_77.domains[_75.name];}}if(!_79){return null;}if(_79.codedValues){return new _1.form.FilteringSelect({"class":"atiField",name:_75.alias||_75.name,store:null,searchAttr:"name",required:_75.nullable||false},_2.create("div",null,_78));}else{return new _1.form.NumberSpinner({"class":"atiField"},_2.create("div",null,_78));}},_createStringField:function(_7a,_7b,_7c){var _7d={"class":"atiField",trim:true,maxLength:_7a.length};if(_7b.stringFieldOption===esri.dijit.AttributeInspector.STRING_FIELD_OPTION_TEXTAREA){_7d["class"]+=" atiTextAreaField";return new _1.form.SimpleTextarea(_7d,_2.create("div",null,_7c));}else{if(_7b.stringFieldOption===esri.dijit.AttributeInspector.STRING_FIELD_OPTION_RICHTEXT){_7d["class"]+=" atiRichTextField";_7d.height="100%";_7d.width="100%";_7d.plugins=_7b.richTextPlugins||["bold","italic","underline","foreColor","hiliteColor","|","justifyLeft","justifyCenter","justifyRight","justifyFull","|","insertOrderedList","insertUnorderedList","indent","outdent","|","createLink"];return new _1.Editor(_7d,_2.create("div",null,_7c));}else{return new _1.form.TextBox(_7d,_2.create("div",null,_7c));}}},_createDateField:function(_7e,_7f,_80){var _81={"class":"atiField","trim":true};if(this._datePackage){_81.datePackage=this._datePackage;}return new _1.form.DateTextBox(_81,_2.create("div",null,_80));},_createIntField:function(_82,_83,_84){return new _1.form.NumberTextBox({"class":"atiField",constraints:{places:0},invalidMessage:this.NLS_validationInt,trim:true},_2.create("div",null,_84));},_createFltField:function(_85,_86,_87){return new _1.form.NumberTextBox({"class":"atiField",trim:true,invalidMessage:this.NLS_validationFlt},_2.create("div",null,_87));},_toStore:function(_88){return new _2.data.ItemFileReadStore({data:{identifier:"id",label:"name",items:_88}});},_connect:function(_89,evt,_8a){this._aiConnects.push(_2.connect(_89,evt,_8a));},_getDatePackage:function(_8b){if(_8b.datePackage===null){return null;}else{if(_8b.datePackage){return _8b.datePackage;}}return null;},_destroyAttributeTable:function(){var _8c=this.layerInfos;_2.forEach(_8c,function(_8d){var _8e=_8d.fieldInfos;_2.forEach(_8e,function(_8f){var _90=_8f.dijit;if(_90){_90._onChangeHandle=null;if(_8f.customField){return;}if(_90.destroyRecursive){_90.destroyRecursive();}else{if(_90.destroy){_90.destroy();}}}_8f.dijit=null;},this);},this);var _91=this._toolTips;_2.forEach(_91,"item.destroy(); delete item;");this._toolTips=[];if(this._attributes){_2.destroy(this._attributes);}}});_2.mixin(esri.dijit.AttributeInspector,{STRING_FIELD_OPTION_RICHTEXT:"richtext",STRING_FIELD_OPTION_TEXTAREA:"textarea",STRING_FIELD_OPTION_TEXTBOX:"textbox"});});