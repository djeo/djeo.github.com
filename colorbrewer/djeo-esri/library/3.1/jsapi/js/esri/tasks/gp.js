/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/tasks/_task,esri/layers/agsdynamic,dojo/date/locale"],function(_1,_2,_3){_2.provide("esri.tasks.gp");_2.require("esri.tasks._task");_2.require("esri.layers.agsdynamic");_2.require("dojo.date.locale");_2.declare("esri.tasks.Geoprocessor",esri.tasks._Task,{constructor:function(_4){this._jobUpdateHandler=_2.hitch(this,this._jobUpdateHandler);this._getJobStatus=_2.hitch(this,this._getJobStatus);this._getResultDataHandler=_2.hitch(this,this._getResultDataHandler);this._getResultImageHandler=_2.hitch(this,this._getResultImageHandler);this._executeHandler=_2.hitch(this,this._executeHandler);this._updateTimers=[];},updateDelay:1000,processSpatialReference:null,outputSpatialReference:null,outSpatialReference:null,setUpdateDelay:function(_5){this.updateDelay=_5;},setProcessSpatialReference:function(sr){this.processSpatialReference=sr;},setOutputSpatialReference:function(sr){this._setOutSR(sr);},setOutSpatialReference:function(sr){this._setOutSR(sr);},__msigns:[{n:"execute",c:3,a:[{i:0,p:["*"]}],e:2,f:1},{n:"submitJob",c:4,a:[{i:0,p:["*"]}],e:3}],_setOutSR:function(sr){this.outSpatialReference=this.outputSpatialReference=sr;},_getOutSR:function(){return this.outSpatialReference||this.outputSpatialReference;},_gpEncode:function(_6,_7,_8){for(var i in _6){var _9=_6[i];if(_2.isArray(_9)){_6[i]=_2.toJson(_2.map(_9,function(_a){return this._gpEncode({item:_a},true).item;},this));}else{if(_9 instanceof Date){_6[i]=_9.getTime();}}}return this._encode(_6,_7,_8);},_decode:function(_b){var _c=_b.dataType,_d,_e=new esri.tasks.ParameterValue(_b);if(_2.indexOf(["GPBoolean","GPDouble","GPLong","GPString"],_c)!==-1){return _e;}if(_c==="GPLinearUnit"){_e.value=new esri.tasks.LinearUnit(_e.value);}else{if(_c==="GPFeatureRecordSetLayer"||_c==="GPRecordSet"){_e.value=new esri.tasks.FeatureSet(_e.value);}else{if(_c==="GPDataFile"){_e.value=new esri.tasks.DataFile(_e.value);}else{if(_c==="GPDate"){_d=_e.value;if(_2.isString(_d)){_e.value=new esri.tasks.Date({date:_d});}else{_e.value=new Date(_d);}}else{if(_c==="GPRasterData"||_c==="GPRasterDataLayer"){var _f=_b.value.mapImage;if(_f){_e.value=new esri.layers.MapImage(_f);}else{_e.value=new esri.tasks.RasterData(_e.value);}}else{if(_c.indexOf("GPMultiValue:")!==-1){var _10=_c.split(":")[1];_d=_e.value;_e.value=_2.map(_d,function(_11){return this._decode({paramName:"_name",dataType:_10,value:_11}).value;},this);}else{console.log(this.declaredClass+" : "+esri.bundle.tasks.gp.gpDataTypeNotHandled+" : "+_e.dataType);_e=null;}}}}}}return _e;},submitJob:function(_12,_13,_14,_15,_16){var _17=this._getOutSR();var _18=_16.assembly,_19=this._gpEncode(_2.mixin({},this._url.query,{f:"json","env:outSR":(_17?(_17.wkid||_2.toJson(_17.toJson())):null),"env:processSR":(this.processSpatialReference?(this.processSpatialReference.wkid||_2.toJson(this.processSpatialReference.toJson())):null)},_12),null,_18&&_18[0]),_1a=this._jobUpdateHandler,_1b=this._errorHandler;return esri.request({url:this._url.path+"/submitJob",content:_19,callbackParamName:"callback",load:function(r,i){_1a(r,i,false,_13,_14,_16.dfd);},error:function(r){_1b(r,_15,_16.dfd);}});},_jobUpdateHandler:function(_1c,io,_1d,_1e,_1f,dfd){var _20=_1c.jobId,_21=new esri.tasks.JobInfo(_1c);this._successHandler([_21],"onStatusUpdate",_1f,_1d&&dfd);if(!_1d){clearTimeout(this._updateTimers[_20]);this._updateTimers[_20]=null;if(dfd){dfd.progress(_21);}switch(_1c.jobStatus){case esri.tasks.JobInfo.STATUS_SUBMITTED:case esri.tasks.JobInfo.STATUS_EXECUTING:case esri.tasks.JobInfo.STATUS_WAITING:case esri.tasks.JobInfo.STATUS_NEW:var _22=this._getJobStatus;this._updateTimers[_20]=setTimeout(function(){_22(_20,_1d,_1e,_1f,dfd);},this.updateDelay);break;default:this._successHandler([_21],"onJobComplete",_1e,dfd);}}},_getJobStatus:function(_23,_24,_25,_26,dfd){var _27=this._jobUpdateHandler;esri.request({url:this._url.path+"/jobs/"+_23,content:_2.mixin({},this._url.query,{f:"json"}),callbackParamName:"callback",load:function(){_27(arguments[0],arguments[1],_24,_25,_26,dfd);},error:this._errorHandler});},_getResultDataHandler:function(_28,io,_29,_2a,dfd){try{var _2b=this._decode(_28);this._successHandler([_2b],"onGetResultDataComplete",_29,dfd);}catch(err){this._errorHandler(err,_2a,dfd);}},getResultData:function(_2c,_2d,_2e,_2f){var _30=this._getResultDataHandler,_31=this._errorHandler;var dfd=new _2.Deferred(esri._dfdCanceller);dfd._pendingDfd=esri.request({url:this._url.path+"/jobs/"+_2c+"/results/"+_2d,content:_2.mixin({},this._url.query,{f:"json",returnType:"data"}),callbackParamName:"callback",load:function(r,i){_30(r,i,_2e,_2f,dfd);},error:function(r){_31(r,_2f,dfd);}});return dfd;},checkJobStatus:function(_32,_33,_34){var _35=this._jobUpdateHandler,_36=this._errorHandler;var dfd=new _2.Deferred(esri._dfdCanceller);dfd._pendingDfd=esri.request({url:this._url.path+"/jobs/"+_32,content:_2.mixin({},this._url.query,{f:"json"}),callbackParamName:"callback",load:function(r,i){_35(r,i,true,null,_33,dfd);},error:function(r){_36(r,_34,dfd);}});return dfd;},cancelJob:function(_37,_38,_39){var _3a=this._errorHandler;var dfd=new _2.Deferred(esri._dfdCanceller);dfd._pendingDfd=esri.request({url:this._url.path+"/jobs/"+_37+"/cancel",content:_2.mixin({},this._url.query,{f:"json"}),callbackParamName:"callback",load:_2.hitch(this,function(r,i){this._successHandler([r],"onJobCancel",_38,dfd);}),error:function(r){_3a(r,_39,dfd);}});return dfd;},execute:function(_3b,_3c,_3d,_3e){var _3f=this._getOutSR();var _40=_3e.assembly,_41=this._gpEncode(_2.mixin({},this._url.query,{f:"json","env:outSR":(_3f?(_3f.wkid||_2.toJson(_3f.toJson())):null),"env:processSR":(this.processSpatialReference?(this.processSpatialReference.wkid||_2.toJson(this.processSpatialReference.toJson())):null)},_3b),null,_40&&_40[0]),_42=this._executeHandler,_43=this._errorHandler;return esri.request({url:this._url.path+"/execute",content:_41,callbackParamName:"callback",load:function(r,i){_42(r,i,_3c,_3d,_3e.dfd);},error:function(r){_43(r,_3d,_3e.dfd);}});},_executeHandler:function(_44,io,_45,_46,dfd){try{var _47=_44.results,i,il,_48=_44.messages;for(i=0,il=_47.length;i<il;i++){_47[i]=this._decode(_47[i]);}for(i=0,il=_48.length;i<il;i++){_48[i]=new esri.tasks.GPMessage(_48[i]);}this._successHandler([_47,_48],"onExecuteComplete",_45,dfd);}catch(err){this._errorHandler(err,_46,dfd);}},_getResultImageHandler:function(_49,io,_4a,_4b,dfd){try{var _4c=this._decode(_49);this._successHandler([_4c],"onGetResultImageComplete",_4a,dfd);}catch(err){this._errorHandler(err,_4b,dfd);}},getResultImage:function(_4d,_4e,_4f,_50,_51){var _52=this._getResultImageHandler,_53=this._errorHandler,_54=this._gpEncode(_2.mixin({},this._url.query,{f:"json"},_4f.toJson()));var dfd=new _2.Deferred(esri._dfdCanceller);dfd._pendingDfd=esri.request({url:this._url.path+"/jobs/"+_4d+"/results/"+_4e,content:_54,callbackParamName:"callback",load:function(r,i){_52(r,i,_50,_51,dfd);},error:function(r){_53(r,_51,dfd);}});return dfd;},cancelJobStatusUpdates:function(_55){clearTimeout(this._updateTimers[_55]);this._updateTimers[_55]=null;},getResultImageLayer:function(_56,_57,_58,_59){var url=this._url.path+"/jobs/"+_56+"/results/"+_57;if(this._url.query){url+="?"+_2.objectToQuery(this._url.query);}var _5a=new esri.tasks._GPResultImageLayer(url,{imageParameters:_58},true);this.onGetResultImageLayerComplete(_5a);if(_59){_59(_5a);}return _5a;},onStatusUpdate:function(){},onJobComplete:function(){},onExecuteComplete:function(){},onGetResultDataComplete:function(){},onGetResultImageComplete:function(){},onGetResultImageLayerComplete:function(){},onJobCancel:function(){}});esri._createWrappers("esri.tasks.Geoprocessor");_2.declare("esri.tasks.JobInfo",null,{constructor:function(_5b){this.messages=[];_2.mixin(this,_5b);var _5c=this.messages;for(var i=0,il=_5c.length;i<il;i++){_5c[i]=new esri.tasks.GPMessage(_5c[i]);}},jobId:"",jobStatus:""});_2.mixin(esri.tasks.JobInfo,{STATUS_CANCELLED:"esriJobCancelled",STATUS_CANCELLING:"esriJobCancelling",STATUS_DELETED:"esriJobDeleted",STATUS_DELETING:"esriJobDeleting",STATUS_EXECUTING:"esriJobExecuting",STATUS_FAILED:"esriJobFailed",STATUS_NEW:"esriJobNew",STATUS_SUBMITTED:"esriJobSubmitted",STATUS_SUCCEEDED:"esriJobSucceeded",STATUS_TIMED_OUT:"esriJobTimedOut",STATUS_WAITING:"esriJobWaiting"});_2.declare("esri.tasks.GPMessage",null,{constructor:function(_5d){_2.mixin(this,_5d);}});_2.mixin(esri.tasks.GPMessage,{TYPE_INFORMATIVE:"esriJobMessageTypeInformative",TYPE_PROCESS_DEFINITION:"esriJobMessageTypeProcessDefinition",TYPE_PROCESS_START:"esriJobMessageTypeProcessStart",TYPE_PROCESS_STOP:"esriJobMessageTypeProcessStop",TYPE_WARNING:"esriJobMessageTypeWarning",TYPE_ERROR:"esriJobMessageTypeError",TYPE_EMPTY:"esriJobMessageTypeEmpty",TYPE_ABORT:"esriJobMessageTypeAbort"});_2.declare("esri.tasks.LinearUnit",null,{constructor:function(_5e){if(_5e){_2.mixin(this,_5e);}},distance:0,units:null,toJson:function(){var _5f={};if(this.distance){_5f.distance=this.distance;}if(this.units){_5f.units=this.units;}return _5f;}});_2.declare("esri.tasks.DataFile",null,{constructor:function(_60){if(_60){_2.mixin(this,_60);}},url:null,itemID:null,toJson:function(){var _61={};if(this.url){_61.url=this.url;}if(this.itemID){_61.itemID=this.itemID;}return _61;}});_2.declare("esri.tasks.RasterData",null,{constructor:function(_62){if(_62){_2.mixin(this,_62);}},url:null,format:null,itemID:null,toJson:function(){var _63={};if(this.url){_63.url=this.url;}if(this.format){_63.format=this.format;}if(this.itemID){_63.itemID=this.itemID;}return _63;}});_2.declare("esri.tasks.Date",null,{constructor:function(_64){if(_64){if(_64.format){this.format=_64.format;}this.date=_2.date.locale.parse(_64.date,{selector:"date",datePattern:this.format});}},date:new Date(),format:"EEE MMM dd HH:mm:ss zzz yyyy",toJson:function(){return {date:_2.date.locale.format(this.date,{selector:"date",datePattern:this.format}),format:this.format};}});_2.declare("esri.tasks.ParameterValue",null,{constructor:function(_65){_2.mixin(this,_65);}});_2.declare("esri.tasks._GPResultImageLayer",esri.layers.ArcGISDynamicMapServiceLayer,{constructor:function(url,_66){if(_66&&_66.imageParameters&&_66.imageParameters.extent){this.initialExtent=(this.fullExtent=_66.imageParameters.extent);this.spatialReference=this.initialExtent.spatialReference;}this.getImageUrl=_2.hitch(this,this.getImageUrl);this.loaded=true;this.onLoad(this);},getImageUrl:function(_67,_68,_69,_6a){var _6b=this._url.path+"?",_6c=this._params,sr=_67.spatialReference.wkid;_6a(_6b+_2.objectToQuery(_2.mixin(_6c,{f:"image",bbox:_2.toJson(_67.toJson()),bboxSR:sr,imageSR:sr,size:_68+","+_69})));}});});