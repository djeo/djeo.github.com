/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/utils,esri/layers/layer,esri/layers/MapImageLayer,esri/layers/FeatureLayer,esri/dijit/Popup"],function(_1,_2,_3){_2.provide("esri.layers.KMLLayer");_2.require("esri.utils");_2.require("esri.layers.layer");_2.require("esri.layers.MapImageLayer");_2.require("esri.layers.FeatureLayer");_2.require("esri.dijit.Popup");_2.declare("esri.layers.KMLLayer",[esri.layers.Layer],{serviceUrl:"http://utility.arcgis.com/sharing/kml",constructor:function(_4,_5){if(!_4){console.log("KMLLayer:constructor - please provide url for the KML file");}this._outSR=(_5&&_5.outSR)||new esri.SpatialReference({wkid:4326});this._options=_5;if(esri.config.defaults.kmlService){this.serviceUrl=esri.config.defaults.kmlService;}var _6=(this.linkInfo=_5&&_5.linkInfo);if(_6){this.visible=!!_6.visibility;this._waitingForMap=!!_6.viewFormat;}if(!_6||(_6&&_6.visibility&&!this._waitingForMap)){this._parseKml();}this.refresh=_2.hitch(this,this.refresh);},getFeature:function(_7){if(!_7){return;}var _8=_7.type,id=_7.id,_9,i,_a;switch(_8){case "esriGeometryPoint":case "esriGeometryPolyline":case "esriGeometryPolygon":var _b=this["_"+_8];if(_b){_9=_2.getObject("_mode._featureMap."+id,false,_b);}break;case "GroundOverlay":var _c=this._groundLyr;if(_c){var _d=_c.getImages();_a=_d.length;for(i=0;i<_a;i++){if(_d[i].id===id){_9=_d[i];break;}}}break;case "ScreenOverlay":break;case "NetworkLink":_2.some(this._links,function(_e){if(_e.linkInfo&&_e.linkInfo.id===id){_9=_e;return true;}else{return false;}});break;case "Folder":var _f=this.folders;_a=_f?_f.length:0;for(i=0;i<_a;i++){if(_f[i].id===id){_9=_f[i];break;}}break;default:console.log("KMLLayer:getFeature - unknown feature type");break;}return _9;},getLayers:function(){var _10=[];if(this._groundLyr){_10.push(this._groundLyr);}if(this._fLayers){_10=_10.concat(this._fLayers);}if(this._links){_2.forEach(this._links,function(_11){if(_11.declaredClass){_10.push(_11);}});}return _10;},setFolderVisibility:function(_12,_13){if(!_12){return;}this._fireUpdateStart();_12.visible=_13;if(_13){_13=this._areLocalAncestorsVisible(_12);}this._setState(_12,_13);this._fireUpdateEnd();},onRefresh:function(){},_parseKml:function(map){var _14=this;this._fireUpdateStart();this._io=esri.request({url:this.serviceUrl,content:{url:this._url.path+this._getQueryParameters(map),model:"simple",folders:"",refresh:this.loaded?true:undefined,outSR:_2.toJson(this._outSR.toJson())},callbackParamName:"callback",load:function(_15){_14._io=null;_14._initLayer(_15);},error:function(err){_14._io=null;err=_2.mixin(new Error(),err);err.message="Unable to load KML: "+_14.url+" "+(err.message||"");_14._fireUpdateEnd(err);_14.onError(err);}});},_initLayer:function(_16){if(this.loaded){this._removeInternalLayers();}this.name=_16.name;this.description=_16.description;this.snippet=_16.snippet;this.visibility=_16.visibility;this.featureInfos=_16.featureInfos;var i,len;var _17=(this.folders=_16.folders),_18=[],_19;if(_17){len=_17.length;for(i=0;i<len;i++){_19=(_17[i]=new esri.layers.KMLFolder(_17[i]));if(_19.parentFolderId===-1){_18.push(_19);}}}var _1a=(this._links=_16.networkLinks),_1b;len=_1a?_1a.length:0;for(i=0;i<len;i++){if(_1a[i].viewRefreshMode&&_1a[i].viewRefreshMode.toLowerCase().indexOf("onregion")!==-1){continue;}_1b=_2.mixin({},this._options);_1b.linkInfo=_1a[i];if(_1b.id){_1b.id=_1b.id+"_"+i;}_1a[i]=new esri.layers.KMLLayer(_1a[i].href,_1b);_1a[i]._parentLayer=this;_1a[i]._parentFolderId=this._getLinkParentId(_1a[i].linkInfo.id);}var _1c=_16.groundOverlays;if(_1c&&_1c.length>0){_1b=_2.mixin({},this._options);if(_1b.id){_1b.id=_1b.id+"_"+"mapImage";}var _1d=(this._groundLyr=new esri.layers.MapImageLayer(_1b));len=_1c.length;for(i=0;i<len;i++){_1d.addImage(new esri.layers.KMLGroundOverlay(_1c[i]));}}var _1e=_2.getObject("featureCollection.layers",false,_16);if(_1e&&_1e.length>0){this._fLayers=[];_2.forEach(_1e,function(_1f,i){var _20=_2.getObject("featureSet.features",false,_1f),_21;if(_20&&_20.length>0){_1b=_2.mixin({outFields:["*"],infoTemplate:_1f.popupInfo?new esri.dijit.PopupTemplate(_1f.popupInfo):null,editable:false},this._options);if(_1b.id){_1b.id=_1b.id+"_"+i;}_1f.layerDefinition.capabilities="Query,Data";_21=new esri.layers.FeatureLayer(_1f,_1b);if(_21.geometryType){this["_"+_21.geometryType]=_21;}this._fLayers.push(_21);}},this);if(this._fLayers.length===0){delete this._fLayers;}}len=_18.length;for(i=0;i<len;i++){_19=_18[i];this._setState(_19,_19.visible);}this._fireUpdateEnd();if(this.loaded){this._addInternalLayers();this.onRefresh();}else{this.loaded=true;this.onLoad(this);}},_addInternalLayers:function(){var map=this._map;this._fireUpdateStart();if(this._links){_2.forEach(this._links,function(_22){if(_22.declaredClass){map.addLayer(_22);if(_22._waitingForMap){_22._waitingForMap=null;if(_22.visible){_22._parseKml(map);}else{_22._wMap=map;}}}});}var _23=map.spatialReference,_24=this._outSR,_25,_26;if(_23.wkid){_25=(_23._isWebMercator()&&_24._isWebMercator())||(_23.wkid===_24.wkid);}else{if(_23.wkt){_25=(_23.wkt===_24.wkt);}else{console.log("KMLLayer:_setMap - map has invalid spatial reference");return;}}if(!_25){if(_23._isWebMercator()&&_24.wkid===4326){_26=esri.geometry.geographicToWebMercator;}else{if(_24._isWebMercator()&&_23.wkid===4326){_26=esri.geometry.webMercatorToGeographic;}else{console.log("KMLLayer:_setMap - unsupported workflow. Spatial reference of the map and kml layer do not match, and the conversion cannot be done on the client.");return;}}}if(this._groundLyr){if(_26){_2.forEach(this._groundLyr.getImages(),function(_27){_27.extent=_26(_27.extent);});}map.addLayer(this._groundLyr);}var _28=this._fLayers;if(_28&&_28.length>0){_2.forEach(_28,function(_29){if(_26){var _2a=_29.graphics,i,_2b,len=_2a?_2a.length:0;for(i=0;i<len;i++){_2b=_2a[i].geometry;if(_2b){_2a[i].setGeometry(_26(_2b));}}}map.addLayer(_29);});}this.onVisibilityChange(this.visible);},_removeInternalLayers:function(){var map=this._map;if(this._links){_2.forEach(this._links,function(_2c){if(_2c.declaredClass&&_2c._io){_2c._io.cancel();}});}if(map){_2.forEach(this.getLayers(),map.removeLayer,map);}},_setState:function(_2d,_2e){var _2f=_2d.featureInfos,_30,_31,i,len=_2f?_2f.length:0,_32=_2e?"show":"hide";for(i=0;i<len;i++){_30=_2f[i];_31=this.getFeature(_30);if(!_31){continue;}if(_30.type==="Folder"){this._setState(_31,_2e&&_31.visible);}else{if(_30.type==="NetworkLink"){this._setInternalVisibility(_31,_2e);}else{_31[_32]();}}}},_areLocalAncestorsVisible:function(_33){var _34=_33.parentFolderId,_35=_33.visible;while(_35&&_34!==-1){var _36=this.getFeature({type:"Folder",id:_34});_35=_35&&_36.visible;_34=_36.parentFolderId;}return _35;},_setInternalVisibility:function(_37,_38){var _39=_37._parentLayer,_3a=_37._parentFolderId;_38=_38&&_37.visible;while(_38&&_39){_38=_38&&_39.visible;if(_3a>-1){_38=_38&&_39._areLocalAncestorsVisible(_39.getFeature({type:"Folder",id:_3a}));}_3a=_39._parentFolderId;_39=_39._parentLayer;}this._setIntState(_37,_38);},_setIntState:function(_3b,_3c){if(!_3b){return;}_2.forEach(_3b.getLayers(),function(_3d){if(_3d.linkInfo){_3b._setIntState(_3d,_3c&&_3d.visible&&_3b._areLocalAncestorsVisible(_3b.getFeature({type:"Folder",id:_3d._parentFolderId})));}else{_3d.setVisibility(_3c);}});},_getLinkParentId:function(id){var _3e=-1;if(this.folders){_2.some(this.folders,function(_3f){if(_3f.networkLinkIds&&_2.indexOf(_3f.networkLinkIds,id)!==-1){_3e=_3f.id;return true;}return false;});}return _3e;},_checkAutoRefresh:function(){var _40=this.linkInfo;if(_40){if(this.visible){if(this.loaded&&this._map){var _41=_40.refreshMode,_42=_40.refreshInterval,_43=_40.viewRefreshMode,_44=_40.viewRefreshTime;if(_41&&_41.toLowerCase().indexOf("oninterval")!==-1&&_42>0){this._stopAutoRefresh();this._timeoutHandle=setTimeout(this.refresh,_42*1000);}if(_43&&_43.toLowerCase().indexOf("onstop")!==-1&&_44>0){if(!this._extChgHandle){this._extChgHandle=_2.connect(this._map,"onExtentChange",this,this._extentChanged);}}}}else{this._stopAutoRefresh();_2.disconnect(this._extChgHandle);delete this._extChgHandle;}}},_stopAutoRefresh:function(){clearTimeout(this._timeoutHandle);this._timeoutHandle=null;},_getQueryParameters:function(map){map=map||this._map;var _45={},_46=this.linkInfo,_47=map&&map.extent,_48;if(this._url.query){_2.mixin(_45,this._url.query);_48=!!this._url.query.token;}if(esri.id&&!_48){var _49=esri.id.findCredential(this._url.path);if(_49){_45.token=_49.token;}}if(_46){var _4a=_46.viewFormat,_4b=_46.httpQuery,_4c=_46.viewBoundScale;if(_47&&_4a){var _4d=_47,_4e=_47,sr=_47.spatialReference;if(sr){if(sr._isWebMercator()){_4d=esri.geometry.webMercatorToGeographic(_47);}else{if(sr.wkid===4326){_4e=esri.geometry.geographicToWebMercator(_47);}}}var _4f=_4d.getCenter(),_50=Math.max(_4e.getWidth(),_4e.getHeight());if(_4c){_4d=_4d.expand(_4c);}_4a=_4a.replace(/\[bboxWest\]/ig,_4d.xmin).replace(/\[bboxEast\]/ig,_4d.xmax).replace(/\[bboxSouth\]/ig,_4d.ymin).replace(/\[bboxNorth\]/ig,_4d.ymax).replace(/\[lookatLon\]/ig,_4f.x).replace(/\[lookatLat\]/ig,_4f.y).replace(/\[lookatRange\]/ig,_50).replace(/\[lookatTilt\]/ig,0).replace(/\[lookatHeading\]/ig,0).replace(/\[lookatTerrainLon\]/ig,_4f.x).replace(/\[lookatTerrainLat\]/ig,_4f.y).replace(/\[lookatTerrainAlt\]/ig,0).replace(/\[cameraLon\]/ig,_4f.x).replace(/\[cameraLat\]/ig,_4f.y).replace(/\[cameraAlt\]/ig,_50).replace(/\[horizFov\]/ig,60).replace(/\[vertFov\]/ig,60).replace(/\[horizPixels\]/ig,map.width).replace(/\[vertPixels\]/ig,map.height).replace(/\[terrainEnabled\]/ig,0);_2.mixin(_45,_2.queryToObject(_4a));}if(_4b){_4b=_4b.replace(/\[clientVersion\]/ig,esri.version).replace(/\[kmlVersion\]/ig,2.2).replace(/\[clientName\]/ig,"ArcGIS API for JavaScript").replace(/\[language\]/ig,_2.locale);_2.mixin(_45,_2.queryToObject(_4b));}}var _51=[],_52;for(_52 in _45){if(esri._isDefined(_45[_52])){_51.push(_52+"="+_45[_52]);}}_51=_51.join("&");return _51?("?"+_51):"";},_setMap:function(map,_53){this._map=map;var div=this._div=_2.create("div",null,_53);_2.style(div,"position","absolute");this._addInternalLayers();return div;},_unsetMap:function(map,_54){if(this._io){this._io.cancel();}this._stopAutoRefresh();_2.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var div=this._div;if(div){_54.removeChild(div);_2.destroy(div);}this._map=this._wMap=this._div=null;},onVisibilityChange:function(_55){if(!this.loaded){if(this.linkInfo&&_55){if(!this._waitingForMap){this._parseKml(this._wMap);}}return;}this._fireUpdateStart();this._setInternalVisibility(this,_55);this._checkAutoRefresh();this._fireUpdateEnd();},refresh:function(){if(!this.loaded||!this._map||this._io){return;}this._parseKml();},_extentChanged:function(){this._stopAutoRefresh();this._timeoutHandle=setTimeout(this.refresh,this.linkInfo.viewRefreshTime*1000);}});_2.declare("esri.layers.KMLGroundOverlay",[esri.layers.MapImage],{constructor:function(_56){if(esri._isDefined(this.visibility)){this.visible=!!this.visibility;}}});_2.declare("esri.layers.KMLFolder",null,{constructor:function(_57){_2.mixin(this,_57);if(esri._isDefined(this.visibility)){this.visible=!!this.visibility;}}});});