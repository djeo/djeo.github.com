/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/layers/graphics,esri/tasks/query,dojo/io/iframe,esri/layers/agscommon,dojo/date/locale"],function(_1,_2,_3){_2.provide("esri.layers.FeatureLayer");_2.require("esri.layers.graphics");_2.require("esri.tasks.query");_2.require("dojo.io.iframe");_2.require("esri.layers.agscommon");_2.require("dojo.date.locale");_2.declare("esri.layers.FeatureLayer",esri.layers.GraphicsLayer,{constructor:function(_4,_5){this._outFields=_5&&_5.outFields;this._loadCallback=_5&&_5.loadCallback;var _6=_5&&_5._usePatch;this._usePatch=(_6===null||_6===undefined)?true:_6;this._trackIdField=_5&&_5.trackIdField;this.objectIdField=_5&&_5.objectIdField;this._maxOffset=_5&&_5.maxAllowableOffset;this._optEditable=_5&&_5.editable;this._optAutoGen=_5&&_5.autoGeneralize;this.editSummaryCallback=_5&&_5.editSummaryCallback;this.userId=_5&&_5.userId;this.userIsAdmin=_5&&_5.userIsAdmin;this.useMapTime=(_5&&_5.hasOwnProperty("useMapTime"))?(!!_5.useMapTime):true;this.source=_5&&_5.source;this.gdbVersion=_5&&_5.gdbVersion;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var _7=this.constructor,_8=this.mode=(esri._isDefined(_5&&_5.mode)?_5.mode:_7.MODE_ONDEMAND);switch(_8){case _7.MODE_SNAPSHOT:this._mode=new esri.layers._SnapshotMode(this);this._isSnapshot=true;break;case _7.MODE_ONDEMAND:this._tileWidth=(_5&&_5.tileWidth)||512;this._tileHeight=(_5&&_5.tileHeight)||512;this._mode=new esri.layers._OnDemandMode(this);var _9=_5&&_5.latticeTiling;this.latticeTiling=_9;break;case _7.MODE_SELECTION:this._mode=new esri.layers._SelectionMode(this);this._isSelOnly=true;break;}this._initLayer=_2.hitch(this,this._initLayer);this._selectHandler=_2.hitch(this,this._selectHandler);this._editable=false;if(_2.isObject(_4)&&_4.layerDefinition){var _a=_4;this._collection=true;this.mode=_7.MODE_SNAPSHOT;this._initLayer(_a);return this;}this._task=new esri.tasks.QueryTask(this.url,{source:this.source,gdbVersion:this.gdbVersion});var _b=this._url.path;this._fserver=false;if(_b.search(/\/FeatureServer\//i)!==-1){this._fserver=true;}var _c=_5&&_5.resourceInfo;if(_c){this._initLayer(_c);}else{if(this.source){var _d={source:this.source.toJson()};this._url.query=_2.mixin(this._url.query,{layer:_2.toJson(_d)});}if(this.gdbVersion){this._url.query=_2.mixin(this._url.query,{gdbVersion:this.gdbVersion});}esri.request({url:_b,content:_2.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});}},_initLayer:function(_e,io){if(_e||io){this._json=_e;this._findCredential();var _f=(this.credential&&this.credential.ssl)||(_e&&_e._ssl);if(_f){this._useSSL();this._task._useSSL();}if(this._collection){this._mode=new esri.layers._SnapshotMode(this);this._isSnapshot=true;this._featureSet=_e.featureSet;this._nextId=_e.nextObjectId;_e=_e.layerDefinition;}if(_e.hasOwnProperty("capabilities")){var _10=(this.capabilities=_e.capabilities);if(_10&&_10.toLowerCase().indexOf("editing")!==-1){this._editable=true;}else{this._editable=false;}}else{if(!this._collection){this._editable=this._fserver;}}if(esri._isDefined(this._optEditable)){this._editable=this._optEditable;delete this._optEditable;}this._json=_2.toJson(this._json);if(this.isEditable()){delete this._maxOffset;}else{if(this.mode!==this.constructor.MODE_SNAPSHOT&&((_e.geometryType==="esriGeometryPolyline")||(_e.geometryType==="esriGeometryPolygon"))){this._autoGeneralize=esri._isDefined(this._optAutoGen)?this._optAutoGen:(this.mode===this.constructor.MODE_ONDEMAND);delete this._optAutoGen;}}var _11=_e.effectiveMinScale||_e.minScale,_12=_e.effectiveMaxScale||_e.maxScale;if(!this._hasMin&&_11){this.setMinScale(_11);}if(!this._hasMax&&_12){this.setMaxScale(_12);}this.layerId=_e.id;this.name=_e.name;this.description=_e.description;this.copyright=_e.copyrightText;this.type=_e.type;this.geometryType=_e.geometryType;this.displayField=_e.displayField;this.defaultDefinitionExpression=_e.definitionExpression;this.fullExtent=new esri.geometry.Extent(_e.extent);this.defaultVisibility=_e.defaultVisibility;if((this.geometryType==="esriGeometryPoint")||(this.geometryType==="esriGeometryMultipoint")){this.latticeTiling=false;}this.indexedFields=_e.indexedFields;this.maxRecordCount=_e.maxRecordCount;this.canModifyLayer=_e.canModifyLayer;this.supportsStatistics=_e.supportsStatistics;this.supportsAdvancedQueries=_e.supportsAdvancedQueries;this.hasLabels=_e.hasLabels;this.canScaleSymbols=_e.canScaleSymbols;this.supportsRollbackOnFailure=_e.supportsRollbackOnFailure;this.syncCanReturnChanges=_e.syncCanReturnChanges;this.isDataVersioned=_e.isDataVersioned;this.editFieldsInfo=_e.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=_e.ownershipBasedAccessControlForFeatures;if(this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures){this.creatorField=this.editFieldsInfo.creatorField;}this.relationships=_e.relationships;this.allowGeometryUpdates=esri._isDefined(_e.allowGeometryUpdates)?_e.allowGeometryUpdates:true;this._isTable=(this.type==="Table");var _13=(this.fields=[]),_14=_e.fields,i;for(i=0;i<_14.length;i++){_13.push(new esri.layers.Field(_14[i]));}if(!this.objectIdField){this.objectIdField=_e.objectIdField;if(!this.objectIdField){_14=_e.fields;for(i=0;i<_14.length;i++){var _15=_14[i];if(_15.type==="esriFieldTypeOID"){this.objectIdField=_15.name;break;}}}if(!this.objectIdField){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url},esri.bundle.layers.FeatureLayer.noOIDField));}}if(!esri._isDefined(this._nextId)){var _16=this.objectIdField,_17=-1;if(this._collection&&_16){var _18=this._featureSet,_19=_18&&_18.features,il=_19?_19.length:0,oid,_1a;for(i=0;i<il;i++){_1a=_19[i].attributes;oid=_1a&&_1a[_16];if(oid>_17){_17=oid;}}}this._nextId=(_17+1);}this.globalIdField=_e.globalIdField;var _1b=(this.typeIdField=_e.typeIdField),_1c;if(_1b){_1c=!this._getField(_1b)&&this._getField(_1b,true);if(_1c){this.typeIdField=_1c.name;}}this.visibilityField=_e.visibilityField;var _1d=_e.defaultSymbol;if(_1d){this.defaultSymbol=esri.symbol.fromJson(_1d);}var _1e=this.types=[],_1f=_e.types,_20,_21,_22,_23=this.editFieldsInfo,_24=_23&&_23.creatorField,_25=_23&&_23.editorField,fix=(_24||_25),_26=[];if(_1f){for(i=0;i<_1f.length;i++){_20=new esri.layers.FeatureType(_1f[i]);_21=_20.templates;if(fix&&_21&&_21.length){_26=_26.concat(_21);}_1e.push(_20);}}var _27=_e.templates,_28,_29=this.templates=[];if(_27){for(i=0;i<_27.length;i++){_28=new esri.layers.FeatureTemplate(_27[i]);if(fix){_26.push(_28);}_29.push(_28);}}for(i=0;i<_26.length;i++){_22=_2.getObject("prototype.attributes",false,_26[i]);if(_22){if(_24){delete _22[_24];}if(_25){delete _22[_25];}}}var _2a=_e.timeInfo;if(_2a){this.timeInfo=new esri.layers.TimeInfo(_2a);this._startTimeField=_2a.startTimeField;this._endTimeField=_2a.endTimeField;if(this._startTimeField&&this._endTimeField){this._twoTimeFields=true;}if(this._trackIdField){_2a.trackIdField=this._trackIdField;}else{this._trackIdField=_2a.trackIdField;}}this.hasAttachments=(!this._collection&&_e.hasAttachments)?true:false;this.htmlPopupType=_e.htmlPopupType;var _2b=_e.drawingInfo,_2c;if(!this.renderer){if(_2b&&_2b.renderer){_2c=_2b.renderer;this.setRenderer(esri.renderer.fromJson(_2c));if(_2c.type==="classBreaks"){this.renderer._setMaxInclusiveness(true);}if(!this._collection){var _2d=_2c.type,_2e=[];_2c=this.renderer;switch(_2d){case "simple":_2e.push(_2c.symbol);break;case "uniqueValue":case "classBreaks":_2e.push(_2c.defaultSymbol);_2e=_2e.concat(_2.map(_2c.infos,function(_2f){return _2f.symbol;}));break;}_2e=_2.filter(_2e,esri._isDefined);var _30=this._url.path+"/images/",_31=this._getToken();_2.forEach(_2e,function(sym){var url=sym.url;if(url){if((url.search(/https?\:/)===-1)&&(url.indexOf("data:")===-1)){sym.url=_30+url;}if(_31&&sym.url.search(/https?\:/)!==-1){sym.url+=("?token="+_31);}}});}}else{if(_1d){_1f=this.types;if(_1f.length>0){_2c=new esri.renderer.UniqueValueRenderer(this.defaultSymbol,this.typeIdField);_2.forEach(_1f,function(_32){_2c.addValue(_32.id,_32.symbol);});}else{_2c=new esri.renderer.SimpleRenderer(this.defaultSymbol);}this.setRenderer(_2c);}else{if(!this._isTable){var _33;switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":_33=new esri.symbol.SimpleMarkerSymbol();break;case "esriGeometryPolyline":_33=new esri.symbol.SimpleLineSymbol();break;case "esriGeometryPolygon":_33=new esri.symbol.SimpleFillSymbol();break;}this.setRenderer(_33?new esri.renderer.SimpleRenderer(_33):null);}}}}var _34=(_2b&&_2b.transparency)||0;if(!esri._isDefined(this.opacity)&&_34>0){this.opacity=1-(_34/100);}this.version=_e.currentVersion;if(!this.version){var ver;if("capabilities" in _e||"drawingInfo" in _e||"hasAttachments" in _e||"htmlPopupType" in _e||"relationships" in _e||"timeInfo" in _e||"typeIdField" in _e||"types" in _e){ver=10;}else{ver=9.3;}this.version=ver;}if((_2.isIE||_2.isSafari)&&this.isEditable()&&this.version<10.02){this._ts=true;}this.loaded=true;this._fixRendererFields();this._checkFields();this._updateCaps();if(this._collection){this._fireUpdateStart();var _35=this._featureSet;delete this._featureSet;this._mode._drawFeatures(new esri.tasks.FeatureSet(_35));this._fcAdded=true;}this.onLoad(this);var _36=this._loadCallback;if(_36){delete this._loadCallback;_36(this);}}},setRenderer:function(ren){this.inherited("setRenderer",arguments);var _37=this.renderer;if(_37){this._ager=(_37.declaredClass.indexOf("TemporalRenderer")!==-1&&_37.observationAger&&_37.observationRenderer);var _38=_2.filter([_37,_37.observationRenderer,_37.latestObservationRenderer,_37.trackRenderer],esri._isDefined);var _39=[];_2.forEach(_38,function(rnd){_39.push(rnd.attributeField);_39.push(rnd.attributeField2);_39.push(rnd.attributeField3);},this);this._rendererFields=_2.filter(_39,esri._isDefined);}else{this._ager=false;this._rendererFields=[];}if(this.loaded&&this._rendererFields.length>0){this._fixRendererFields();this._checkFields(this._rendererFields);}if(this.loaded&&this._collection){this._typesDirty=true;}},_setMap:function(map,_3a){this._map=map;this._toggleTime(true);var div=this.inherited("_setMap",arguments);this.clearSelection();var _3b=this.renderer;if(this.timeInfo){if(this._trackIdField||(_3b&&(_3b.latestObservationRenderer||_3b.trackRenderer))){this._trackManager=new esri.layers._TrackManager(this);this._trackManager.initialize(map);}}this._zoomConnect=_2.connect(map,"onZoomEnd",this,this._updateMaxOffset);this._updateMaxOffset();var _3c=this._mode;if(_3c){_3c.initialize(map);}return div;},_unsetMap:function(map,_3d){var _3e=this._mode;if(_3e){_3e.destroy();this._mode=null;}if(this._trackManager){this._trackManager.destroy();this._trackManager=null;}_2.disconnect(this._zoomConnect);this._zoomConnect=null;this._toggleTime(false);this.inherited("_unsetMap",arguments);},refresh:function(){var _3f=this._mode;if(_3f){_3f.refresh();}},setEditable:function(_40){if(!this._collection){console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service");return this;}if(!this.loaded){this._optEditable=_40;return this;}var _41=this._editable;this._editable=_40;this._updateCaps();if(_41!==_40){this.onCapabilitiesChange();}return this;},getEditCapabilities:function(_42){var _43={"canCreate":false,"canUpdate":false,"canDelete":false};if(!this.loaded||!this.isEditable()){return _43;}var _44=_42&&_42.feature,_45=_42&&_42.userId,_46=_2.map((this.capabilities?this.capabilities.toLowerCase().split(","):[]),_2.trim),_47=_2.indexOf(_46,"editing")>-1,_48=_47&&(_2.indexOf(_46,"create")>-1),_49=_47&&(_2.indexOf(_46,"update")>-1),_4a=_47&&(_2.indexOf(_46,"delete")>-1),_4b=this.ownershipBasedAccessControlForFeatures,_4c=this.editFieldsInfo,_4d=_4c&&_4c.creatorField,_4e=_4c&&_4c.realm,_4f=_44&&_44.attributes,_50=(_4f&&_4d)?_4f[_4d]:undefined,_51,_52=!!this.userIsAdmin,_53=!_4b||_52||!!(_4b.allowOthersToUpdate||_4b.allowUpdateToOthers),_54=!_4b||_52||!!(_4b.allowOthersToDelete||_4b.allowDeleteToOthers);if(_52||(_47&&!(_48||_49||_4a))){_48=_49=_4a=true;}_51={"canCreate":_48,"canUpdate":_49,"canDelete":_4a};if(_50===null){_51.canUpdate=_49&&_53;_51.canDelete=_4a&&_54;}else{if(_50===""){return _51;}else{if(_50){_45=_45||this.getUserId();if(_45&&_4e){_45=_45+"@"+_4e;}if(_45.toLowerCase()===_50.toLowerCase()){return _51;}else{_51.canUpdate=_49&&_53;_51.canDelete=_4a&&_54;}}}}return _51;},getUserId:function(){var _55;if(this.loaded){_55=(this.credential&&this.credential.userId)||this.userId||"";}return _55;},setUserIsAdmin:function(_56){this.userIsAdmin=_56;},setEditSummaryCallback:function(_57){this.editSummaryCallback=_57;},getEditSummary:function(_58,_59,_5a){_5a=esri._isDefined(_5a)?_5a:(new Date()).getTime();var _5b="",_5c=this.getEditInfo(_58,_59,_5a),_5d=(_59&&_59.callback)||this.editSummaryCallback;if(_5d){_5c=_5d(_58,_5c)||"";}if(_2.isString(_5c)){_5b=_5c;}else{if(_5c){var _5e=_5c.action,_5f=_5c.userId,_60=_5c.timeValue,_61=0;if(_5e){_61++;}if(_5f){_61++;}if(esri._isDefined(_60)){_61++;}if(_61>1){_5b=(_5e==="edit"?"edit":"create")+(_5f?"User":"")+(esri._isDefined(_60)?_5c.displayPattern:"");}}_5b=_5b&&esri.substitute(_5c,esri.bundle.layers.FeatureLayer[_5b]);}return _5b;},getEditInfo:function(_62,_63,_64){if(!this.loaded){return;}_64=esri._isDefined(_64)?_64:(new Date()).getTime();var _65=(_63&&_63.action)||"last",_66=this.editFieldsInfo,_67=_66&&_66.creatorField,_68=_66&&_66.creationDateField,_69=_66&&_66.editorField,_6a=_66&&_66.editDateField,_6b=_66&&_66.realm,_6c=_62&&_62.attributes,_6d=(_6c&&_67)?_6c[_67]:undefined,_6e=(_6c&&_68)?_6c[_68]:null,_6f=(_6c&&_69)?_6c[_69]:undefined,_70=(_6c&&_6a)?_6c[_6a]:null,_71=this._getEditData(_6d,_6e,_64),_72=this._getEditData(_6f,_70,_64),_73;switch(_65){case "creation":_73=_71;break;case "edit":_73=_72;break;case "last":_73=_72||_71;break;}if(_73){_73.action=(_73===_72)?"edit":"creation";}return _73;},_getEditData:function(_74,_75,_76){var _77,_78,_79,_7a=60000,_7b=3600000,_7c=2*_7b,_7d=24*_7b,_7e=7*_7d;if(esri._isDefined(_75)){_78=_76-_75;if(_78<0){_79="Full";}else{if(_78<_7a){_79="Seconds";}else{if(_78<(2*_7a)){_79="Minute";}else{if(_78<_7b){_79="Minutes";}else{if(_78<_7c){_79="Hour";}else{if(_78<_7d){_79="Hours";}else{if(_78<_7e){_79="WeekDay";}else{_79="Full";}}}}}}}}if((_74!==undefined)||_79){_77=_77||{};_77.userId=_74;if(_79){var _7f=_2.date.locale.format,_80=new Date(_75);_77.minutes=Math.floor(_78/_7a);_77.hours=Math.floor(_78/_7b);_77.weekDay=_7f(_80,{datePattern:"EEEE",selector:"date"});_77.formattedDate=_7f(_80,{selector:"date"});_77.formattedTime=_7f(_80,{selector:"time"});_77.displayPattern=_79;_77.timeValue=_75;}}return _77;},isEditable:function(){return !!(this._editable||this.userIsAdmin);},setMaxAllowableOffset:function(_81){if(!this.isEditable()){this._maxOffset=_81;}return this;},getMaxAllowableOffset:function(){return this._maxOffset;},setAutoGeneralize:function(_82){if(!this.loaded){this._optAutoGen=_82;}else{if(!this.isEditable()&&(this.mode!==this.constructor.MODE_SNAPSHOT)&&((this.geometryType==="esriGeometryPolyline")||(this.geometryType==="esriGeometryPolygon"))){this._autoGeneralize=_82;if(_82){var map=this._map;if(map&&map.loaded){this._maxOffset=Math.floor(map.extent.getWidth()/map.width);}}else{delete this._maxOffset;}}}return this;},setGDBVersion:function(_83){if(!this._collection&&(_83!==this.gdbVersion)&&(_83||this.gdbVersion)){this.gdbVersion=_83;this._task.gdbVersion=_83;this._url.query=_2.mixin(this._url.query,{gdbVersion:_83});if(this.loaded){this.clearSelection();if(this._map){this.refresh();}}this.onGDBVersionChange();}return this;},setDefinitionExpression:function(_84){this._defnExpr=_84;var _85=this._mode;if(_85){_85.propertyChangeHandler(1);}return this;},getDefinitionExpression:function(){return this._defnExpr;},setTimeDefinition:function(_86){if(this._isSnapshot){this._timeDefn=_86;var _87=this._mode;if(_87){_87.propertyChangeHandler(2);}}return this;},getTimeDefinition:function(){return this._timeDefn;},setTimeOffset:function(_88,_89){this._timeOffset=_88;this._timeOffsetUnits=_89;var _8a=this._mode;if(_8a){_8a.propertyChangeHandler(0);}return this;},setUseMapTime:function(use){this.useMapTime=use;this._toggleTime(!this.suspended);var _8b=this._mode;if(_8b){_8b.propertyChangeHandler(0);}},selectFeatures:function(_8c,_8d,_8e,_8f){_8d=_8d||this.constructor.SELECTION_NEW;var _90=this._getShallowClone(_8c),map=this._map,_91,dfd=esri._fixDfd(new _2.Deferred(esri._dfdCanceller));_90.outFields=this._getOutFields();_90.returnGeometry=true;if(map){_90.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());}if(!this._applyQueryFilters(_90)){_91={features:[]};this._selectHandler(_91,_8d,_8e,_8f,dfd);return dfd;}var _92=this._canDoClientSideQuery(_90);if(_92){_91={features:this._doQuery(_90,_92)};this._selectHandler(_91,_8d,_8e,_8f,dfd);return dfd;}else{if(this._collection){var err=new Error("FeatureLayer::selectFeatures - "+esri.bundle.layers.FeatureLayer.invalidParams);this._resolve([err],null,_8f,dfd,true);return dfd;}var _93=this;if(this._ts){_90._ts=(new Date()).getTime();}var _94=dfd._pendingDfd=this._task.execute(_90);_94.addCallbacks(function(_95){_93._selectHandler(_95,_8d,_8e,_8f,dfd);},function(err){_93._resolve([err],null,_8f,dfd,true);});return dfd;}},getSelectedFeatures:function(){var _96=this._selectedFeatures,_97=[],_98;for(_98 in _96){if(_96.hasOwnProperty(_98)){_97.push(_96[_98]);}}return _97;},clearSelection:function(_99){var _9a=this._selectedFeatures,_9b=this._mode,_9c;for(_9c in _9a){if(_9a.hasOwnProperty(_9c)){this._unSelectFeatureIIf(_9c,_9b);_9b._removeFeatureIIf(_9c);}}this._selectedFeatures={};if(this._isSelOnly){_9b._applyTimeFilter(true);}if(!_99){this.onSelectionClear();}return this;},setSelectionSymbol:function(_9d){this._selectionSymbol=_9d;if(_9d){var _9e=this._selectedFeatures,_9f;for(_9f in _9e){if(_9e.hasOwnProperty(_9f)){_9e[_9f].setSymbol(_9d);}}}return this;},getSelectionSymbol:function(){return this._selectionSymbol;},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(_a0,_a1,_a2,_a3,_a4,_a5){var _a6=_a5.assembly,dfd=_a5.dfd;this._applyNormalized(_a0,_a6&&_a6[0]);this._applyNormalized(_a1,_a6&&_a6[1]);this.onBeforeApplyEdits(_a0,_a1,_a2);var i,_a7={},_a8=this.objectIdField,_a9={f:"json"},_aa=false;if(this._collection){var _ab={};_ab.addResults=_a0?_2.map(_a0,function(){_aa=true;return {objectId:this._nextId++,success:true};},this):null;_ab.updateResults=_a1?_2.map(_a1,function(_ac){_aa=true;var oid=_ac.attributes[_a8];_a7[oid]=_ac;return {objectId:oid,success:true};},this):null;_ab.deleteResults=_a2?_2.map(_a2,function(_ad){_aa=true;return {objectId:_ad.attributes[_a8],success:true};},this):null;if(_aa){this._editHandler(_ab,_a0,_a7,_a3,_a4,dfd);}return;}if(_a0&&_a0.length>0){_a9.adds=this._convertFeaturesToJson(_a0,0,1);_aa=true;}if(_a1&&_a1.length>0){for(i=0;i<_a1.length;i++){var _ae=_a1[i];_a7[_ae.attributes[_a8]]=_ae;}_a9.updates=this._convertFeaturesToJson(_a1,0,0,1);_aa=true;}if(_a2&&_a2.length>0){var ids=[];for(i=0;i<_a2.length;i++){ids.push(_a2[i].attributes[_a8]);}_a9.deletes=ids.join(",");_aa=true;}if(_aa){var _af=this;return esri.request({url:this._url.path+"/applyEdits",content:_2.mixin(_a9,this._url.query),callbackParamName:"callback",load:function(_b0){_af._editHandler(_b0,_a0,_a7,_a3,_a4,dfd);},error:function(err){_af._resolve([err],null,_a4,dfd,true);}},{usePost:true});}},queryFeatures:function(_b1,_b2,_b3){return this._query("execute","onQueryFeaturesComplete",_b1,_b2,_b3);},queryRelatedFeatures:function(_b4,_b5,_b6){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",_b4,_b5,_b6);},queryIds:function(_b7,_b8,_b9){return this._query("executeForIds","onQueryIdsComplete",_b7,_b8,_b9);},queryCount:function(_ba,_bb,_bc){return this._query("executeForCount","onQueryCountComplete",_ba,_bb,_bc);},queryAttachmentInfos:function(_bd,_be,_bf){var url=this._url.path+"/"+_bd+"/attachments",dfd=new _2.Deferred(esri._dfdCanceller),_c0=this;dfd._pendingDfd=esri.request({url:url,content:_2.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(_c1){var _c2=_c1.attachmentInfos,_c3;_2.forEach(_c2,function(_c4){_c3=_2.objectToQuery({gdbVersion:_c0._url.query&&_c0._url.query.gdbVersion,layer:_c0._url.query&&_c0._url.query.layer,token:_c0._getToken()});_c4.url=url+"/"+_c4.id+(_c3?("?"+_c3):"");_c4.objectId=_bd;});_c0._resolve([_c2],"onQueryAttachmentInfosComplete",_be,dfd);},error:function(err){_c0._resolve([err],null,_bf,dfd,true);}});return dfd;},addAttachment:function(_c5,_c6,_c7,_c8){return this._sendAttachment("add",_c5,_c6,_c7,_c8);},updateAttachment:function(_c9,_ca,_cb,_cc,_cd){_cb.appendChild(_2.create("input",{type:"hidden",name:"attachmentId",value:_ca}));return this._sendAttachment("update",_c9,_cb,_cc,_cd);},deleteAttachments:function(_ce,_cf,_d0,_d1){var url=this._url.path+"/"+_ce+"/deleteAttachments",dfd=new _2.Deferred(esri._dfdCanceller),_d2=this,_d3={f:"json",attachmentIds:_cf.join(",")};dfd._pendingDfd=esri.request({url:url,content:_2.mixin(_d3,this._url.query),callbackParamName:"callback",load:_2.hitch(this,function(_d4){var _d5=_d4.deleteAttachmentResults;_d5=_2.map(_d5,function(_d6){var res=new esri.layers.FeatureEditResult(_d6);res.attachmentId=res.objectId;res.objectId=_ce;return res;});_d2._resolve([_d5],"onDeleteAttachmentsComplete",_d0,dfd);}),error:function(err){_d2._resolve([err],null,_d1,dfd,true);}},{usePost:true});return dfd;},addType:function(_d7){var _d8=this.types;if(_d8){var _d9=_2.some(_d8,function(_da){if(_da.id==_d7.id){return true;}return false;});if(_d9){return false;}else{_d8.push(_d7);}}else{this.types=[_d7];}this._typesDirty=true;return true;},deleteType:function(_db){if(!this._collection){return;}var _dc=this.types;if(_dc){var _dd=-1;_2.some(_dc,function(_de,_df){if(_de.id==_db){_dd=_df;return true;}return false;});if(_dd>-1){this._typesDirty=true;return _dc.splice(_dd,1)[0];}}},toJson:function(){var _e0=this._json,_e1=_2.isString(_e0)?_2.fromJson(_e0):_2.clone(_e0);if(!_e1){return;}_e1=_e1.layerDefinition?_e1:{layerDefinition:_e1};var _e2=_e1.layerDefinition,_e3=this._collection;if(_e3&&this._typesDirty){_e2.types=_2.map(this.types||[],function(_e4){return _e4.toJson();});var _e5=this.renderer,_e6=_e2.drawingInfo;if(_e6&&_e5&&_e5.declaredClass.indexOf("TemporalRenderer")===-1){_e6.renderer=_e5.toJson();}}var _e7=null;if(!(_e3&&!this._fcAdded)){_e7={geometryType:_e2.geometryType,features:this._convertFeaturesToJson(this.graphics,true)};}_e1.featureSet=_2.mixin({},_e1.featureSet||{},_e7);if(_e3){_e1.nextObjectId=this._nextId;_e2.capabilities=this.capabilities;}return _e1;},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},_updateCaps:function(){var _e8=this._editable,_e9=_2.trim(this.capabilities||""),_ea=_2.map((_e9?_e9.split(","):[]),_2.trim),_eb=_2.map((_e9?_e9.toLowerCase().split(","):[]),_2.trim),_ec=_2.indexOf(_eb,"editing"),cap,i,_ed,_ee={"Create":_2.indexOf(_eb,"create"),"Update":_2.indexOf(_eb,"update"),"Delete":_2.indexOf(_eb,"delete")};if(_e8&&_ec===-1){_ea.push("Editing");}else{if(!_e8&&_ec>-1){_ed=[_ec];for(cap in _ee){if(_ee[cap]>-1){_ed.push(_ee[cap]);}}_ed.sort();for(i=_ed.length-1;i>=0;i--){_ea.splice(_ed[i],1);}}}this.capabilities=_ea.join(",");},_counter:{value:0},_getUniqueId:function(){return this._counter.value++;},onSuspend:function(){this.inherited(arguments);this._toggleTime(false);var _ef=this._mode;if(_ef){_ef.suspend();}},onResume:function(){this.inherited(arguments);this._toggleTime(true);this._updateMaxOffset();var _f0=this._mode;if(_f0){_f0.resume();}},_updateMaxOffset:function(){var map=this._map;if(map&&map.loaded){if(this._autoGeneralize){this._maxOffset=Math.floor(map.extent.getWidth()/map.width);}}},_toggleTime:function(_f1){var map=this._map;if(_f1&&this.timeInfo&&this.useMapTime&&map){this._mapTimeExtent=map.timeExtent;if(!this._timeConnect){this._timeConnect=_2.connect(map,"onTimeExtentChange",this,this._timeChangeHandler);}}else{this._mapTimeExtent=null;_2.disconnect(this._timeConnect);this._timeConnect=null;}},_timeChangeHandler:function(_f2){this._mapTimeExtent=_f2;var _f3=this._mode;if(_f3){_f3.propertyChangeHandler(0);}},_getOffsettedTE:function(_f4){var _f5=this._timeOffset,_f6=this._timeOffsetUnits;return (_f4&&_f5&&_f6)?_f4.offset(-1*_f5,_f6):_f4;},_getTimeOverlap:function(_f7,_f8){if(_f7&&_f8){return _f7.intersection(_f8);}else{return _f7||_f8;}},_getTimeFilter:function(_f9){var _fa=this.getTimeDefinition(),_fb=null,_fc;if(_fa||_fb){_fc=this._getTimeOverlap(_fa,_fb);if(!_fc){return [false];}}if(_f9){_f9=_fc?this._getTimeOverlap(_f9,_fc):_f9;if(!_f9){return [false];}}else{_f9=_fc;}return [true,_f9];},_getAttributeFilter:function(_fd){var _fe=this.getDefinitionExpression();if(_fd){_fd=_fe?"("+_fe+") AND ("+_fd+")":_fd;}else{_fd=_fe;}return _fd;},_applyQueryFilters:function(_ff){_ff.where=this._getAttributeFilter(_ff.where);_ff.maxAllowableOffset=this._maxOffset;if(this.timeInfo){var _100=this._getTimeFilter(_ff.timeExtent);if(!_100[0]){return false;}else{_ff.timeExtent=_100[1];}}return true;},_add:function(_101){var _102=this._selectionSymbol,attr=_101.attributes,_103=this.visibilityField;if(_102&&this._isSelOnly){_101.setSymbol(_102);}if(_103&&attr&&attr.hasOwnProperty(_103)){_101[attr[_103]?"show":"hide"]();}return this.add.apply(this,arguments);},_remove:function(){return this.remove.apply(this,arguments);},_canDoClientSideQuery:function(_104){var _105=[],map=this._map;if(this._isTable||!map){return;}if(_104.text||(_104.where&&_104.where!==this.getDefinitionExpression())){return;}var _106=this._isSnapshot,_107=this._isSelOnly;var _108=_104.geometry;if(_108){if(!_107&&_104.spatialRelationship===esri.tasks.Query.SPATIAL_REL_INTERSECTS&&(_108.type==="extent"&&(_106||map.extent.contains(_108)))){_105.push(1);}else{return;}}var ids=_104.objectIds;if(ids){if(_106){_105.push(2);}else{var len=ids.length,mode=this._mode,_109=0,i;for(i=0;i<len;i++){if(mode._getFeature(ids[i])){_109++;}}if(_109===len){_105.push(2);}else{return;}}}if(this.timeInfo){var _10a=_104.timeExtent,_10b=this._mapTimeExtent;if(_106){if(_10a){_105.push(3);}}else{if(_107){if(_10a){return;}}else{if(_10b){if(_2.indexOf(_105,2)!==-1){if(_10a){_105.push(3);}}else{return;}}else{if(_105.length>0){if(_10a){_105.push(3);}}else{if(_10a){return;}}}}}}return _105.length>0?_105:null;},_doQuery:function(_10c,_10d,_10e){var _10f=[],mode=this._mode,_110=this.objectIdField,i,len,_111;if(_2.indexOf(_10d,2)!==-1){_10f=[];var ids=_10c.objectIds;len=ids.length;for(i=0;i<len;i++){var obj=mode._getFeature(ids[i]);if(obj){_10f.push(obj);}}if(_10f.length===0){return [];}}if(_2.indexOf(_10d,1)!==-1){_111=_10f.length>0?_10f:this.graphics;len=_111.length;var _112=_10c.geometry._normalize(null,true);_10f=[];for(i=0;i<len;i++){var _113=_111[i],_114=_113.geometry;if(_114){if(this.normalization&&_112.length){if(_112[0].intersects(_114)||_112[1].intersects(_114)){_10f.push(_113);}}else{if(_112.intersects(_114)){_10f.push(_113);}}}}if(_10f.length===0){return [];}}if(_2.indexOf(_10d,3)!==-1){if(this.timeInfo){_111=_10f.length>0?_10f:this.graphics;var time=_10c.timeExtent,_115=this._filterByTime(_111,time.startTime,time.endTime);_10f=_115.match;}}if(_10e){return _2.map(_10f,function(obj){return obj.attributes[_110];},this);}else{return _10f;}},_filterByTime:function(_116,_117,_118){var _119=this._startTimeField,_11a=this._endTimeField,_11b;if(!this._twoTimeFields){_11b=_119||_11a;}var _11c=esri._isDefined,yea=[],nay=[],i,len=_116.length,_11d,_11e;_117=_117?_117.getTime():-Infinity;_118=_118?_118.getTime():Infinity;if(_11b){for(i=0;i<len;i++){_11d=_116[i];_11e=_11d.attributes;var time=_11e[_11b];if(time>=_117&&time<=_118){yea.push(_11d);}else{nay.push(_11d);}}}else{for(i=0;i<len;i++){_11d=_116[i];_11e=_11d.attributes;var _11f=_11e[_119],end=_11e[_11a];_11f=_11c(_11f)?_11f:-Infinity;end=_11c(end)?end:Infinity;if((_11f>=_117&&_11f<=_118)||(end>=_117&&end<=_118)||(_117>=_11f&&_118<=end)){yea.push(_11d);}else{nay.push(_11d);}}}return {match:yea,noMatch:nay};},_resolve:function(args,_120,_121,dfd,_122){if(_120){this[_120].apply(this,args);}if(_121){_121.apply(null,args);}if(dfd){esri._resDfd(dfd,args,_122);}},_getShallowClone:function(_123){var _124=new esri.tasks.Query(),prop;for(prop in _123){if(_123.hasOwnProperty(prop)){_124[prop]=_123[prop];}}return _124;},_query:function(type,_125,_126,_127,_128){var that=this,dfd=new _2.Deferred(esri._dfdCanceller);var _129=function(_12a,_12b){if(!_12b&&type==="execute"&&!that._isTable){var _12c=_12a.features,mode=that._mode,_12d=that.objectIdField,il=_12c.length,i;for(i=il-1;i>=0;i--){var oid=_12c[i].attributes[_12d];var _12e=mode._getFeature(oid);if(_12e){_12c.splice(i,1,_12e);}}}that._resolve([_12a],_125,_127,dfd);};if(type!=="executeRelationshipQuery"){_126=this._getShallowClone(_126);_126.outFields=this._getOutFields();_126.returnGeometry=true;var map=this._map,_12f;if(map){_126.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());}if(!this._applyQueryFilters(_126)){switch(type){case "execute":_12f=new esri.tasks.FeatureSet({features:[]});break;case "executeForIds":_12f=[];break;case "executeForCount":_12f=0;break;}_129(_12f,true);return dfd;}var _130=this._canDoClientSideQuery(_126);if(_130){var _131=this._doQuery(_126,_130,(type==="executeForIds"||type==="executeForCount"));switch(type){case "execute":_12f=new esri.tasks.FeatureSet();_12f.features=_131;break;case "executeForIds":_12f=_131;break;case "executeForCount":_12f=_131.length;break;}_129(_12f,true);return dfd;}}if(this._collection){var err=new Error("FeatureLayer::_query - "+esri.bundle.layers.FeatureLayer.invalidParams);this._resolve([err],null,_128,dfd,true);return dfd;}if(this._ts){_126._ts=(new Date()).getTime();}var temp=dfd._pendingDfd=this._task[type](_126);temp.addCallbacks(_129,function(err){that._resolve([err],null,_128,dfd,true);});return dfd;},_convertFeaturesToJson:function(_132,_133,_134,_135){var json=[],_136=this._selectionSymbol,_137=this.visibilityField,i,_138,_139=this.objectIdField;if(this.loaded&&(_134||_135)){_138=_2.filter(this.fields,function(_13a){return (_13a.editable===false)&&(!_135||(_13a.name!==_139));});}for(i=0;i<_132.length;i++){var _13b=_132[i],_13c={},_13d=_13b.geometry,attr=_13b.attributes,_13e=_13b.symbol;if(_13d&&(!_135||!this.loaded||this.allowGeometryUpdates)){_13c.geometry=_13d.toJson();}if(_137){_13c.attributes=attr=_2.mixin({},attr);attr[_137]=_13b.visible?1:0;}else{if(attr){_13c.attributes=_2.mixin({},attr);}}if(_13c.attributes&&_138&&_138.length){_2.forEach(_138,function(_13f){delete _13c.attributes[_13f.name];});}if(_13e&&(_13e!==_136)){_13c.symbol=_13e.toJson();}json.push(_13c);}return _133?json:_2.toJson(json);},_selectHandler:function(_140,_141,_142,_143,dfd){var _144,ctor=this.constructor;switch(_141){case ctor.SELECTION_NEW:this.clearSelection(true);_144=true;break;case ctor.SELECTION_ADD:_144=true;break;case ctor.SELECTION_SUBTRACT:_144=false;break;}var i,_145=_140.features,mode=this._mode,_146=[],_147=this.objectIdField,_148,oid;if(_144){for(i=0;i<_145.length;i++){_148=_145[i];oid=_148.attributes[_147];var _149=mode._addFeatureIIf(oid,_148);_146.push(_149);this._selectFeatureIIf(oid,_149,mode);}}else{for(i=0;i<_145.length;i++){_148=_145[i];oid=_148.attributes[_147];this._unSelectFeatureIIf(oid,mode);var _14a=mode._removeFeatureIIf(oid);_146.push(_14a||_148);}}if(this._isSelOnly){mode._applyTimeFilter(true);}this._resolve([_146,_141,_140.exceededTransferLimit?{queryLimitExceeded:true}:null],"onSelectionComplete",_142,dfd);if(_140.exceededTransferLimit){this.onQueryLimitExceeded();}},_selectFeatureIIf:function(oid,_14b,mode){var _14c=this._selectedFeatures,_14d=_14c[oid];if(!_14d){mode._incRefCount(oid);_14c[oid]=_14b;if(!this._isTable){this._setSelectSymbol(_14b);}}return _14d||_14b;},_unSelectFeatureIIf:function(oid,mode){var _14e=this._selectedFeatures[oid];if(_14e){mode._decRefCount(oid);delete this._selectedFeatures[oid];if(!this._isTable){this._setUnSelectSymbol(_14e);}}return _14e;},_isSelected:function(_14f){},_setSelectSymbol:function(_150){var _151=this._selectionSymbol;if(_151&&!this._isSelOnly){_150.setSymbol(_151);}},_setUnSelectSymbol:function(_152){var _153=this._selectionSymbol;if(_153&&!this._isSelOnly){if(_153===_152.symbol){_152.setSymbol(null,true);}}},_getOutFields:function(){var _154=_2.filter([this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields),function(_155,_156,arr){return !!_155&&(_2.indexOf(arr,_155)===_156);});var _157=_2.clone(this._outFields);if(_157){if(_2.indexOf(_157,"*")!==-1){return _157;}_2.forEach(_154,function(_158){if(_2.indexOf(_157,_158)===-1){_157.push(_158);}});return _157;}else{return _154;}},_checkFields:function(_159){var _15a=_159||this._getOutFields();_2.forEach(_15a,function(_15b){if(_15b==="*"){return;}if(!this._getField(_15b)){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url,field:_15b},esri.bundle.layers.FeatureLayer.fieldNotFound));}},this);if(!_159&&!this._isTable&&!this._fserver&&!this._collection){var _15c=_2.some(this.fields,function(_15d){return (_15d&&_15d.type==="esriFieldTypeGeometry")?true:false;});if(!_15c){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url},esri.bundle.layers.FeatureLayer.noGeometryField));}}},_fixRendererFields:function(){var _15e=this.renderer;if(_15e&&this.fields.length>0){var _15f=_2.filter([_15e,_15e.observationRenderer,_15e.latestObservationRenderer,_15e.trackRenderer],esri._isDefined);var _160=[];_2.forEach(_15f,function(rnd){var _161,_162;_162=rnd.attributeField;if(_162){_161=!this._getField(_162)&&this._getField(_162,true);if(_161){rnd.attributeField=_161.name;}}_162=rnd.attributeField2;if(_162){_161=!this._getField(_162)&&this._getField(_162,true);if(_161){rnd.attributeField2=_161.name;}}_162=rnd.attributeField3;if(_162){_161=!this._getField(_162)&&this._getField(_162,true);if(_161){rnd.attributeField3=_161.name;}}_160.push(rnd.attributeField);_160.push(rnd.attributeField2);_160.push(rnd.attributeField3);},this);this._rendererFields=_2.filter(_160,esri._isDefined);}},_getField:function(_163,_164){var _165=this.fields;if(_165.length===0){return null;}var _166;if(_164){_163=_163.toLowerCase();}_2.some(_165,function(_167){var _168=false;if(_164){_168=(_167&&_167.name.toLowerCase()===_163)?true:false;}else{_168=(_167&&_167.name===_163)?true:false;}if(_168){_166=_167;}return _168;});return _166;},_getDateOpts:function(){if(!this._dtOpts){var _169=_2.map(_2.filter(this.fields,function(_16a){return !!(_16a&&_16a.type==="esriFieldTypeDate");}),function(_16b){return _16b.name;});this._dtOpts={properties:_169};}return this._dtOpts;},_applyNormalized:function(_16c,_16d){if(_16c&&_16d){_2.forEach(_16c,function(_16e,_16f){if(_16e&&_16d[_16f]){_16e.setGeometry(_16d[_16f]);}});}},_editHandler:function(_170,adds,_171,_172,_173,dfd){var _174=_170.addResults,_175=_170.updateResults,_176=_170.deleteResults,i,_177,oid,_178,attr,_179=this.objectIdField,mode=this._mode,_17a=this._isTable;var _17b=this.editFieldsInfo,_17c=this._getOutFields()||[],_17d=_17b&&_17b.creatorField,_17e=_17b&&_17b.creationDateField,_17f=_17b&&_17b.editorField,_180=_17b&&_17b.editDateField,_181=_17b&&_17b.realm;if(_2.indexOf(_17c,"*")===-1){if(_17d&&_2.indexOf(_17c,_17d)===-1){_17d=null;}if(_17e&&_2.indexOf(_17c,_17e)===-1){_17e=null;}if(_17f&&_2.indexOf(_17c,_17f)===-1){_17f=null;}if(_180&&_2.indexOf(_17c,_180)===-1){_180=null;}}var _182=(_17e||_180)?(new Date()).getTime():null,_183=(_17d||_17f)?this.getUserId():undefined;if(_183&&_181){_183=_183+"@"+_181;}if(_174){for(i=0;i<_174.length;i++){_174[i]=new esri.layers.FeatureEditResult(_174[i]);if(_17a){continue;}_177=_174[i];if(_177.success){oid=_177.objectId;_178=adds[i];var gl=_178._graphicsLayer;if(gl&&gl!==this){gl.remove(_178);}attr=_178.attributes||{};attr[_179]=oid;if(_17d){attr[_17d]=_183;}if(_17f){attr[_17f]=_183;}if(_17e){attr[_17e]=_182;}if(_180){attr[_180]=_182;}_178.setAttributes(attr);if(mode._init){mode.drawFeature(_178);}}}}if(_175){for(i=0;i<_175.length;i++){_175[i]=new esri.layers.FeatureEditResult(_175[i]);if(_17a){continue;}_177=_175[i];if(_177.success){oid=_177.objectId;_178=_171[oid];var _184=mode._getFeature(oid);if(_184){if(_184.geometry!==_178.geometry){_184.setGeometry(esri.geometry.fromJson(_178.geometry.toJson()));}this._repaint(_184,oid);}_178=_184||_178;attr=_178.attributes||{};if(_17f){attr[_17f]=_183;}if(_180){attr[_180]=_182;}_178.setAttributes(attr);}}}if(_176){var _185=[];for(i=0;i<_176.length;i++){_176[i]=new esri.layers.FeatureEditResult(_176[i]);if(_17a){continue;}_177=_176[i];if(_177.success){oid=_177.objectId;_178=mode._getFeature(oid);if(_178){if(this._unSelectFeatureIIf(oid,mode)){_185.push(_178);}_178._count=0;mode._removeFeatureIIf(oid);}}}if(_185.length>0){this.onSelectionComplete(_185,this.constructor.SELECTION_SUBTRACT);}}this._resolve([_174,_175,_176],"onEditsComplete",_172,dfd);},_sendAttachment:function(type,_186,_187,_188,_189){var _18a=(type==="add")?"addAttachment":"updateAttachment",url=this._url.path+"/"+_186+"/"+_18a,self=this;var dfd=esri.request({url:url,form:_187,content:_2.mixin(this._url.query,{f:"json",token:this._getToken()||undefined}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(_18b){var _18c=(type==="add")?"addAttachmentResult":"updateAttachmentResult",_18d=(type==="add")?"onAddAttachmentComplete":"onUpdateAttachmentComplete",_18e=new esri.layers.FeatureEditResult(_18b[_18c]);_18e.attachmentId=_18e.objectId;_18e.objectId=_186;self._resolve([_18e],_18d,_188);return _18e;}).addErrback(function(_18f){self._resolve([_18f],null,_189,null,true);});return dfd;},_repaint:function(_190,oid,_191){oid=esri._isDefined(oid)?oid:_190.attributes[this.objectIdField];if(!(oid in this._selectedFeatures)||!this._selectionSymbol){_190.setSymbol(_190.symbol,_191);}},_getKind:function(_192){var _193=this._trackManager;if(_193){return _193.isLatestObservation(_192)?1:0;}return 0;}});_2.mixin(esri.layers.FeatureLayer,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});esri._createWrappers("esri.layers.FeatureLayer");_2.declare("esri.layers.FeatureType",null,{constructor:function(json){if(json&&_2.isObject(json)){this.id=json.id;this.name=json.name;var _194=json.symbol;if(_194){this.symbol=esri.symbol.fromJson(_194);}var _195=json.domains,_196,i;var _197=this.domains={};for(_196 in _195){if(_195.hasOwnProperty(_196)){var _198=_195[_196];switch(_198.type){case "range":_197[_196]=new esri.layers.RangeDomain(_198);break;case "codedValue":_197[_196]=new esri.layers.CodedValueDomain(_198);break;case "inherited":_197[_196]=new esri.layers.InheritedDomain(_198);break;}}}var _199=json.templates;if(_199){var _19a=this.templates=[];for(i=0;i<_199.length;i++){_19a.push(new esri.layers.FeatureTemplate(_199[i]));}}}},toJson:function(){var json={id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()};var _19b,_19c=this.domains,_19d=this.templates,_19e=esri._sanitize;if(_19c){var _19f=json.domains={};for(_19b in _19c){if(_19c.hasOwnProperty(_19b)){_19f[_19b]=_19c[_19b]&&_19c[_19b].toJson();}}_19e(_19f);}if(_19d){json.templates=_2.map(_19d,function(_1a0){return _1a0.toJson();});}return _19e(json);}});_2.declare("esri.layers.FeatureTemplate",null,{constructor:function(json){if(json&&_2.isObject(json)){this.name=json.name;this.description=json.description;this.drawingTool=json.drawingTool;var _1a1=json.prototype;this.prototype=new esri.Graphic(_1a1.geometry,null,_1a1.attributes);}},toJson:function(){return esri._sanitize({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()});}});_2.mixin(esri.layers.FeatureTemplate,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});_2.declare("esri.layers.FeatureEditResult",null,{constructor:function(json){if(json&&_2.isObject(json)){this.objectId=json.objectId;this.success=json.success;if(!json.success){var err=json.error;this.error=new Error();this.error.code=err.code;this.error.message=err.description;}}}});_2.declare("esri.layers._RenderMode",null,{constructor:function(){this._prefix="jsonp_"+(_2._scopeName||"dojo")+"IoScript";},initialize:function(map){},propertyChangeHandler:function(type){},destroy:function(){},drawFeature:function(_1a2){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(oid){var _1a3=this._featureMap[oid];if(_1a3){_1a3._count++;}},_decRefCount:function(oid){var _1a4=this._featureMap[oid];if(_1a4){_1a4._count--;}},_getFeature:function(oid){return this._featureMap[oid];},_addFeatureIIf:function(oid,_1a5){var fmap=this._featureMap,_1a6=fmap[oid],_1a7=this.featureLayer;if(!_1a6){fmap[oid]=_1a5;_1a7._add(_1a5);_1a5._count=0;}return _1a6||_1a5;},_removeFeatureIIf:function(oid){var _1a8=this._featureMap[oid],_1a9=this.featureLayer;if(_1a8){if(_1a8._count){return;}delete this._featureMap[oid];_1a9._remove(_1a8);}return _1a8;},_clearIIf:function(){var i,_1aa=this.featureLayer,_1ab=_1aa.graphics,_1ac=_1aa._selectedFeatures,_1ad=_1aa.objectIdField;for(i=_1ab.length-1;i>=0;i--){var _1ae=_1ab[i];var oid=_1ae.attributes[_1ad];if(oid in _1ac){_1ae._count=1;continue;}_1ae._count=0;this._removeFeatureIIf(oid);}},_isPending:function(id){var dfd=_2.io.script[this._prefix+id];return dfd?true:false;},_cancelPendingRequest:function(dfd,id){dfd=dfd||_2.io.script[this._prefix+id];if(dfd){try{dfd.cancel();_2.io.script._validCheck(dfd);}catch(e){}}},_purgeRequests:function(){_2.io.script._validCheck(null);},_toggleVisibility:function(show){var _1af=this.featureLayer,_1b0=_1af.graphics,_1b1=show?"show":"hide",i,len=_1b0.length;show=show&&_1af._ager;for(i=0;i<len;i++){var _1b2=_1b0[i];_1b2[_1b1]();if(show){_1af._repaint(_1b2);}}},_applyTimeFilter:function(_1b3){var _1b4=this.featureLayer;if(!_1b4.timeInfo||_1b4.suspended){return;}if(!_1b3){_1b4._fireUpdateStart();}var _1b5=_1b4._trackManager;if(_1b5){_1b5.clearTracks();}var defn=_1b4.getTimeDefinition(),_1b6=_1b4._getOffsettedTE(_1b4._mapTimeExtent);if(_1b6){_1b6=_1b4._getTimeOverlap(defn,_1b6);if(_1b6){var _1b7=_1b4._filterByTime(_1b4.graphics,_1b6.startTime,_1b6.endTime);if(_1b5){_1b5.addFeatures(_1b7.match);}_2.forEach(_1b7.match,function(_1b8){var _1b9=_1b8._shape;if(!_1b8.visible){_1b8.show();_1b9=_1b8._shape;_1b9&&_1b9._moveToFront();}if(_1b4._ager&&_1b9){_1b4._repaint(_1b8);}});_2.forEach(_1b7.noMatch,function(_1ba){if(_1ba.visible){_1ba.hide();}});}else{this._toggleVisibility(false);}}else{if(_1b5){_1b5.addFeatures(_1b4.graphics);}this._toggleVisibility(true);}if(_1b5){_1b5.moveLatestToFront();_1b5.drawTracks();}if(!_1b3){_1b4._fireUpdateEnd();}}});_2.declare("esri.layers._SelectionMode",[esri.layers._RenderMode],{constructor:function(_1bb){this.featureLayer=_1bb;this._featureMap={};},initialize:function(map){this.map=map;this._init=true;},propertyChangeHandler:function(type){if(this._init&&type===0){this._applyTimeFilter();}},destroy:function(){this._init=false;},resume:function(){this.propertyChangeHandler(0);}});_2.declare("esri.layers._SnapshotMode",[esri.layers._RenderMode],{constructor:function(_1bc){this.featureLayer=_1bc;this._featureMap={};this._drawFeatures=_2.hitch(this,this._drawFeatures);this._queryErrorHandler=_2.hitch(this,this._queryErrorHandler);},initialize:function(map){this.map=map;var _1bd=this.featureLayer;if(_1bd._collection){this._applyTimeFilter();}else{this._fetchAll();}this._init=true;},propertyChangeHandler:function(type){if(this._init){if(type){this._fetchAll();}else{this._applyTimeFilter();}}},destroy:function(){this._init=false;},drawFeature:function(_1be){var _1bf=this.featureLayer,_1c0=_1bf.objectIdField,oid=_1be.attributes[_1c0];this._addFeatureIIf(oid,_1be);this._incRefCount(oid);},resume:function(){this.propertyChangeHandler(0);},refresh:function(){var _1c1=this.featureLayer;if(_1c1._collection){_1c1._fireUpdateStart();_1c1._refresh(true);_1c1._fireUpdateEnd();}else{this._fetchAll();}},_getRequestId:function(_1c2){var id="_"+_1c2.name+_1c2.layerId+_1c2._ulid;return id.replace(/[^a-zA-Z0-9\_]+/g,"_");},_fetchAll:function(){var _1c3=this.featureLayer;if(_1c3._collection){return;}_1c3._fireUpdateStart();this._clearIIf();this._sendRequest();},_sendRequest:function(){var map=this.map,_1c4=this.featureLayer,_1c5=_1c4.getDefinitionExpression();var _1c6=new esri.tasks.Query();_1c6.outFields=_1c4._getOutFields();_1c6.where=_1c5||"1=1";_1c6.returnGeometry=true;_1c6.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());_1c6.timeExtent=_1c4.getTimeDefinition();_1c6.maxAllowableOffset=_1c4._maxOffset;if(_1c4._ts){_1c6._ts=(new Date()).getTime();}var _1c7;if(_1c4._usePatch){_1c7=this._getRequestId(_1c4);this._cancelPendingRequest(null,_1c7);}_1c4._task.execute(_1c6,this._drawFeatures,this._queryErrorHandler,_1c7);},_drawFeatures:function(_1c8){this._purgeRequests();var _1c9=_1c8.features,_1ca=this.featureLayer,_1cb=_1ca.objectIdField,i,len=_1c9.length,_1cc,oid;for(i=0;i<len;i++){_1cc=_1c9[i];oid=_1cc.attributes[_1cb];this._addFeatureIIf(oid,_1cc);this._incRefCount(oid);}this._applyTimeFilter(true);_1ca._fireUpdateEnd(null,_1c8.exceededTransferLimit?{queryLimitExceeded:true}:null);if(_1c8.exceededTransferLimit){_1ca.onQueryLimitExceeded();}},_queryErrorHandler:function(err){this._purgeRequests();var _1cd=this.featureLayer;_1cd._errorHandler(err);_1cd._fireUpdateEnd(err);}});_2.declare("esri.layers._OnDemandMode",[esri.layers._RenderMode],{constructor:function(_1ce){this.featureLayer=_1ce;this._featureMap={};this._queryErrorHandler=_2.hitch(this,this._queryErrorHandler);},initialize:function(map){this.map=map;this._initialize();this._init=true;},propertyChangeHandler:function(type){if(this._init){if(type<2){this._zoomHandler();}}},destroy:function(){this._disableConnectors();this._init=false;},drawFeature:function(_1cf){var _1d0=this._gridLayer,geom=_1cf.geometry,_1d1=[];if(!geom){return;}_1d1=_1d0.getCellsInExtent((geom.type==="point")?{xmin:geom.x,ymin:geom.y,xmax:geom.x,ymax:geom.y}:geom.getExtent(),false).cells;var _1d2=this._cellMap,i,cell,oid=_1cf.attributes[this.featureLayer.objectIdField],_1d3,row,col;for(i=0;i<_1d1.length;i++){cell=_1d1[i];_1d3=cell.latticeID;row=cell.row;col=cell.col;if(_1d3){cell=(_1d2[_1d3]=(_1d2[_1d3]||cell));}else{_1d2[row]=_1d2[row]||{};cell=(_1d2[row][col]=(_1d2[row][col]||cell));}cell.features=cell.features||[];cell.features.push(_1cf);this._addFeatureIIf(oid,_1cf);this._incRefCount(oid);}},suspend:function(){if(!this._init){return;}this._disableConnectors();},resume:function(){if(!this._init){return;}this._enableConnectors();this._zoomHandler();},refresh:function(){this._zoomHandler();},_initialize:function(){var map=this.map,_1d4=this.featureLayer;var _1d5=_1d4._srInfo;this._gridLayer=new esri.layers._GridLayout(new esri.geometry.Point(_1d5?_1d5.valid[0]:map.extent.xmin,map.extent.ymax,map.spatialReference),{width:_1d4._tileWidth,height:_1d4._tileHeight},{width:map.width,height:map.height},_1d5);this._ioQueue=[];if(!_1d4.suspended){this._zoomHandler();this._enableConnectors();}},_enableConnectors:function(){var map=this.map;this._zoomConnect=_2.connect(map,"onZoomEnd",this,this._zoomHandler);this._panConnect=_2.connect(map,"onPanEnd",this,this._panHandler);this._resizeConnect=_2.connect(map,"onResize",this,this._panHandler);},_disableConnectors:function(){_2.disconnect(this._zoomConnect);_2.disconnect(this._panConnect);_2.disconnect(this._resizeConnect);},_zoomHandler:function(){this._processIOQueue(true);var _1d6=this.featureLayer,map=this.map;if(_1d6.suspended){return;}_1d6._fireUpdateStart();this._clearIIf();var _1d7=_1d6._trackManager;if(_1d7){_1d7.clearTracks();}this._cellMap={};this._gridLayer.setResolution(map.extent);this._sendRequest();},_panHandler:function(){this.featureLayer._fireUpdateStart();this._sendRequest(this.featureLayer._resized&&arguments[0]);},_getRequestId:function(_1d8,cell){var id="_"+_1d8.name+_1d8.layerId+_1d8._ulid+"_"+cell.resolution+"_"+(cell.latticeID||(cell.row+"_"+cell.col));return id.replace(/[^a-zA-Z0-9\_]+/g,"_");},_sendRequest:function(_1d9){this._exceeds=false;var _1da=this.featureLayer,map=this.map,_1db=_1d9||map.extent,_1dc=this._gridLayer.getCellsInExtent(_1db,_1da.latticeTiling),_1dd=_1dc.cells;if(!_1da.isEditable()){var _1de=this._cellMap;_1dd=_2.filter(_1dd,function(cell){if(cell.lattice){if(_1de[cell.latticeID]){return false;}}else{if(_1de[cell.row]&&_1de[cell.row][cell.col]){return false;}}return true;});}var _1df=_1da._getOutFields(),_1e0=_1da.getDefinitionExpression(),time=_1da._getOffsettedTE(_1da._mapTimeExtent),_1e1=_1da._usePatch,_1e2=this._ioQueue,i,self=this,func=this._drawFeatures,cell,_1e3,_1e4;this._pending=this._pending||0;for(i=0;i<_1dd.length;i++){cell=_1dd[i];_1e3=new esri.tasks.Query();_1e3.geometry=cell.extent||cell.lattice;_1e3.outFields=_1df;_1e3.where=_1e0;if(_1da.latticeTiling&&cell.extent){_1e3.spatialRelationship=esri.tasks.Query.SPATIAL_REL_CONTAINS;}_1e3.returnGeometry=true;_1e3.timeExtent=time;_1e3.maxAllowableOffset=_1da._maxOffset;if(_1da._ts){_1e3._ts=(new Date()).getTime();}_1e4=null;if(_1e1){_1e4=this._getRequestId(_1da,cell);if(this._isPending(_1e4)){continue;}}this._pending++;_1e2.push(_1da._task.execute(_1e3,function(){var _1e5=cell;return function(_1e6){func.apply(self,[_1e6,_1e5]);};}.call(this),this._queryErrorHandler,_1e4));}this._removeOldCells(_1db);this._endCheck();},_drawFeatures:function(_1e7,cell){this._exceeds=this._exceeds||_1e7.exceededTransferLimit;this._finalizeIO();var _1e8=this.featureLayer,map=this.map,_1e9=map.extent,_1ea=cell.extent,row=cell.row,col=cell.col,_1eb=_1e8.objectIdField,_1ec=_1e7.features,_1ed=this._gridLayer,_1ee=this._cellMap,i,len,_1ef=cell.latticeID,_1f0=_1ef?_1ee[_1ef]:(_1ee[row]&&_1ee[row][col]);if((cell.resolution!=_1ed._resolution)||(_1ef?(_1ef!==_1ed.getLatticeID(_1e9)):(!_1ed.intersects(_1ea,_1e9)))){if(_1f0){this._removeCell(row,col,_1ef);}}else{if(_1f0){this._updateCell(_1f0,_1ec);}else{cell.features=_1ec;if(_1ef){_1ee[_1ef]=cell;}else{_1ee[row]=_1ee[row]||{};_1ee[row][col]=cell;}len=_1ec.length;for(i=0;i<len;i++){var _1f1=_1ec[i];var oid=_1f1.attributes[_1eb];this._addFeatureIIf(oid,_1f1);this._incRefCount(oid);}}}this._endCheck();},_queryErrorHandler:function(err){this._finalizeIO();this.featureLayer._errorHandler(err);this._endCheck(true);},_finalizeIO:function(){this._purgeRequests();this._pending--;},_endCheck:function(_1f2){if(this._pending===0){this._processIOQueue();var _1f3=this.featureLayer,_1f4=_1f3._trackManager;if(_1f4){_1f4.clearTracks();_1f4.addFeatures(_1f3.graphics);if(_1f3._ager){_2.forEach(_1f3.graphics,function(_1f5){if(_1f5._shape){_1f3._repaint(_1f5);}});}_1f4.moveLatestToFront();_1f4.drawTracks();}this.featureLayer._fireUpdateEnd(_1f2&&new Error("FeatureLayer: "+esri.bundle.layers.FeatureLayer.updateError),this._exceeds?{queryLimitExceeded:true}:null);if(this._exceeds){_1f3.onQueryLimitExceeded();}}},_processIOQueue:function(_1f6){this._ioQueue=_2.filter(this._ioQueue,function(dfd){var keep=dfd.fired>-1?false:true;return keep;});if(_1f6){_2.forEach(this._ioQueue,this._cancelPendingRequest);}},_removeOldCells:function(_1f7){var _1f8=this._cellMap,_1f9=this._gridLayer,_1fa,_1fb;for(_1fa in _1f8){if(_1f8[_1fa]){var row=_1f8[_1fa],_1fc=row.latticeID,_1fd=0,_1fe=0;if(_1fc){_1fd++;if(_1fc!==_1f9.getLatticeID(_1f7)){this._removeCell(null,null,_1fc);_1fe++;}}else{for(_1fb in row){if(row[_1fb]){_1fd++;var _1ff=row[_1fb].extent;if(!_1f9.intersects(_1ff,_1f7)){this._removeCell(_1fa,_1fb);_1fe++;}}}}if(_1fe===_1fd){delete _1f8[_1fa];}}}},_updateCell:function(cell,_200){var _201=this.featureLayer,_202=_201.objectIdField,_203=_201._selectedFeatures,i,len=_200.length;cell.features=cell.features||[];for(i=0;i<len;i++){var _204=_200[i];var oid=_204.attributes[_202];var _205=this._addFeatureIIf(oid,_204);if(_205===_204){this._incRefCount(oid);cell.features.push(_205);}else{if(!(oid in _203)){_205.setGeometry(_204.geometry);_205.setAttributes(_204.attributes);}}}},_removeCell:function(row,col,_206){var _207=this._cellMap,_208=this.featureLayer,_209=_208.objectIdField;var cell=_206?_207[_206]:(_207[row]&&_207[row][col]);if(cell){if(_206){delete _207[_206];}else{delete _207[row][col];}var _20a=cell.features,i;for(i=0;i<_20a.length;i++){var _20b=_20a[i];var oid=_20b.attributes[_209];this._decRefCount(oid);if(oid in _208._selectedFeatures){continue;}this._removeFeatureIIf(oid);}}}});_2.declare("esri.layers._GridLayout",null,{constructor:function(_20c,_20d,_20e,_20f){this.origin=_20c;this.cellWidth=_20d.width;this.cellHeight=_20d.height;this.mapWidth=_20e.width;this.mapHeight=_20e.height;this.srInfo=_20f;},setResolution:function(_210){this._resolution=(_210.xmax-_210.xmin)/this.mapWidth;if(this.srInfo){var _211=Math.round((2*this.srInfo.valid[1])/this._resolution),_212=Math.round(_211/this.cellWidth);this._frameStats=[_212,0,_212-1];}},getCellCoordinates:function(_213){var res=this._resolution,_214=this.origin;return {row:Math.floor((_214.y-_213.y)/(this.cellHeight*res)),col:Math.floor((_213.x-_214.x)/(this.cellWidth*res))};},normalize:function(col){var _215=this._frameStats;if(_215){var _216=_215[0],m180=_215[1],p180=_215[2];if(col<m180){col=col%_216;col=col<m180?col+_216:col;}else{if(col>p180){col=col%_216;}}}return col;},intersects:function(_217,_218){var _219=this.srInfo;if(_219){return _2.some(_218._getParts(_219),function(_21a){return _217.intersects(_21a.extent);});}else{return _217.intersects(_218);}},getCellExtent:function(row,col){var res=this._resolution,_21b=this.origin,_21c=this.cellWidth,_21d=this.cellHeight;return new esri.geometry.Extent((col*_21c*res)+_21b.x,_21b.y-((row+1)*_21d*res),((col+1)*_21c*res)+_21b.x,_21b.y-(row*_21d*res),new esri.SpatialReference(_21b.spatialReference.toJson()));},getLatticeID:function(_21e){var _21f=this.getCellCoordinates({x:_21e.xmin,y:_21e.ymax}),_220=this.getCellCoordinates({x:_21e.xmax,y:_21e.ymin}),_221=_21f.row,_222=_220.row,_223=this.normalize(_21f.col),_224=this.normalize(_220.col);return _221+"_"+_222+"_"+_223+"_"+_224;},sorter:function(a,b){return (a<b)?-1:1;},getCellsInExtent:function(_225,_226){var _227=this.getCellCoordinates({x:_225.xmin,y:_225.ymax}),_228=this.getCellCoordinates({x:_225.xmax,y:_225.ymin}),_229=_227.row,_22a=_228.row,_22b=_227.col,_22c=_228.col,_22d=[],i,j,nj,_22e=[],_22f=[],len,xmin,xmax,ymin,ymax,_230=[],_231,_232;for(i=_229;i<=_22a;i++){for(j=_22b;j<=_22c;j++){nj=this.normalize(j);_225=this.getCellExtent(i,nj);_22d.push({row:i,col:nj,extent:_225,resolution:this._resolution});if(_226){_22e.push(_225.xmin,_225.xmax);_22f.push(_225.ymin,_225.ymax);}}}_22b=this.normalize(_22b);_22c=this.normalize(_22c);_22e.sort(this.sorter);_22f.sort(this.sorter);len=_22e.length;for(i=len-1;i>=0;i--){if(i<(len-1)){if(_22e[i]===_22e[i+1]){_22e.splice(i,1);}}}len=_22f.length;for(i=len-1;i>=0;i--){if(i<(len-1)){if(_22f[i]===_22f[i+1]){_22f.splice(i,1);}}}if(_22e.length&&_22f.length){xmin=_22e[0];xmax=_22e[_22e.length-1];ymin=_22f[0];ymax=_22f[_22f.length-1];len=_22e.length;for(i=0;i<len;i++){_230.push([[_22e[i],ymax],[_22e[i],ymin]]);}len=_22f.length;for(i=0;i<len;i++){_230.push([[xmin,_22f[i]],[xmax,_22f[i]]]);}_231=new esri.geometry.Polyline({paths:_230,spatialReference:this.origin.spatialReference.toJson()});_232=_229+"_"+_22a+"_"+_22b+"_"+_22c;_22d.push({latticeID:_232,lattice:_231,resolution:this._resolution});}return {minRow:_229,maxRow:_22a,minCol:_22b,maxCol:_22c,cells:_22d};}});_2.declare("esri.layers._TrackManager",null,{constructor:function(_233){this.layer=_233;this.trackMap={};},initialize:function(map){this.map=map;var _234=this.layer,_235=_234.renderer.trackRenderer;if(_235&&(_234.geometryType==="esriGeometryPoint")){var _236=(this.container=new esri.layers._GraphicsLayer({id:_234.id+"_tracks",_child:true}));_236._setMap(map,_234._div);_236.setRenderer(_235);}},addFeatures:function(_237){var tkid,_238=this.trackMap,_239=this.layer,_23a=_239._trackIdField;_2.forEach(_237,function(_23b){var _23c=_23b.attributes;tkid=_23c[_23a];var ary=(_238[tkid]=(_238[tkid]||[]));ary.push(_23b);});var _23d=_239._startTimeField,_23e=_239.objectIdField;var _23f=function(a,b){var _240=a.attributes[_23d],_241=b.attributes[_23d];if(_240===_241){return (a.attributes[_23e]<b.attributes[_23e])?-1:1;}else{return (_240<_241)?-1:1;}};for(tkid in _238){_238[tkid].sort(_23f);}},drawTracks:function(){var _242=this.container;if(!_242){return;}var _243=this.trackMap,sr=this.map.spatialReference,tkid,ary,path,i,_244,_245=this.layer._trackIdField,_246;for(tkid in _243){ary=_243[tkid];path=[];for(i=ary.length-1;i>=0;i--){_244=ary[i].geometry;if(_244){path.push([_244.x,_244.y]);}}_246={};_246[_245]=tkid;if(path.length>0){_242.add(new esri.Graphic(new esri.geometry.Polyline({paths:[path],spatialReference:sr}),null,_246));}}},moveLatestToFront:function(){_2.forEach(this.getLatestObservations(),function(_247){var _248=_247._shape;_248&&_248._moveToFront();this._repaint(_247,null,true);},this.layer);},getLatestObservations:function(){var _249=[];if(!this.layer.renderer.latestObservationRenderer){return _249;}var _24a=this.trackMap,tkid;for(tkid in _24a){var ary=_24a[tkid];_249.push(ary[ary.length-1]);}return _249;},clearTracks:function(){var _24b=this.getLatestObservations();this.trackMap={};var _24c=this.container;if(_24c){_24c.clear();}_2.forEach(_24b,function(_24d){this._repaint(_24d,null,true);},this.layer);},isLatestObservation:function(_24e){var _24f=this.layer._trackIdField;var _250=this.trackMap[_24e.attributes[_24f]];if(_250){return (_250[_250.length-1]===_24e);}return false;},destroy:function(){var _251=this.container;if(_251){_251.clear();_251._unsetMap(this.map,this.layer._div);this.container=null;}this.map=null;this.layer=null;this.trackMap=null;}});});