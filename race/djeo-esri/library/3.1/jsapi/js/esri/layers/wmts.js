/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/layers/tiled,esri/layers/agscommon,esri/WKIDUnitConversion,dojox/xml/parser"],function(_1,_2,_3){_2.provide("esri.layers.wmts");_2.require("esri.layers.tiled");_2.require("esri.layers.agscommon");_2.require("esri.WKIDUnitConversion");_2.require("dojox.xml.parser");_2.declare("esri.layers.WMTSLayer",[esri.layers.TiledMapServiceLayer],{copyright:null,extent:null,tileUrl:null,layerInfo:null,spatialReference:null,tileInfo:null,constructor:function(_4,_5){this.version="1.0.0";this.tileUr=this._url=_4;this.serviceMode="RESTful";this._parseCapabilities=_2.hitch(this,this._parseCapabilities);this._getCapabilitiesError=_2.hitch(this,this._getCapabilitiesError);if(!_5){_5={};}if(_5.serviceMode){if(_5.serviceMode==="KVP"||_5.serviceMode==="RESTful"){this.serviceMode=_5.serviceMode;}else{console.error("WMTS mode could only be 'KVP' or 'RESTful'");return;}}if(_5.layerInfo){this.layerInfo=_5.layerInfo;this._identifier=_5.layerInfo.identifier;this._tileMatrixSetId=_5.layerInfo.tileMatrixSet;this.format="image/"+_5.layerInfo.format;this._style=_5.layerInfo.style;this.title=_5.layerInfo.title;}if(_5.resourceInfo){this.version=_5.resourceInfo.version;if(_5.resourceInfo.getTileUrl){this._url=this.tileUrl=_5.resourceInfo.getTileUrl;}this.copyright=_5.resourceInfo.copyright;this.layerInfos=_5.resourceInfo.layerInfos;this._parseResourceInfo();this.loaded=true;this.onLoad(this);}else{this._getCapabilities();}this._formatDictionary={"image/png":".png","image/png8":".png","image/png24":".png","image/png32":".png","image/jpg":".jpg","image/jpeg":".jpg","image/gif":".gif","image/bmp":".bmp","image/tiff":".tif"};},setActiveLayer:function(_6){this.layerInfo=_6;this._identifier=_6.identifier;this._tileMatrixSetId=_6.tileMatrixSet;if(_6.format){this.format="image/"+_6.format;}this._style=_6.style;this.title=_6.title;this._parseResourceInfo();this.refresh(true);},getTileUrl:function(_7,_8,_9){var _a;if(this.serviceMode==="KVP"){_a=this._url+"SERVICE=WMTS&VERSION="+this.version+"&REQUEST=GetTile"+"&LAYER="+this._identifier+"&STYLE="+this._style+"&FORMAT="+this.format+"&TILEMATRIXSET="+this._tileMatrixSetId+"&TILEMATRIX="+_7+"&TILEROW="+_8+"&TILECOL="+_9;}else{if(this.serviceMode==="RESTful"){var _b;if(this._formatDictionary[this.format]){_b=this._formatDictionary[this.format];}_a=this._url+this._identifier+"/"+this._style+"/"+this._tileMatrixSetId+"/"+_7+"/"+_8+"/"+_9+_b;}}return _a;},_parseResourceInfo:function(){var _c=this.layerInfos;if(this.serviceMode==="KVP"){this._url+=(this._url.substring(this._url.length-1,this._url.length)=="?")?"":"?";}for(var i=0;i<_c.length;i++){if((!this._identifier||_c[i].identifier===this._identifier)&&(!this.title||_c[i].title===this.title)&&(!this._tileMatrixSetId||_c[i].tileMatrixSet===this._tileMatrixSetId)&&(!this.format||"image/"+_c[i].format===this.format)&&(!this._style||_c[i].style===this._style)){_2.mixin(this,{"description":_c[i].description,tileInfo:_c[i].tileInfo,spatialReference:_c[i].tileInfo.spatialReference,fullExtent:_c[i].fullExtent,initialExtent:_c[i].initialExtent,_identifier:_c[i].identifier,_tileMatrixSetId:_c[i].tileMatrixSet,format:"image/"+_c[i].format,_style:_c[i].style});break;}}},_getCapabilities:function(){var _d;if(this.serviceMode==="KVP"){_d=this._url+"?request=GetCapabilities&service=WMTS&version="+this.version;}else{if(this.serviceMode==="RESTful"){_d=this._url+"/"+this.version+"/WMTSCapabilities.xml";}}esri.request({url:_d,handleAs:"text",load:this._parseCapabilities,error:this._getCapabilitiesError});},_parseCapabilities:function(_e){_e=_e.replace(/ows:/gi,"");var _f=_3.xml.parser.parse(_e);var _10=_2.query("OperationsMetadata",_f)[0];var _11=_2.query("[name='GetTile']",_10)[0];var _12=this.tileUrl;var _13=_2.query("Get",_11);for(var i=0;i<_13.length;i++){var _14=_2.query("Constraint",_13[i])[0];if(this._getTagWithChildTagValue("AllowedValues","Value",this.serviceMode,_14)){_12=_13[i].attributes[0].nodeValue;break;}}if(_12.indexOf("/1.0.0/")===-1&&this.serviceMode==="RESTful"){_12+="/1.0.0/";}if(this.serviceMode==="KVP"){_12+=(_12.substring(_12.length-1,_12.length)=="?")?"":"?";}this._url=_12;var _15=_2.query("Contents",_f)[0];var _16,_17,_18,_19,lod,_1a=[];if(!this._identifier){this._identifier=this._getTagValues("Capabilities>Contents>Layer>Identifier",_f)[0];}this.copyright=this._getTagValues("Capabilities>ServiceIdentification>AccessConstraints",_f)[0];var _1b=this._getTagWithChildTagValue("Layer","Identifier",this._identifier,_15);this.description=this._getTagValues("Abstract",_1b)[0];this.title=this._getTagValues("Title",_1b)[0];if(!this._style){var _1c=_2.query("[isDefault='true']",_1b)[0];if(_1c){this._style=this._getTagValues("Identifier",_1c)[0];}this._style=this._getTagValues("Identifier",_2.query("Style",_1b)[0])[0];}var _1d=this._getTagValues("Format",_1b);if(!this.format){this.format=_1d[0];}if(_2.indexOf(_1d,this.format)===-1){console.error("The format "+this.format+" is not supported by the service");}var _1e=this._getTagValues("TileMatrixSet",_1b);if(!this._tileMatrixSetId){if(_2.indexOf(_1e,"GoogleMapsCompatible")!==-1){this._tileMatrixSetId="GoogleMapsCompatible";}else{this._tileMatrixSetId=_1e[0];}}var _1f=this._getTagWithChildTagValue("TileMatrixSetLink","TileMatrixSet",this._tileMatrixSetId,_1b);var _20=this._getTagValues("TileMatrix",_1f);var _21=this._getTagWithChildTagValue("TileMatrixSet","Identifier",this._tileMatrixSetId,_15);var crs=this._getTagValues("SupportedCRS",_21)[0];_19=crs.split(":").pop();if(_19==900913){_19=3857;}this.spatialReference=new esri.SpatialReference({"wkid":_19});var _22=_2.query("TileMatrix",_21)[0];_16=parseInt(this._getTagValues("TileWidth",_22)[0],10);_17=parseInt(this._getTagValues("TileHeight",_22)[0],10);var _23=this._getTagValues("TopLeftCorner",_22)[0].split(" ");var top=_23[0],_24=_23[1];if(top.split("E").length>1){var _25=top.split("E");top=_25[0]*Math.pow(10,_25[1]);}if(_24.split("E").length>1){var _26=_24.split("E");_24=_26[0]*Math.pow(10,_26[1]);}_18={"x":parseInt(top,10),"y":parseInt(_24,10)};if(_19==3857||_19==102113||_19==102100){_18={"x":-20037508.342787,"y":20037508.342787};}else{if(_19==4326){_18={"x":-180,"y":90};}}var _27=this._getTagValues("MatrixWidth",_22)[0];var _28=this._getTagValues("MatrixHeight",_22)[0];if(_20.length===0){var _29=_2.query("TileMatrix",_21);for(var j=0;j<_29.length;j++){lod=this._getLodFromTileMatrix(_29[j],_19);_1a.push(lod);}}else{for(var i=0;i<_20.length;i++){var _2a=this._getTagWithChildTagValue("TileMatrix","Identifier",_20[i],_21);lod=this._getLodFromTileMatrix(_2a,_19);_1a.push(lod);}}var _2b=_18.x;var _2c=_18.y;var _2d=_2b+_27*_17*_1a[0].resolution;var _2e=_2c-_28*_16*_1a[0].resolution;var _2f=new esri.geometry.Extent(_2b,_2e,_2d,_2c);this.fullExtent=this.initialExtent=_2f;this.tileInfo=new esri.layers.TileInfo({"dpi":90.71428571428571});_2.mixin(this.tileInfo,{"spatialReference":this.spatialReference,"format":this.format,"height":_16,"width":_17,"origin":_18,"lods":_1a});this.loaded=true;this.onLoad(this);},_getCapabilitiesError:function(err){console.error("Failed to get capabilities xml");},_getLodFromTileMatrix:function(_30,_31){var id=this._getTagValues("Identifier",_30)[0];var _32=this._getTagValues("ScaleDenominator",_30)[0];if(_32.split("E").length>1){var _33=_32.split("E");_32=_33[0]*Math.pow(10,_33[1]);}else{_32=parseFloat(_32);}var _34;if(esri._isDefined(esri.WKIDUnitConversion[_31])){_34=esri.WKIDUnitConversion.values[esri.WKIDUnitConversion[_31]];}else{_34=111194.6519066546;}var _35=_32*7/25000/_34;var lod={"level":id,"scale":_32,"resolution":_35};return lod;},_getTag:function(_36,xml){var _37=_2.query(_36,xml);if(_37&&_37.length>0){return _37[0];}else{return null;}},_getTagValues:function(_38,xml){var _39=[];var _3a=_38.split(">");var tag,_3b;tag=_2.query(_3a[0],xml)[0];if(_3a.length>1){for(var i=1;i<_3a.length-1;i++){tag=_2.query(_3a[i],tag)[0];}_3b=_2.query(_3a[_3a.length-1],tag);}else{_3b=_2.query(_3a[0],xml);}if(_3b&&_3b.length>0){_2.forEach(_3b,function(_3c){if(_2.isIE){_39.push(_3c.childNodes[0].nodeValue);}else{_39.push(_3c.textContent);}});}return _39;},_getAttributeValue:function(_3d,_3e,xml,_3f){var _40=_2.query(_3d,xml);if(_40&&_40.length>0){return _40[0].getAttribute(_3e);}else{return _3f;}},_getTagWithChildTagValue:function(_41,_42,_43,xml){var _44=xml.childNodes;var _45;for(var j=0;j<_44.length;j++){if(_44[j].nodeName===_41){if(_2.isIE){if(esri._isDefined(_2.query(_42,_44[j])[0])){_45=_2.query(_42,_44[j])[0].childNodes[0].nodeValue;}}else{if(esri._isDefined(_2.query(_42,_44[j])[0])){_45=_2.query(_42,_44[j])[0].textContent;}}if(_45===_43){return _44[j];}}}}});_2.declare("esri.layers.WMTSLayerInfo",null,{identifier:null,tileMatrixSet:null,format:null,style:null,tileInfo:null,title:null,fullExtent:null,initialExtent:null,description:null,constructor:function(_46){if(_46){this.title=_46.title;this.tileMatrixSet=_46.tileMatrixSet;this.format=_46.format;this.style=_46.style;this.tileInfo=_46.tileInfo;this.fullExtent=_46.fullExtent;this.initialExtent=_46.initialExtent;this.identifier=_46.identifier;this.description=_46.description;}}});});