/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/layers/dynamic,esri/layers/agscommon,esri/_time"],function(_1,_2,_3){_2.provide("esri.layers.agsdynamic");_2.require("esri.layers.dynamic");_2.require("esri.layers.agscommon");_2.require("esri._time");_2.declare("esri.layers.ArcGISDynamicMapServiceLayer",[esri.layers.DynamicMapServiceLayer,esri.layers.ArcGISMapServiceLayer],{constructor:function(_4,_5){var _6=_5&&_5.imageParameters,dh=_2.hitch;if(_6){var _7=_6.layerDefinitions;if(_7){this.setLayerDefinitions(_7);}if(_6.layerOption===esri.layers.ImageParameters.LAYER_OPTION_SHOW){this.visibleLayers=[].concat(_6.layerIds);}}this._setIsPNG32=dh(this,this._setIsPNG32);this.dpi=(_6&&_6.dpi)||96;this.imageFormat=(_6&&_6.format)||"png8";this.imageTransparency=(_6&&_6.transparent===false)?false:true;this._setIsPNG32();this.gdbVersion=_5&&_5.gdbVersion;this._params.gdbVersion=this.gdbVersion;_2.mixin(this._params,this._url.query,{dpi:this.dpi,transparent:this.imageTransparency,format:this.imageFormat},_6?_6.toJson():{});this.getImageUrl=dh(this,this.getImageUrl);this._initLayer=dh(this,this._initLayer);this._load=dh(this,this._load);this.useMapImage=_5?_5.useMapImage:false;if(this.useMapImage){this._imageExportHandler=dh(this,this._imageExportHandler);}this._loadCallback=_5&&_5.loadCallback;var _8=_5&&_5.resourceInfo;if(_8){this._initLayer(_8);}else{if(arguments[2]===undefined||arguments[2]===false){this._load();}}},disableClientCaching:false,layerDefinitions:null,_initLayer:function(_9,io){this.inherited(arguments);if(_9.timeInfo){this.timeInfo=new esri.layers.TimeInfo(_9.timeInfo);}this.loaded=true;this.onLoad(this);var _a=this._loadCallback;if(_a){delete this._loadCallback;_a(this);}},getImageUrl:function(_b,_c,_d,_e){var _f=this._url.path+"/export?",_10=this._params,sr=_b.spatialReference.wkid||_2.toJson(_b.spatialReference.toJson()),_11=this._errorHandler;delete _10._ts;_2.mixin(_10,{bbox:_b.xmin+","+_b.ymin+","+_b.xmax+","+_b.ymax,bboxSR:sr,imageSR:sr,size:_c+","+_d},this.disableClientCaching?{_ts:new Date().getTime()}:{});if(_10.layerDefs){var _12=_10.layerDefs;delete _10.layerDefs;_2.mixin(_10,{layerDefs:_12});}var _13=(_10.token=this._getToken()),_14=esri._getProxiedUrl(_f+_2.objectToQuery(_2.mixin({},_10,{f:"image"})));if((_14.length>esri.config.defaults.io.postLength)||this.useMapImage){this._jsonRequest=esri.request({url:_f,content:_2.mixin(_10,{f:"json"}),callbackParamName:"callback",load:function(_15,io){var _16=_15.href;if(_13){_16+=(_16.indexOf("?")===-1?("?token="+_13):("&token="+_13));}_e(esri._getProxiedUrl(_16));},error:_11});}else{_e(_14);}},_setIsPNG32:function(){var _17=this.imageFormat.toLowerCase();var _18=_2.isIE;this.isPNG32=_18&&_18===6&&(_17==="png32"||_17==="png24")&&this.imageTransparency;},_setTime:function(_19){var _1a=this.timeInfo,_1b=(this._params.time=_19?_19.toJson().join(","):null);if(this.version<10.02&&_1a){if(!_1b){var _1c=this.layerInfos;if(_1c){var _1d=this.layerTimeOptions,_1e=_1d?_1d.slice(0):[],ids=[];_2.forEach(_1c,function(_1f){if(!_1f.subLayerIds){ids.push(_1f.id);}});if(ids.length){_2.forEach(ids,function(id){if(!_1e[id]){var opt=new esri.layers.LayerTimeOptions();opt.useTime=false;_1e[id]=opt;}});this._params.layerTimeOptions=esri._serializeTimeOptions(_1e,ids);}}}else{this._params.layerTimeOptions=esri._serializeTimeOptions(this.layerTimeOptions);}}if(this.version>=10.02&&_1a){if(!_1b&&!_1a.hasLiveData){this._params.time="null,null";}}},setDPI:function(dpi,_20){this.dpi=(this._params.dpi=dpi);if(!_20){this.refresh(true);}},setImageFormat:function(_21,_22){this.imageFormat=(this._params.format=_21);this._setIsPNG32();if(!_22){this.refresh(true);}},setImageTransparency:function(_23,_24){this.imageTransparency=(this._params.transparent=_23);this._setIsPNG32();if(!_24){this.refresh(true);}},setVisibleLayers:function(_25,_26){this.visibleLayers=_25;this._params.layers=esri.layers.ImageParameters.LAYER_OPTION_SHOW+":"+_25.join(",");this._updateDynamicLayers();if(!_26){this.refresh(true);}},setDefaultVisibleLayers:function(_27){this.visibleLayers=this._defaultVisibleLayers;this._params.layers=null;this._updateDynamicLayers();if(!_27){this.refresh(true);}},setLayerDefinitions:function(_28,_29){this.layerDefinitions=_28;this._params.layerDefs=esri._serializeLayerDefinitions(_28);this._updateDynamicLayers();if(!_29){this.refresh(true);}},setDefaultLayerDefinitions:function(_2a){this.layerDefinitions=this._params.layerDefs=null;this._updateDynamicLayers();if(!_2a){this.refresh(true);}},setDisableClientCaching:function(_2b){this.disableClientCaching=_2b;},setLayerTimeOptions:function(_2c,_2d){this.layerTimeOptions=_2c;this._params.layerTimeOptions=esri._serializeTimeOptions(_2c);this._updateDynamicLayers();if(!_2d){this.refresh(true);}},refresh:function(_2e){if(_2e){this.inherited(arguments);}else{var dc=this.disableClientCaching;this.disableClientCaching=true;this.inherited(arguments);this.disableClientCaching=dc;}},setLayerDrawingOptions:function(_2f,_30){this.layerDrawingOptions=_2f;this._updateDynamicLayers();if(!_30){this.refresh(true);}},setDynamicLayerInfos:function(_31,_32){if(_31&&_31.length>0){this.dynamicLayerInfos=_31;this.visibleLayers=esri._getDefaultVisibleLayers(_31);}else{this.dynamicLayerInfos=this.layerDrawingOptions=null;}this._updateDynamicLayers();if(!_32){this.refresh(true);}},createDynamicLayerInfosFromLayerInfos:function(){var _33=[],_34,_35;_2.forEach(this.layerInfos,function(_36,idx){_34=new esri.layers.DynamicLayerInfo(_36.toJson());_34.source=new esri.layers.LayerMapSource({mapLayerId:_36.id});_33.push(_34);});return _33;},_onDynamicLayersChange:function(){},_updateDynamicLayers:function(){if((this.dynamicLayerInfos&&this.dynamicLayerInfos.length>0)||(this.layerDrawingOptions&&this.layerDrawingOptions.length>0)){var _37,_38=this.dynamicLayerInfos||this.layerInfos,_39=[],_3a=this._map&&esri.geometry.getScale(this._map),_3b=this.visibleLayers,_3c=_3a?esri._getLayersForScale(_3a,_38):_3b;_2.forEach(_38,function(_3d){if(!_3d.subLayerIds){var _3e=_3d.id;if(_2.indexOf(_3b,_3e)!==-1&&_2.indexOf(_3c,_3e)!==-1){var _3f={id:_3e};if(this.dynamicLayerInfos){_3f.source=_3d.source&&_3d.source.toJson();}else{_3f.source={type:"mapLayer",mapLayerId:_3e};}var _40;if(this.layerDefinitions&&this.layerDefinitions[_3e]){_40=this.layerDefinitions[_3e];}if(_40){_3f.definitionExpression=_40;}var _41;if(this.layerDrawingOptions&&this.layerDrawingOptions[_3e]){_41=this.layerDrawingOptions[_3e];}if(_41){_3f.drawingInfo=_41.toJson();}var _42;if(this.layerTimeOptions&&this.layerTimeOptions[_3e]){_42=this.layerTimeOptions[_3e];}if(_42){_3f.layerTimeOptions=_42.toJson();}_39.push(_3f);}}},this);_37=_2.toJson(_39);if(_37==="[]"){_37="[{}]";}if(!this._params.dynamicLayers||(this._params.dynamicLayers.length!==_37.length||this._params.dynamicLayers!==_37)){this._params.dynamicLayers=_37;this._onDynamicLayersChange(this._params.dynamicLayers);}}else{if(this._params.dynamicLayers){this._params.dynamicLayers=null;this._onDynamicLayersChange(null);}else{this._params.dynamicLayers=null;}}},_onExtentChangeHandler:function(_43,_44,_45){if(_45){this._updateDynamicLayers();}this.inherited(arguments);},_setMap:function(map,_46,_47){this._map=map;this._updateDynamicLayers();return this.inherited(arguments);},onGDBVersionChange:function(){},setGDBVersion:function(_48,_49){this.gdbVersion=_48;this._params.gdbVersion=_48;this.onGDBVersionChange();if(!_49){this.refresh(true);}},exportMapImage:function(_4a,_4b){var m=esri.config.defaults.map,p=_2.mixin({size:m.width+","+m.height},this._params,_4a?_4a.toJson(this.normalization):{},{f:"json"});delete p._ts;if(p.layerDefs){var _4c=p.layerDefs;delete p.layerDefs;_2.mixin(p,{layerDefs:_4c});}this._exportMapImage(this._url.path+"/export",p,_4b);}});_2.declare("esri.layers.ImageParameters",null,{constructor:function(){this.layerDefinitions=[];this._bundle=_2.i18n.getLocalization("esri","jsapi");},bbox:null,extent:null,width:null,height:null,dpi:null,format:null,imageSpatialReference:null,layerOption:null,layerIds:null,transparent:null,timeExtent:null,layerTimeOptions:null,toJson:function(_4d){if(this.bbox){_2.deprecated(this.declaredClass+" : "+this._bundle.layers.imageParameters.deprecateBBox);}var bb=this.bbox||this.extent;bb=bb&&_4d&&bb._normalize(true);var _4e=this.layerOption,_4f=bb?(bb.spatialReference.wkid||_2.toJson(bb.spatialReference.toJson())):null,_50=this.imageSpatialReference,_51={dpi:this.dpi,format:this.format,transparent:this.transparent,size:(this.width!==null&&this.height!==null?this.width+","+this.height:null),bbox:(bb?(bb.xmin+","+bb.ymin+","+bb.xmax+","+bb.ymax):null),bboxSR:_4f,layers:(_4e?_4e+":"+this.layerIds.join(","):null),imageSR:(_50?(_50.wkid||_2.toJson(_50.toJson())):_4f)};_51.layerDefs=esri._serializeLayerDefinitions(this.layerDefinitions);var _52=this.timeExtent;_51.time=_52?_52.toJson().join(","):null;_51.layerTimeOptions=esri._serializeTimeOptions(this.layerTimeOptions);return esri.filter(_51,function(_53){if(_53!==null){return true;}});}});_2.mixin(esri.layers.ImageParameters,{LAYER_OPTION_SHOW:"show",LAYER_OPTION_HIDE:"hide",LAYER_OPTION_INCLUDE:"include",LAYER_OPTION_EXCLUDE:"exclude"});_2.declare("esri.layers.MapImage",null,{constructor:function(_54){_2.mixin(this,_54);this.extent=new esri.geometry.Extent(this.extent);}});});