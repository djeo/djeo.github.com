/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox"],function(_1,_2,_3){_2.provide("esri.geometry.utils");(function(){var EG=esri.geometry;EG.normalizeCentralMeridian=function(_4,_5,_6,_7){var _8=new _2.Deferred();_8.addCallbacks(_6,_7);var _9=[],_a=[],_b=_4[0].spatialReference,_c=_b._getInfo(),_d=_b._isWebMercator(),_e=_d?20037508.342788905:180,_f=_d?-20037508.342788905:-180,_10=new esri.geometry.Polyline({"paths":[[[_e,_f],[_e,_e]]]}),_11=new esri.geometry.Polyline({"paths":[[[_f,_f],[_f,_e]]]}),_12=0;_2.forEach(_4,function(_13){var _14=esri.geometry.fromJson(_2.fromJson(_2.toJson(_13.toJson()))),_15=_13.getExtent();if(_13.type==="point"){_9.push(EG._pointNormalization(_14,_e,_f));}else{if(_13.type==="multipoint"){_14.points=_2.map(_14.points,function(_16){return EG._pointNormalization(_16,_e,_f);});_9.push(_14);}else{if(_13.type==="extent"){_9.push(_15._normalize(null,null,_c));}else{var _17=EG._offsetMagnitude(_15.xmin,_f),_18=_17*(2*_e);_14=(_18===0)?_14:EG._updatePolyGeometry(_14,_18);_15=_15.offset(_18,0);if(_15.intersects(_10)&&(_15.xmax!==_e)){_12=(_15.xmax>_12)?_15.xmax:_12;_14=EG._prepareGeometryForCut(_14,_d);_a.push(_14);_9.push("cut");}else{if(_15.intersects(_11)&&(_15.xmin!==_f)){_12=(_15.xmax*(2*_e)>_12)?_15.xmax*(2*_e):_12;_14=EG._prepareGeometryForCut(_14,_d,360);_a.push(_14);_9.push("cut");}else{_9.push(_14);}}}}}});var _19=new esri.geometry.Polyline(),_1a=EG._offsetMagnitude(_12,_e),_1b=-90,_1c=_1a;while(_1a>0){var _1d=-180+(360*_1a);_19.addPath([[_1d,_1b],[_1d,_1b*-1]]);_1b=_1b*-1;_1a--;}if(_a.length>0&&_1c>0){if(_5){_5.cut(_a,_19,function(_1e){_a=EG._foldCutResults(_a,_1e);var _1f=[];_2.forEach(_9,function(_20,i){if(_20==="cut"){var _21=_a.shift();if((_4[i].rings)&&(_4[i].rings.length>1)&&(_21.rings.length>=_4[i].rings.length)){_9[i]="simplify";_1f.push(_21);}else{_9[i]=(_d===true)?EG.geographicToWebMercator(_21):_21;}}});if(_1f.length>0){_5.simplify(_1f,function(_22){_2.forEach(_9,function(_23,i){if(_23==="simplify"){_9[i]=(_d===true)?EG.geographicToWebMercator(_22.shift()):_22.shift();}});_8.callback(_9);},function(_24){_8.errback(_24);});}else{_8.callback(_9);}},function(_25){_8.errback(_25);});}else{_8.errback(new Error("esri.geometry.normalizeCentralMeridian: 'geometryService' argument is missing."));}}else{_2.forEach(_9,function(_26,i){if(_26==="cut"){var _27=_a.shift();_9[i]=(_d===true)?EG.geographicToWebMercator(_27):_27;}});_8.callback(_9);}return _8;};EG.geodesicDensify=function(_28,_29){var _2a=Math.PI/180;var _2b=6371008.771515059;if(_29<_2b/10000){_29=_2b/10000;}if(!(_28 instanceof esri.geometry.Polyline||_28 instanceof esri.geometry.Polygon)){var msg="_geodesicDensify: the input geometry is neither polyline nor polygon";console.error(msg);throw new Error(msg);}var _2c=_28 instanceof esri.geometry.Polyline,_2d=_2c?_28.paths:_28.rings,_2e=[],_2f;_2.forEach(_2d,function(_30){_2e.push(_2f=[]);_2f.push([_30[0][0],_30[0][1]]);var _31,_32,_33,_34,i,j;_31=_30[0][0]*_2a;_32=_30[0][1]*_2a;for(i=0;i<_30.length-1;i++){_33=_30[i+1][0]*_2a;_34=_30[i+1][1]*_2a;var _35=EG._inverseGeodeticSolver(_32,_31,_34,_33);var _36=_35.azimuth;var _37=_35.geodesicDistance;var _38=_37/_29;if(_38>1){for(j=1;j<=_38-1;j++){var _39=j*_29;var pt=EG._directGeodeticSolver(_32,_31,_36,_39);_2f.push([pt.x,pt.y]);}var _3a=(_37+Math.floor(_38-1)*_29)/2;var _3b=EG._directGeodeticSolver(_32,_31,_36,_3a);_2f.push([_3b.x,_3b.y]);}var _3c=EG._directGeodeticSolver(_32,_31,_36,_37);_2f.push([_3c.x,_3c.y]);_31=_3c.x*_2a;_32=_3c.y*_2a;}});if(_2c){return new esri.geometry.Polyline({paths:_2e,spatialReference:_28.spatialReference});}else{return new esri.geometry.Polygon({rings:_2e,spatialReference:_28.spatialReference});}};EG.geodesicLengths=function(_3d,_3e){var _3f=Math.PI/180;var _40=[];_2.forEach(_3d,function(_41,idx){var _42=0;_2.forEach(_41.paths,function(_43,idx){var _44=0;var i,_45,_46,_47,_48,_49;for(i=1;i<_43.length;i++){_45=_43[i-1][0]*_3f;_46=_43[i][0]*_3f;_47=_43[i-1][1]*_3f;_48=_43[i][1]*_3f;_49=EG._inverseGeodeticSolver(_47,_45,_48,_46);_44+=_49.geodesicDistance/1609.344;}_42+=_44;});_42*=EG._unitsDictionary[_3e];_40.push(_42);});return _40;};EG.geodesicAreas=function(_4a,_4b){var _4c=[];_2.forEach(_4a,function(_4d,idx){var _4e=EG.geodesicDensify(_4d,10000);_4c.push(_4e);});var _4f=[];var _50,_51;_2.forEach(_4c,function(_52,idx){var _53=0;_2.forEach(_52.rings,function(_54,idx){_50=EG._toEqualAreaPoint(new esri.geometry.Point(_54[0][0],_54[0][1]));_51=EG._toEqualAreaPoint(new esri.geometry.Point(_54[_54.length-1][0],_54[_54.length-1][1]));var _55=_51.x*_50.y-_50.x*_51.y;var i;for(i=0;i<_54.length-1;i++){_50=EG._toEqualAreaPoint(new esri.geometry.Point(_54[i+1][0],_54[i+1][1]));_51=EG._toEqualAreaPoint(new esri.geometry.Point(_54[i][0],_54[i][1]));_55+=_51.x*_50.y-_50.x*_51.y;}_55/=4046.87;_53+=_55;});_53*=EG._unitsDictionary[_4b];_4f.push(_53/(-2));});return _4f;};EG.polygonSelfIntersecting=function(_56){var i,j,k,m,_57,_58,_59,_5a=_56.rings.length;for(k=0;k<_5a;k++){for(i=0;i<_56.rings[k].length-1;i++){_57=[[_56.rings[k][i][0],_56.rings[k][i][1]],[_56.rings[k][i+1][0],_56.rings[k][i+1][1]]];for(j=k+1;j<_5a;j++){for(m=0;m<_56.rings[j].length-1;m++){_58=[[_56.rings[j][m][0],_56.rings[j][m][1]],[_56.rings[j][m+1][0],_56.rings[j][m+1][1]]];_59=esri.geometry._getLineIntersection2(_57,_58);if(_59){if(!((_59[0]===_57[0][0]&&_59[1]===_57[0][1])||(_59[0]===_58[0][0]&&_59[1]===_58[0][1])||(_59[0]===_57[1][0]&&_59[1]===_57[1][1])||(_59[0]===_58[1][0]&&_59[1]===_58[1][1]))){return true;}}}}}var _5b=_56.rings[k].length;if(_5b<=4){continue;}for(i=0;i<_5b-3;i++){var _5c=_5b-1;if(i===0){_5c=_5b-2;}_57=[[_56.rings[k][i][0],_56.rings[k][i][1]],[_56.rings[k][i+1][0],_56.rings[k][i+1][1]]];for(j=i+2;j<_5c;j++){_58=[[_56.rings[k][j][0],_56.rings[k][j][1]],[_56.rings[k][j+1][0],_56.rings[k][j+1][1]]];_59=esri.geometry._getLineIntersection2(_57,_58);if(_59){if(!((_59[0]===_57[0][0]&&_59[1]===_57[0][1])||(_59[0]===_58[0][0]&&_59[1]===_58[0][1])||(_59[0]===_57[1][0]&&_59[1]===_57[1][1])||(_59[0]===_58[1][0]&&_59[1]===_58[1][1]))){return true;}}}}}return false;};EG._foldCutResults=function(_5d,_5e){var _5f=-1;_2.forEach(_5e.cutIndexes,function(_60,i){var _61=_5e.geometries[i];var _62=_61.rings||_61.paths;_2.forEach(_62,function(_63,_64){_2.some(_63,function(_65){if(_65[0]<180){return true;}else{var _66=0,j,jl=_63.length,ptX;for(j=0;j<jl;j++){ptX=_63[j][0];_66=ptX>_66?ptX:_66;}var _67=EG._offsetMagnitude(_66,180),_68=_67*-360,_69,_6a=_63.length;for(_69=0;_69<_6a;_69++){var _6b=_61.getPoint(_64,_69);_61.setPoint(_64,_69,_6b.offset(_68,0));}return true;}});});if(_60===_5f){if(_61.rings){_2.forEach(_61.rings,function(_6c,j){_5d[_60]=_5d[_60].addRing(_6c);});}else{_2.forEach(_61.paths,function(_6d,j){_5d[_60]=_5d[_60].addPath(_6d);});}}else{_5f=_60;_5d[_60]=_61;}});return _5d;};EG._prepareGeometryForCut=function(_6e,_6f,_70){var _71=1000000;if(_6f){var _72=EG._straightLineDensify(_6e,_71);_6e=EG.webMercatorToGeographic(_72,true);}if(_70){_6e=EG._updatePolyGeometry(_6e,_70);}return _6e;};EG._offsetMagnitude=function(_73,_74){return Math.ceil((_73-_74)/(_74*2));};EG._pointNormalization=function(_75,_76,_77){var _78=_75.x||_75[0];var _79;if(_78>_76){_79=EG._offsetMagnitude(_78,_76);if(_75.x){_75=_75.offset(_79*(-2*_76),0);}else{_75[0]=_78+(_79*(-2*_76));}}else{if(_78<_77){_79=EG._offsetMagnitude(_78,_77);if(_75.x){_75=_75.offset(_79*(-2*_77),0);}else{_75[0]=_78+(_79*(-2*_77));}}}return _75;};EG._updatePolyGeometry=function(_7a,_7b){var _7c=_7a.paths||_7a.rings,i,j,il=_7c.length,jl;for(i=0;i<il;i++){var _7d=_7c[i];jl=_7d.length;for(j=0;j<jl;j++){var _7e=_7a.getPoint(i,j);_7a.setPoint(i,j,_7e.offset(_7b,0));}}return _7a;};EG._straightLineDensify=function(_7f,_80){if(!(_7f instanceof esri.geometry.Polyline||_7f instanceof esri.geometry.Polygon)){var msg="_straightLineDensify: the input geometry is neither polyline nor polygon";console.error(msg);throw new Error(msg);}var _81=_7f instanceof esri.geometry.Polyline,_82=_81?_7f.paths:_7f.rings,_83=[],_84;_2.forEach(_82,function(_85){_83.push(_84=[]);_84.push([_85[0][0],_85[0][1]]);var x1,y1,x2,y2;var i,j,_86,_87,_88,_89,xj,yj;for(i=0;i<_85.length-1;i++){x1=_85[i][0];y1=_85[i][1];x2=_85[i+1][0];y2=_85[i+1][1];_86=Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));_87=(y2-y1)/_86;_88=(x2-x1)/_86;_89=_86/_80;if(_89>1){for(j=1;j<=_89-1;j++){var _8a=j*_80;xj=_88*_8a+x1;yj=_87*_8a+y1;_84.push([xj,yj]);}var _8b=(_86+Math.floor(_89-1)*_80)/2;xj=_88*_8b+x1;yj=_87*_8b+y1;_84.push([xj,yj]);}_84.push([x2,y2]);}});if(_81){return new esri.geometry.Polyline({paths:_83,spatialReference:_7f.spatialReference});}else{return new esri.geometry.Polygon({rings:_83,spatialReference:_7f.spatialReference});}};EG._unitsDictionary={"esriMiles":1,"esriKilometers":1.609344,"esriFeet":5280,"esriMeters":1609.34,"esriYards":1760,"esriNauticalMiles":0.869,"esriCentimeters":160934,"esriDecimeters":16093.4,"esriInches":63360,"esriMillimeters":1609340,"esriAcres":1,"esriAres":40.4685642,"esriSquareKilometers":0.00404685642,"esriSquareMiles":0.0015625,"esriSquareFeet":43560,"esriSquareMeters":4046.85642,"esriHectares":0.404685642,"esriSquareYards":4840,"esriSquareInches":6272640,"esriSquareMillimeters":4046856420,"esriSquareCentimeters":40468564.2,"esriSquareDecimeters":404685.642};EG._toEqualAreaPoint=function(pt){var _8c=Math.PI/180;var a=6378137;var eSq=0.006694379990197414,e=0.0818191908429643;var _8d=Math.sin(pt.y*_8c);var q=(1-eSq)*((_8d/(1-eSq*(_8d*_8d))-(1/(2*e))*Math.log((1-e*_8d)/(1+e*_8d))));var x=a*pt.x*_8c;var y=a*q*0.5;var _8e=new esri.geometry.Point(x,y);return _8e;};EG._directGeodeticSolver=function(_8f,_90,_91,s){var a=6378137,b=6356752.31424518,f=1/298.257223563;var _92=Math.sin(_91);var _93=Math.cos(_91);var _94=(1-f)*Math.tan(_8f);var _95=1/Math.sqrt((1+_94*_94)),_96=_94*_95;var _97=Math.atan2(_94,_93);var _98=_95*_92;var _99=1-_98*_98;var uSq=_99*(a*a-b*b)/(b*b);var A=1+uSq/16384*(4096+uSq*(-768+uSq*(320-175*uSq)));var B=uSq/1024*(256+uSq*(-128+uSq*(74-47*uSq)));var _9a=s/(b*A),_9b=2*Math.PI;var _9c,_9d,_9e;while(Math.abs(_9a-_9b)>1e-12){_9e=Math.cos(2*_97+_9a);_9c=Math.sin(_9a);_9d=Math.cos(_9a);var _9f=B*_9c*(_9e+B/4*(_9d*(-1+2*_9e*_9e)-B/6*_9e*(-3+4*_9c*_9c)*(-3+4*_9e*_9e)));_9b=_9a;_9a=s/(b*A)+_9f;}var tmp=_96*_9c-_95*_9d*_93;var _a0=Math.atan2(_96*_9d+_95*_9c*_93,(1-f)*Math.sqrt(_98*_98+tmp*tmp));var _a1=Math.atan2(_9c*_92,_95*_9d-_96*_9c*_93);var C=f/16*_99*(4+f*(4-3*_99));var L=_a1-(1-C)*f*_98*(_9a+C*_9c*(_9e+C*_9d*(-1+2*_9e*_9e)));var _a2=_a0/(Math.PI/180);var _a3=(_90+L)/(Math.PI/180);var pt=new esri.geometry.Point(_a3,_a2,new esri.SpatialReference({wkid:4326}));return pt;};EG._inverseGeodeticSolver=function(_a4,_a5,_a6,_a7){var a=6378137,b=6356752.31424518,f=1/298.257223563;var L=(_a7-_a5);var U1=Math.atan((1-f)*Math.tan(_a4));var U2=Math.atan((1-f)*Math.tan(_a6));var _a8=Math.sin(U1),_a9=Math.cos(U1);var _aa=Math.sin(U2),_ab=Math.cos(U2);var _ac=L,_ad,_ae=1000;var _af,_b0,_b1,_b2,_b3;do{var _b4=Math.sin(_ac),_b5=Math.cos(_ac);_b0=Math.sqrt((_ab*_b4)*(_ab*_b4)+(_a9*_aa-_a8*_ab*_b5)*(_a9*_aa-_a8*_ab*_b5));if(_b0===0){return 0;}_b2=_a8*_aa+_a9*_ab*_b5;_b3=Math.atan2(_b0,_b2);var _b6=_a9*_ab*_b4/_b0;_af=1-_b6*_b6;_b1=_b2-2*_a8*_aa/_af;if(isNaN(_b1)){_b1=0;}var C=f/16*_af*(4+f*(4-3*_af));_ad=_ac;_ac=L+(1-C)*f*_b6*(_b3+C*_b0*(_b1+C*_b2*(-1+2*_b1*_b1)));}while(Math.abs(_ac-_ad)>1e-12&&--_ae>0);if(_ae===0){var _b7=6371009;var _b8=Math.acos(Math.sin(_a4)*Math.sin(_a6)+Math.cos(_a4)*Math.cos(_a6)*Math.cos(_a7-_a5))*_b7;var _b9=_a7-_a5;var y=Math.sin(_b9)*Math.cos(_a6);var x=Math.cos(_a4)*Math.sin(_a6)-Math.sin(_a4)*Math.cos(_a6)*Math.cos(_b9);var _ba=Math.atan2(y,x);return {"azimuth":_ba,"geodesicDistance":_b8};}var uSq=_af*(a*a-b*b)/(b*b);var A=1+uSq/16384*(4096+uSq*(-768+uSq*(320-175*uSq)));var B=uSq/1024*(256+uSq*(-128+uSq*(74-47*uSq)));var _bb=B*_b0*(_b1+B/4*(_b2*(-1+2*_b1*_b1)-B/6*_b1*(-3+4*_b0*_b0)*(-3+4*_b1*_b1)));var s=b*A*(_b3-_bb);var _bc=Math.atan2(_ab*Math.sin(_ac),_a9*_aa-_a8*_ab*Math.cos(_ac));var _bd=Math.atan2(_a9*Math.sin(_ac),_a9*_aa*Math.cos(_ac)-_a8*_ab);var _be={azimuth:_bc,geodesicDistance:s,reverseAzimuth:_bd};return _be;};}());});