/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox"],function(_1,_2,_3){_2.provide("esri.PopupBase");_2.declare("esri.PopupBase",null,{onSetFeatures:function(){},onClearFeatures:function(){},onSelectionChange:function(){},onDfdComplete:function(){var _4=this._marked;if(_4){this._marked=null;this.showClosestFirst(_4);}},initialize:function(){this.count=0;this.selectedIndex=-1;},cleanup:function(){this.features=this.deferreds=null;},setFeatures:function(_5){if(!_5||!_5.length){return;}this.clearFeatures();var _6,_7;if(_5[0] instanceof _2.Deferred){_7=_5;}else{_6=_5;}if(_6){this._updateFeatures(null,_6);}else{this.deferreds=_7;_7=_7.slice(0);_2.forEach(_7,function(_8){_8.addBoth(_2.hitch(this,this._updateFeatures,_8));},this);}},clearFeatures:function(){this.features=this.deferreds=this._marked=null;this.count=0;var _9=this.selectedIndex;this.selectedIndex=-1;if(_9>-1){this.onSelectionChange();}this.onClearFeatures();},getSelectedFeature:function(){var _a=this.features;if(_a){return _a[this.selectedIndex];}},select:function(_b){if(_b<0||_b>=this.count){return;}this.selectedIndex=_b;this.onSelectionChange();},enableHighlight:function(_c){this._highlighted=_c.graphics.add(new esri.Graphic(new esri.geometry.Point(0,0,_c.spatialReference)));this._highlighted.hide();var _d=esri.symbol;if(!this.markerSymbol){var _e=(this.markerSymbol=new _d.SimpleMarkerSymbol());_e.setStyle(_d.SimpleMarkerSymbol.STYLE_TARGET);_e._setDim(16,16,7);_e.setOutline(new _d.CartographicLineSymbol(_d.SimpleLineSymbol.STYLE_SOLID,new _2.Color([0,255,255]),2,_d.CartographicLineSymbol.CAP_ROUND,_d.CartographicLineSymbol.JOIN_ROUND));_e.setColor(new _2.Color([0,0,0,0]));}if(!this.lineSymbol){this.lineSymbol=new _d.SimpleLineSymbol(_d.SimpleLineSymbol.STYLE_SOLID,new _2.Color([0,255,255]),2);}if(!this.fillSymbol){this.fillSymbol=new _d.SimpleFillSymbol(_d.SimpleFillSymbol.STYLE_NULL,new _d.SimpleLineSymbol(_d.SimpleLineSymbol.STYLE_SOLID,new _2.Color([0,255,255]),2),new _2.Color([0,0,0,0]));}},disableHighlight:function(_f){var _10=this._highlighted;if(_10){_10.hide();_f.graphics.remove(_10);delete this._highlighted;}this.markerSymbol=this.lineSymbol=this.fillSymbol=null;},showHighlight:function(){if(this._highlighted&&this.features&&this.features[this.selectedIndex]){this._highlighted.show();}},hideHighlight:function(){if(this._highlighted){this._highlighted.hide();}},updateHighlight:function(map,_11){var _12=_11.geometry,_13=this._highlighted;if(!_12||!_13){return;}_13.hide();if(!_13.getLayer()&&map){map.graphics.add(_13);}_13.setGeometry(esri.geometry.fromJson(_12.toJson()));var _14;switch(_12.type){case "point":case "multipoint":_14=this.markerSymbol;_14.setOffset(0,0);_14.setAngle(0);var lyr=_11.getLayer();if(lyr){var _15=lyr._getSymbol(_11),_16,_17,_18=0,_19=0,_1a=0;if(_15){switch(_15.type){case "simplemarkersymbol":_16=_17=(_15.size||0);break;case "picturemarkersymbol":_16=(_15.width||0);_17=(_15.height||0);break;}_18=_15.xoffset||0;_19=_15.yoffset||0;_1a=_15.angle||0;}if(_16&&_17){_14._setDim(_16+1,_17+1,7);}_14.setOffset(_18,_19);_14.setAngle(_1a);}break;case "polyline":_14=this.lineSymbol;break;case "polygon":_14=this.fillSymbol;break;}_13.setSymbol(_14);},showClosestFirst:function(_1b){var _1c=this.features;if(_1c&&_1c.length){if(_1c.length>1){var i,_1d=Infinity,_1e=-1,_1f,_20=esri.geometry.getLength,_21;for(i=_1c.length-1;i>=0;i--){_1f=_1c[i].geometry;_21=0;try{_21=(_1f.type==="point")?_20(_1b,_1f):_20(_1b,_1f.getExtent().getCenter());}catch(e){}if(_21>0&&_21<_1d){_1d=_21;_1e=i;}}if(_1e>0){_1c.splice(0,0,_1c.splice(_1e,1)[0]);this.select(0);}}}else{if(this.deferreds){this._marked=_1b;}}},_unbind:function(dfd){var _22=_2.indexOf(this.deferreds,dfd);if(_22===-1){return;}this.deferreds.splice(_22,1);if(!this.deferreds.length){this.deferreds=null;return 2;}return 1;},_updateFeatures:function(dfd,_23){if(dfd){if(this.deferreds){var res=this._unbind(dfd);if(!res){return;}if(_23&&_23 instanceof Error){this.onDfdComplete(_23);if(res===2){this.onSetFeatures();}return;}if(_23&&_23.length){if(!this.features){this.features=_23;this.count=_23.length;this.selectedIndex=0;this.onDfdComplete();if(res===2){this.onSetFeatures();}this.select(0);}else{var _24=_2.filter(_23,function(_25){return _2.indexOf(this.features,_25)===-1;},this);this.features=this.features.concat(_24);this.count=this.features.length;this.onDfdComplete();if(res===2){this.onSetFeatures();}}}else{this.onDfdComplete();if(res===2){this.onSetFeatures();}}}}else{this.features=_23;this.count=_23.length;this.selectedIndex=0;this.onSetFeatures();this.select(0);}}});_2.declare("esri.PopupInfoTemplate",[esri.InfoTemplate],{"-chains-":{constructor:"manual"},initialize:function(_26){if(!_26){return;}this.info=_26;this.title=this.getTitle;this.content=this.getContent;var _27=(this._fieldLabels={}),_28=(this._fieldsMap={});if(_26.fieldInfos){_2.forEach(_26.fieldInfos,function(_29){_27[_29.fieldName]=_29.label;_28[_29.fieldName]=_29;});}},toJson:function(){return _2.fromJson(_2.toJson(this.info));},getTitle:function(){},getContent:function(){},getComponents:function(_2a){var _2b=this.info,_2c=_2a.getLayer(),_2d=_2.clone(_2a.attributes)||{},_2e=_2.clone(_2d),_2f=_2b.fieldInfos,_30="",_31="",_32,_33,_34,_35=_2c&&_2c._getDateOpts&&_2c._getDateOpts().properties,_36={dateFormat:{properties:_35,formatter:"DateFormat"+this._dateFormats["shortDateShortTime"]}};if(_2f){_2.forEach(_2f,function(_37){var _38=_37.fieldName,val=_2e[_38];_2e[_38]=this._formatValue(val,_38,_36);if(_35&&_37.format&&_37.format.dateFormat){var pos=_2.indexOf(_35,_38);if(pos>-1){_35.splice(pos,1);}}},this);}if(_2c){var _39=_2c.types,_3a=_2c.typeIdField,_3b=_3a&&_2d[_3a];for(_33 in _2d){_34=_2d[_33];if(esri._isDefined(_34)){var _3c=this._getDomainName(_2c,_39,_3b,_33,_34);if(esri._isDefined(_3c)){_2e[_33]=_3c;}else{if(_33===_3a){var _3d=this._getTypeName(_2c,_34);if(esri._isDefined(_3d)){_2e[_33]=_3d;}}}}}}if(_2b.title){_30=_2.trim(esri.substitute(_2e,this._fixTokens(_2b.title),_36)||"");}if(_2b.description){_31=_2.trim(esri.substitute(_2e,this._fixTokens(_2b.description),_36)||"");}if(_2f){_32=[];_2.forEach(_2f,function(_3e){_33=_3e.fieldName;if(_33&&_3e.visible){_32.push([_3e.label||_33,esri.substitute(_2e,"${"+_33+"}",_36)||""]);}});}var _3f,_40;if(_2b.mediaInfos){_3f=[];_2.forEach(_2b.mediaInfos,function(_41){_40=0;_34=_41.value;switch(_41.type){case "image":var url=_34.sourceURL;url=url&&_2.trim(esri.substitute(_2d,this._fixTokens(url)));_40=!!url;break;case "piechart":case "linechart":case "columnchart":case "barchart":_40=_2.some(_34.fields,function(_42){return esri._isDefined(_2d[_42]);});break;default:return;}if(_40){_41=_2.clone(_41);_34=_41.value;_41.title=_41.title?_2.trim(esri.substitute(_2e,this._fixTokens(_41.title),_36)||""):"";_41.caption=_41.caption?_2.trim(esri.substitute(_2e,this._fixTokens(_41.caption),_36)||""):"";if(_41.type==="image"){_34.sourceURL=esri.substitute(_2d,this._fixTokens(_34.sourceURL));if(_34.linkURL){_34.linkURL=_2.trim(esri.substitute(_2d,this._fixTokens(_34.linkURL))||"");}}else{var _43=_2d[_34.normalizeField]||0;_34.fields=_2.map(_34.fields,function(_44){var _45=_2d[_44];_45=(_45===undefined)?null:_45;if(_45&&_43){_45=_45/_43;}return {y:_45,tooltip:(this._fieldLabels[_44]||_44)+":<br/>"+this._formatValue(_45,_44,_36,!!_43)};},this);}_3f.push(_41);}},this);}return {title:_30,description:_31,fields:(_32&&_32.length)?_32:null,mediaInfos:(_3f&&_3f.length)?_3f:null,formatted:_2e,editSummary:(_2c&&_2c.getEditSummary)?_2c.getEditSummary(_2a):""};},getAttachments:function(_46){var _47=_46.getLayer(),_48=_46.attributes;if(this.info.showAttachments&&_47&&_47.hasAttachments&&_47.objectIdField){var oid=_48&&_48[_47.objectIdField];if(oid){return _47.queryAttachmentInfos(oid);}}},_dateFormats:{"shortDate":"(datePattern: 'M/d/y', selector: 'date')","longMonthDayYear":"(datePattern: 'MMMM d, y', selector: 'date')","dayShortMonthYear":"(datePattern: 'd MMM y', selector: 'date')","longDate":"(datePattern: 'EEEE, MMMM d, y', selector: 'date')","shortDateShortTime":"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')","shortDateShortTime24":"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')","longMonthYear":"(datePattern: 'MMMM y', selector: 'date')","shortMonthYear":"(datePattern: 'MMM y', selector: 'date')","year":"(datePattern: 'y', selector: 'date')"},_fixTokens:function(_49){return _49.replace(/(\{[^\{\r\n]+\})/g,"$$$1");},_formatValue:function(val,_4a,_4b,_4c){var _4d=this._fieldsMap[_4a],fmt=_4d&&_4d.format;if(!esri._isDefined(val)||!_4d||!esri._isDefined(fmt)){return val;}var _4e="",_4f=[],_50=fmt.hasOwnProperty("places")||fmt.hasOwnProperty("digitSeparator"),_51=fmt.hasOwnProperty("digitSeparator")?fmt.digitSeparator:true;if(_50){_4e="NumberFormat";_4f.push("places: "+((esri._isDefined(fmt.places)&&(!_4c||fmt.places>0))?Number(fmt.places):"Infinity"));if(_4f.length){_4e+=("("+_4f.join(",")+")");}}else{if(fmt.dateFormat){_4e="DateFormat"+(this._dateFormats[fmt.dateFormat]||this._dateFormats["shortDateShortTime"]);}else{return val;}}var _52=esri.substitute({"myKey":val},"${myKey:"+_4e+"}",_4b)||"";if(_50&&!_51){var _53=_2.i18n.getLocalization("dojo.cldr","number");if(_53.group){_52=_52.replace(new RegExp("\\"+_53.group,"g"),"");}}return _52;},_getDomainName:function(_54,_55,_56,_57,_58){var _59,_5a;if(_55&&esri._isDefined(_56)){_2.some(_55,function(_5b){if(_5b.id==_56){_59=_5b.domains&&_5b.domains[_57];if(_59&&_59.type==="inherited"){_59=this._getLayerDomain(_54,_57);_5a=true;}return true;}return false;},this);}if(!_5a&&!_59){_59=this._getLayerDomain(_54,_57);}if(_59&&_59.codedValues){var _5c;_2.some(_59.codedValues,function(_5d){if(_5d.code==_58){_5c=_5d.name;return true;}return false;});return _5c;}},_getLayerDomain:function(_5e,_5f){var _60=_5e.fields;if(_60){var _61;_2.some(_60,function(_62){if(_62.name===_5f){_61=_62.domain;return true;}return false;});return _61;}},_getTypeName:function(_63,id){var _64=_63.types;if(_64){var _65;_2.some(_64,function(_66){if(_66.id==id){_65=_66.name;return true;}return false;});return _65;}}});});