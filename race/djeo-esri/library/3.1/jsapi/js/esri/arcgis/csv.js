/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dojox/data/CsvStore"],function(_1,_2,_3){_2.provide("esri.arcgis.csv");_2.require("dojox.data.CsvStore");(function(){var _4=esri.arcgis.csv;_4.latFieldStrings=["lat","latitude","y","ycenter","latitude83","latdecdeg","POINT-Y"];_4.longFieldStrings=["lon","lng","long","longitude","x","xcenter","longitude83","longdecdeg","POINT-X"];_4.buildCSVFeatureCollection=function(_5){var _6=new _2.Deferred();var _7=function(_8){_6.callback(_8);};var _9=esri.request({url:_5.url,handleAs:"text",load:function(_a){_4._processCsvData(_a,_5,_2.hitch(this,_7));},error:function(_b){console.error("error: "+_b);}},{usePost:false});return _6;};_4.projectFeatureCollection=function(_c,_d){var _e=new _2.Deferred();var _f=function(_10){_e.callback(_10);};_4._projectFeatureSet(_c,new esri.SpatialReference({wkid:4326}),_d,_2.hitch(this,_f));return _e;};_4.generateDefaultPopupInfo=function(_11){var _12=_11.layerDefinition.fields;var _13={"esriFieldTypeDouble":1,"esriFieldTypeSingle":1};var _14={"esriFieldTypeInteger":1,"esriFieldTypeSmallInteger":1};var dt={"esriFieldTypeDate":1};var _15=null;var _16=_2.map(_12,_2.hitch(this,function(_17){if(_17.name.toUpperCase()==="NAME"){_15=_17.name;}var _18=(_17.type!=="esriFieldTypeOID"&&_17.type!=="esriFieldTypeGlobalID"&&_17.type!=="esriFieldTypeGeometry");var _19=null;if(_18){var f=_17.name.toLowerCase();var _1a=",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,";if(_1a.indexOf(","+f+",")>-1||f.indexOf("area")>-1||f.indexOf("length")>-1||f.indexOf("shape")>-1||f.indexOf("perimeter")>-1||f.indexOf("objectid")>-1||f.indexOf("_")===f.length-1||(f.indexOf("_i")===f.length-2&&f.length>1)){_18=false;}if(_17.type in _14){_19={places:0,digitSeparator:true};}else{if(_17.type in _13){_19={places:2,digitSeparator:true};}else{if(_17.type in dt){_19={dateFormat:"shortDateShortTime"};}}}}return _2.mixin({},{fieldName:_17.name,label:_17.alias,isEditable:true,tooltip:"",visible:_18,format:_19,stringFieldOption:"textbox"});}));var _1b={title:_15?"{"+_15+"}":"",fieldInfos:_16,description:null,showAttachments:false,mediaInfos:[]};return _1b;};_4._processCsvData=function(_1c,_1d,_1e){var _1f=_1c.indexOf("\n");var _20=_2.trim(_1c.substr(0,_1f));var _21=_1d.columnDelimiter;if(!_21){_21=_4._getSeparator(_20);}var _22=new _3.data.CsvStore({data:_1c,separator:_21});var _23=(_2.isIE<9)?750:1001;_22.fetch({start:0,count:_23,onComplete:function(_24,_25){var _26=0;var _27={"layerDefinition":_1d.layerDefinition,"featureSet":{"features":[],"geometryType":"esriGeometryPoint"}};var _28=_27.layerDefinition.objectIdField;if(!_28){if(!_2.some(_27.layerDefinition.fields,function(_29){if(_29.type=="esriFieldTypeOID"){_28=_29.name;return true;}return false;})){_27.layerDefinition.fields.push({"name":"__OBJECTID","alias":"__OBJECTID","type":"esriFieldTypeOID","editable":false,"domain":null});_28="__OBJECTID";}}var _2a,_2b;var _2c=_22._attributes;var _2d=[];var _2e=[];_2.forEach(_27.layerDefinition.fields,function(_2f,_30){if(_2f.type==="esriFieldTypeDate"){_2d.push(_2f.name);}else{if(_2f.type==="esriFieldTypeDouble"||_2f.type==="esriFieldTypeInteger"){_2e.push(_2f.name);}}});if(_1d.locationInfo&&_1d.locationInfo.locationType==="coordinates"){_2a=_1d.locationInfo.latitudeFieldName;_2b=_1d.locationInfo.longitudeFieldName;}else{_2.forEach(_2c,function(_31){var _32;_32=_2.indexOf(_4.latFieldStrings,_31.toLowerCase());if(_32!==-1){_2a=_31;}_32=_2.indexOf(_4.longFieldStrings,_31.toLowerCase());if(_32!==-1){_2b=_31;}},this);}if(!_2a||!_2b){setTimeout(function(){console.error("File does not seem to contain fields with point coordinates.");},1);return;}var i=0,il=_24.length;for(i;i<il;i++){if(_27.featureSet.features.length>=1000){setTimeout(function(){console.error("1000 feature limit reached. Unable to load any more data.");},1);break;}var _33=_24[i];var _34=_22.getAttributes(_33),_35={};_2.forEach(_34,function(_36,_37){if(_36){var _38=_36;if(_36.length===0){_2.forEach(_27.layerDefinition.fields,function(_39,idx){if(_39.name==="attribute_"+(idx-1)){_36="attribute_"+(idx-1);}});}if(_2.some(_2d,function(a){return a===_36;})){var val=_22.getValue(_33,_38),_3a=new Date(val);_35[_36]=_4._isValidDate(_3a,val)?_3a.getTime():null;}else{if(_2.some(_2e,function(a){return a===_36;})){var _3b=_2.number.parse(_22.getValue(_33,_38));if((_36==_2a||_36==_2b)&&(isNaN(_3b)||Math.abs(_3b)>181)){_3b=parseFloat(_22.getValue(_33,_38));if(isNaN(_3b)){_35[_36]=null;}else{_35[_36]=_3b;}}else{if(isNaN(_3b)){_35[_36]=null;}else{_35[_36]=_3b;}}}else{_35[_36]=_22.getValue(_33,_38);}}}});_35[_28]=_26;_26++;var _3c=_35[_2a];var _3d=_35[_2b];if(_3d==null||_3c==null||isNaN(_3c)||isNaN(_3d)){continue;}var _3e=new esri.geometry.Point(_3d,_3c,new esri.SpatialReference({wkid:4326}));var _3f={"geometry":_3e.toJson(),"attributes":_35};_27.featureSet.features.push(_3f);}_27.layerDefinition.name="csv";if(_1e){_1e(_27);}},onError:function(_40){console.error("Error fetching items from CSV store: ",_40);}});return true;};_4._getSeparator=function(_41){var _42=[","," ",";","|","\t"];var _43=0;var _44="";_2.forEach(_42,function(_45){var _46=_41.split(_45).length;if(_46>_43){_43=_46;_44=_45;}});return _44;};_4._isValidDate=function(d,_47){if(!d||Object.prototype.toString.call(d)!=="[object Date]"||isNaN(d.getTime())){return false;}var _48=true;if(_2.isChrome&&/\d+\W*$/.test(_47)){var _49=_47.match(/[a-zA-Z]{2,}/);if(_49){var _4a=false,i=0,len=_49.length,_4b=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;while(!_4a&&(i<=len)&&!(_4a=!_4b.test(_49[i]))){i++;}_48=!_4a;}}return _48;};_4._projectFeatureSet=function(_4c,_4d,_4e,_4f){if(!_4c.featureSet||_4c.featureSet.length===0){return;}if(_4._sameSpatialReference(_4e,_4d)){_4f(_4c);return;}var _50=function(_51){var _52=[];_2.forEach(_4c.featureSet.features,function(_53,i){if(_51[i]){_53.geometry=_51[i];_52.push(_53);}},this);_4f(_4c);};var _54=function(_55,_56){console.error("error projecting featureSet ("+_4c.layerDefinition.name+"). Try one more time.");_4._projectGeometries(_57,_4c.featureSet.geometryType,_4d,_4e,_2.hitch(this,_50),_2.hitch(this,_58));};var _58=function(_59,_5a){console.error("error projecting featureSet ("+_4c.layerDefinition.name+"). Final try.");_4f(_4c);};if(_4c.featureSet.features&&_4c.featureSet.features.length>0){var _57=[];_2.forEach(_4c.featureSet.features,function(_5b){_57.push(_5b.geometry);});_4._projectGeometries(_57,_4c.featureSet.geometryType,_4d,_4e,_2.hitch(this,_50),_2.hitch(this,_54));}else{_4f(_4c);}};_4._projectGeometries=function(_5c,_5d,_5e,_5f,_60,_61){if(_5c.length===0){_60(null);}var _62=esri.geometry.getGeometryType(_5d);var _63=[];_2.forEach(_5c,function(_64){var _65=new _62(_64);_65.spatialReference=_5e;_63.push(_65);},this);var _66=[102113,102100,3857];if(_5e.wkid&&_5e.wkid===4326&&_5f.wkid&&_2.indexOf(_66,_5f.wkid)>-1){_2.forEach(_63,function(_67){if(_67.xmin){_67.xmin=Math.max(_67.xmin,-180);_67.xmax=Math.min(_67.xmax,180);_67.ymin=Math.max(_67.ymin,-89.99);_67.ymax=Math.min(_67.ymax,89.99);}else{if(_67.rings){_2.forEach(_67.rings,function(_68){_2.forEach(_68,function(_69){_69[0]=Math.min(Math.max(_69[0],-180),180);_69[1]=Math.min(Math.max(_69[1],-89.99),89.99);},this);},this);}else{if(_67.paths){_2.forEach(_67.paths,function(_6a){_2.forEach(_6a,function(_6b){_6b[0]=Math.min(Math.max(_6b[0],-180),180);_6b[1]=Math.min(Math.max(_6b[1],-89.99),89.99);},this);},this);}else{if(_67.x){_67.x=Math.min(Math.max(_67.x,-180),180);_67.y=Math.min(Math.max(_67.y,-89.99),89.99);}}}}},this);_5c=[];_2.forEach(_63,function(_6c){var _6d=esri.geometry.geographicToWebMercator(_6c);if(_5f.wkid!==102100){_6d.spatialReference=_5f;}_5c.push(_6d.toJson());},this);_60(_5c);}else{if(_5e.wkid!==null&&_2.indexOf(_66,_5e.wkid)>-1&&_5f.wkid!==null&&_5f.wkid===4326){_5c=[];_2.forEach(_63,function(_6e){_5c.push(esri.geometry.webMercatorToGeographic(_6e).toJson());},this);_60(_5c);}else{var _6f=function(_70,_71){if(_70&&_70.length===_5c.length){_5c=[];_2.forEach(_70,function(_72){if(_72&&((_72.rings&&_72.rings.length>0&&_72.rings[0].length>0&&_72.rings[0][0].length>0&&!isNaN(_72.rings[0][0][0])&&!isNaN(_72.rings[0][0][1]))||(_72.paths&&_72.paths.length>0&&_72.paths[0].length>0&&_72.paths[0][0].length>0&&!isNaN(_72.paths[0][0][0])&&!isNaN(_72.paths[0][0][1]))||(_72.xmin&&!isNaN(_72.xmin)&&_72.ymin&&!isNaN(_72.ymin))||(_72.x&&!isNaN(_72.x)&&_72.y&&!isNaN(_72.y)))){_5c.push(_72.toJson());}else{_5c.push(null);}},this);_60(_5c);}else{_61(_70,_71);}};if(esri.config.defaults.geometryService){esri.config.defaults.geometryService.project(_63,_5f,_2.hitch(this,_6f),_61);}else{_60(null);}}}};_4._sameSpatialReference=function(sp1,sp2){var _73=[102113,102100,3857];if(sp1&&sp2&&sp1.wkid===sp2.wkid&&sp1.wkt===sp2.wkt){return true;}else{if(sp1&&sp2&&sp1.wkid&&sp2.wkid&&_2.indexOf(_73,sp1.wkid)>-1&&_2.indexOf(_73,sp2.wkid)>-1){return true;}}return false;};}());});