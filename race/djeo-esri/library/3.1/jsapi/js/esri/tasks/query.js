/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/tasks/_task,esri/_time"],function(_1,_2,_3){_2.provide("esri.tasks.query");_2.require("esri.tasks._task");_2.require("esri._time");_2.declare("esri.tasks.QueryTask",esri.tasks._Task,{constructor:function(_4,_5){this._handler=_2.hitch(this,this._handler);this._relationshipQueryHandler=_2.hitch(this,this._relationshipQueryHandler);this._executeForIdsHandler=_2.hitch(this,this._executeForIdsHandler);this._countHandler=_2.hitch(this,this._countHandler);this.source=_5&&_5.source;this.gdbVersion=_5&&_5.gdbVersion;},__msigns:[{n:"execute",c:4,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForIds",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForCount",c:3,a:[{i:0,p:["geometry"]}],e:2}],onComplete:function(){},onExecuteRelationshipQueryComplete:function(){},onExecuteForIdsComplete:function(){},onExecuteForCountComplete:function(){},execute:function(_6,_7,_8,_9,_a){var _b=_a.assembly,_c=this._encode(_2.mixin({},this._url.query,{f:"json"},_6.toJson(_b&&_b[0]))),_d=this._handler,_e=this._errorHandler;if(this.source){var _f={source:this.source.toJson()};_c.layer=_2.toJson(_f);}if(this.gdbVersion){_c.gdbVersion=this.gdbVersion;}return esri.request({url:this._url.path+"/query",content:_c,callbackParamName:"callback",load:function(r,i){_d(r,i,_7,_8,_a.dfd);},error:function(r){_e(r,_8,_a.dfd);},callbackSuffix:_9});},executeRelationshipQuery:function(_10,_11,_12){var _13=this._encode(_2.mixin({},this._url.query,{f:"json"},_10.toJson())),_14=this._relationshipQueryHandler,_15=this._errorHandler;if(this.gdbVersion){_13.gdbVersion=this.gdbVersion;}var dfd=new _2.Deferred(esri._dfdCanceller);dfd._pendingDfd=esri.request({url:this._url.path+"/queryRelatedRecords",content:_13,callbackParamName:"callback",load:function(r,i){_14(r,i,_11,_12,dfd);},error:function(r){_15(r,_12,dfd);}});return dfd;},executeForIds:function(_16,_17,_18,_19){var _1a=_19.assembly,_1b=this._encode(_2.mixin({},this._url.query,{f:"json",returnIdsOnly:true},_16.toJson(_1a&&_1a[0]))),_1c=this._executeForIdsHandler,_1d=this._errorHandler;if(this.source){var _1e={source:this.source.toJson()};_1b.layer=_2.toJson(_1e);}if(this.gdbVersion){_1b.gdbVersion=this.gdbVersion;}return esri.request({url:this._url.path+"/query",content:_1b,callbackParamName:"callback",load:function(r,i){_1c(r,i,_17,_18,_19.dfd);},error:function(r){_1d(r,_18,_19.dfd);}});},executeForCount:function(_1f,_20,_21,_22){var _23=_22.assembly,_24=this._encode(_2.mixin({},this._url.query,{f:"json",returnIdsOnly:true,returnCountOnly:true},_1f.toJson(_23&&_23[0]))),_25=this._countHandler,_26=this._errorHandler;if(this.source){var _27={source:this.source.toJson()};_24.layer=_2.toJson(_27);}if(this.gdbVersion){_24.gdbVersion=this.gdbVersion;}return esri.request({url:this._url.path+"/query",content:_24,callbackParamName:"callback",load:function(r,i){_25(r,i,_20,_21,_22.dfd);},error:function(r){_26(r,_21,_22.dfd);}});},_handler:function(_28,io,_29,_2a,dfd){try{var _2b=new esri.tasks.FeatureSet(_28);this._successHandler([_2b],"onComplete",_29,dfd);}catch(err){this._errorHandler(err,_2a,dfd);}},_relationshipQueryHandler:function(_2c,io,_2d,_2e,dfd){try{var gt=_2c.geometryType,sr=_2c.spatialReference,_2f={};_2.forEach(_2c.relatedRecordGroups,function(gr){var _30={};_30.geometryType=gt;_30.spatialReference=sr;_30.features=gr.relatedRecords;var _31=new esri.tasks.FeatureSet(_30);_2f[gr.objectId]=_31;});this._successHandler([_2f],"onExecuteRelationshipQueryComplete",_2d,dfd);}catch(err){this._errorHandler(err,_2e,dfd);}},_executeForIdsHandler:function(_32,io,_33,_34,dfd){try{this._successHandler([_32.objectIds],"onExecuteForIdsComplete",_33,dfd);}catch(err){this._errorHandler(err,_34,dfd);}},_countHandler:function(_35,io,_36,_37,dfd){try{var _38,_39=_35.features,ids=_35.objectIds;if(ids){_38=ids.length;}else{if(_39){throw new Error(esri.bundle.tasks.query.invalid);}else{_38=_35.count;}}this._successHandler([_38],"onExecuteForCountComplete",_36,dfd);}catch(err){this._errorHandler(err,_37,dfd);}}});esri._createWrappers("esri.tasks.QueryTask");_2.declare("esri.tasks.Query",null,{constructor:function(){this.spatialRelationship=esri.tasks.Query.SPATIAL_REL_INTERSECTS;},text:null,where:"",geometry:null,groupByFieldsForStatistics:null,objectIds:null,returnGeometry:false,orderByFields:null,outSpatialReference:null,outFields:null,outStatistics:null,timeExtent:null,relationParam:null,toJson:function(_3a){var _3b={text:this.text,where:this.where,returnGeometry:this.returnGeometry,spatialRel:this.spatialRelationship,maxAllowableOffset:this.maxAllowableOffset,geometryPrecision:this.geometryPrecision},g=_3a&&_3a["geometry"]||this.geometry,ids=this.objectIds,_3c=this.outFields,_3d=this.outSpatialReference,_3e=this.groupByFieldsForStatistics,_3f=this.orderByFields,_40=this.outStatistics;if(g){_3b.geometry=g;_3b.geometryType=esri.geometry.getJsonType(g);_3b.inSR=g.spatialReference.wkid||_2.toJson(g.spatialReference.toJson());}if(ids){_3b.objectIds=ids.join(",");}if(_3c){_3b.outFields=_3c.join(",");}if(_3e){_3b.groupByFieldsForStatistics=_3e.join(",");}if(_3f){_3b.orderByFields=_3f.join(",");}if(_40){var _41=[];_2.forEach(_40,function(_42,idx){_41.push(_42.toJson());});_3b.outStatistics=_2.toJson(_41);}if(_3d!==null){_3b.outSR=_3d.wkid||_2.toJson(_3d.toJson());}else{if(g){_3b.outSR=g.spatialReference.wkid||_2.toJson(g.spatialReference.toJson());}}var _43=this.timeExtent;_3b.time=_43?_43.toJson().join(","):null;var _44=this.relationParam;if(_44&&this.spatialRelationship===esri.tasks.Query.SPATIAL_REL_RELATION){_3b.relationParam=_44;}_3b._ts=this._ts;return _3b;}});_2.mixin(esri.tasks.Query,esri.tasks._SpatialRelationship);_2.declare("esri.tasks.RelationshipQuery",null,{definitionExpression:"",relationshipId:null,returnGeometry:false,objectIds:null,outSpatialReference:null,outFields:null,toJson:function(){var _45={definitionExpression:this.definitionExpression,relationshipId:this.relationshipId,returnGeometry:this.returnGeometry,maxAllowableOffset:this.maxAllowableOffset,geometryPrecision:this.geometryPrecision},_46=this.objectIds,_47=this.outFields,_48=this.outSpatialReference;if(_46){_45.objectIds=_46.join(",");}if(_47){_45.outFields=_47.join(",");}if(_48){_45.outSR=_48.toJson();}_45._ts=this._ts;return _45;}});_2.declare("esri.tasks.StatisticDefinition",null,{statisticType:null,onStatisticField:null,outStatisticFieldName:null,toJson:function(){var _49={statisticType:this.statisticType,onStatisticField:this.onStatisticField};if(this.outStatisticFieldName){_49.outStatisticFieldName=this.outStatisticFieldName;}return _49;}});});