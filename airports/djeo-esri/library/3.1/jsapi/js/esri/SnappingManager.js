/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!esri/tasks/query"],function(_1,_2,_3){_2.provide("esri.SnappingManager");_2.require("esri.tasks.query");_2.declare("esri.SnappingManager",null,{constructor:function(_4){_4=_4||{};if(!_4.map){console.error("map is not specified for SnappingManager");}this.map=_4.map;this.tolerance=_4.tolerance||15;this.layerInfos=[];if(_4.layerInfos){this.layerInfos=_4.layerInfos;}else{var i;for(i=0;i<this.map.graphicsLayerIds.length;i++){var _5=this.map.getLayer(this.map.graphicsLayerIds[i]);this.layerInfos.push({"layer":_5});}this.layerInfos.push({"layer":this.map.graphics});}if(_4.snapPointSymbol){this.snapPointSymbol=_4.snapPointSymbol;}else{this.snapPointSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CROSS,15,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new _2.Color([0,255,255]),1),new _2.Color([0,255,0,0]));}if(_4.alwaysSnap){this.alwaysSnap=_4.alwaysSnap;}else{this.alwaysSnap=false;}if(_4.snapKey){this.snapKey=_4.snapKey;}else{this.snapKey=_2.keys.copyKey;}this._SelectionLyrQuery=new esri.tasks.Query();this._SelectionLyrQuery.spatialRelationship=esri.tasks.Query.SPATIAL_REL_INTERSECTS;this._snappingGraphic=new esri.Graphic();this.setLayerInfos(this.layerInfos);this._currentGraphicOption={snapToPoint:true,snapToVertex:true,snapToEdge:true};this._snappingCallback=_2.hitch(this,this._snappingCallback);},getSnappingPoint:function(_6){var _7=this.layers,_8=this.tolerance,_9=this.map,_a=this.layerOptions,_b=_9.toMap(_6.offset(-_8,_8)),_c=_9.toMap(_6.offset(_8,-_8)),_d=new esri.geometry.Extent(_b.x,_b.y,_c.x,_c.y,_9.spatialReference),_e=new esri.tasks.Query();_e.geometry=_d;_e.spatialRelationship=esri.tasks.Query.SPATIAL_REL_INTERSECTS;var _f=[],_10=[],_11,_12=this._extractPointsAndLines,_13=new _2.Deferred(),_14=this._nonSelectionLayerCount,_15,_16=_d.xmin,_17=_d.xmax;if(_9.spatialReference._isWrappable()){_16=esri.geometry.Extent.prototype._normalizeX(_d.xmin,_9.spatialReference._getInfo()).x;_17=esri.geometry.Extent.prototype._normalizeX(_d.xmax,_9.spatialReference._getInfo()).x;}var _18=new esri.geometry.Extent(_16,_d.ymin,_17,_d.ymax,_9.spatialReference);_2.forEach(_7,function(_19,idx){if(_19.declaredClass==="esri.layers.GraphicsLayer"&&_19.visible){var _1a=[];_2.forEach(_19.graphics,function(_1b){if(_1b){if(_1b.visible&&_18.intersects(_1b.geometry)){_1a.push(_1b);}}});var _1c=_12(_1a,_a[idx]);_f=_f.concat(_1c[0]);_10=_10.concat(_1c[1]);}});var _1d=_2.hitch(this,function(_1e){_14--;if(_1e instanceof Error){var msg="getSnappingPoint: query features failed";console.log(msg);}else{var _1f=_12(_1e.features,_a[_15]);_f=_f.concat(_1f[0]);_10=_10.concat(_1f[1]);}if(!_14){_11=this._getSnappingPoint(_f,_10,_6);_13.callback(_11);}});var _20=false;_2.forEach(_7,function(_21,idx){if(_21.visible&&_21.loaded){_15=idx;if((_21.declaredClass==="esri.layers.FeatureLayer")&&_21.mode!==esri.layers.FeatureLayer.MODE_SELECTION){_20=true;_21.queryFeatures(_e,_1d,_1d);}}});if(!_20){_11=this._getSnappingPoint(_f,_10,_6);_13.callback(_11);}return _13;},setLayerInfos:function(_22){this.layers=[];this.layerOptions=[];var i;for(i=0;i<_22.length;i++){this.layers.push(_22[i].layer);this.layerOptions.push({snapToPoint:true,snapToVertex:true,snapToEdge:true});if(_22[i].snapToPoint===false){this.layerOptions[i].snapToPoint=_22[i].snapToPoint;}if(_22[i].snapToVertex===false){this.layerOptions[i].snapToVertex=_22[i].snapToVertex;}if(_22[i].snapToEdge===false){this.layerOptions[i].snapToEdge=_22[i].snapToEdge;}}this._nonSelectionLayerCount=0;this._featurePtsFromSelectionLayer=[];this._featureLinesFromSelectionLayer=[];this._selectionLayers=[];this._selectionLayerOptions=[];_2.forEach(this.layers,function(_23,idx){if(_23.declaredClass==="esri.layers.FeatureLayer"){if(_23.mode===esri.layers.FeatureLayer.MODE_SELECTION){this._selectionLayers.push(_23);this._selectionLayerOptions.push(this.layerOptions[idx]);}else{this._nonSelectionLayerCount++;}}},this);this.layerInfos=_22;},destroy:function(){_2.disconnect(this._onExtentChangeConnect);this._killOffSnapping();this._featurePtsFromSelectionLayer=this._featureLinesFromSelectionLayer=this._currentFeaturePts=this._currentFeatureLines=this.layers=this.map=null;},_startSelectionLayerQuery:function(){_2.disconnect(this._onExtentChangeConnect);this._mapExtentChangeHandler(this._selectionLayers,this._selectionLayerOptions,this.map.extent);this._onExtentChangeConnect=_2.connect(this.map,"onExtentChange",_2.hitch(this,"_mapExtentChangeHandler",this._selectionLayers,this._selectionLayerOptions));},_stopSelectionLayerQuery:function(){_2.disconnect(this._onExtentChangeConnect);},_mapExtentChangeHandler:function(_24,_25,_26){this._featurePtsFromSelectionLayer=[];this._featureLinesFromSelectionLayer=[];var _27;this._SelectionLyrQuery.geometry=_26;var _28=_2.hitch(this,function(_29){if(_29 instanceof Error){var msg="getSnappingPoint: query features failed";console.log(msg);}else{var _2a=this._extractPointsAndLines(_29.features,_25[_27]);this._featurePtsFromSelectionLayer=this._featurePtsFromSelectionLayer.concat(_2a[0]);this._featureLinesFromSelectionLayer=this._featureLinesFromSelectionLayer.concat(_2a[1]);}});_2.forEach(_24,function(_2b,idx){if(_2b.visible&&_2b.loaded){_27=idx;_2b.queryFeatures(this._SelectionLyrQuery,_28,_28);}},this);},_extractPointsAndLines:function(_2c,_2d){var _2e=[],_2f=[];var i,j;_2.forEach(_2c,function(_30,idx){if(_30.visible&&_30.geometry){if(_30.geometry.type==="point"&&_2d.snapToPoint){_2e.push(_30.geometry);}else{if(_30.geometry.type==="polyline"){for(i=0;i<_30.geometry.paths.length;i++){_2f.push("lineStart");for(j=0;j<_30.geometry.paths[i].length;j++){var _31=_30.geometry.getPoint(i,j);if(_2d.snapToVertex){_2e.push(_31);}if(_2d.snapToEdge){_2f.push(_31);}}_2f.push("lineEnd");}}else{if(_30.geometry.type==="polygon"){for(i=0;i<_30.geometry.rings.length;i++){_2f.push("lineStart");for(j=0;j<_30.geometry.rings[i].length;j++){var _32=_30.geometry.getPoint(i,j);if(_2d.snapToVertex){_2e.push(_32);}if(_2d.snapToEdge){_2f.push(_32);}}_2f.push("lineEnd");}}}}}});return [_2e,_2f];},_getSnappingPoint:function(_33,_34,_35){var _36,_37,_38=this.tolerance;var map=this.map;var _39=this.map._getFrameWidth();_33=_33.concat(this._featurePtsFromSelectionLayer);_34=_34.concat(this._featureLinesFromSelectionLayer);if(this._currentGraphic){var _3a=this._extractPointsAndLines([this._currentGraphic],this._currentGraphicOption);_33=_33.concat(_3a[0]);_34=_34.concat(_3a[1]);}var _3b,_3c;_2.forEach(_33,function(pt,idx){var _3d=map.toScreen(pt,true);if(_39!==-1){_3d.x=_3d.x%_39;if(_3d.x<0){_3d.x+=_39;}if(map.width>_39){var _3e=(map.width-_39)/2;while(_3d.x<_3e){_3d.x+=_39;}}}_36=Math.sqrt((_3d.x-_35.x)*(_3d.x-_35.x)+(_3d.y-_35.y)*(_3d.y-_35.y));if(_36<=_38){_38=_36;_3b=_3d.x;_3c=_3d.y;}});if(_3b){var _3f=new esri.geometry.Point(_3b,_3c);_3f=map.toMap(_3f);_37=_3f;}else{var _40,_41,i,j;_38=this.tolerance;for(i=0;i<_34.length;i++){if(_34[i]==="lineStart"){for(j=i+1;j<_34.length;j++){if(_34[j+1]!=="lineEnd"&&_34[j+1]!=="lineStart"&&_34[j]!=="lineEnd"&&_34[j]!=="lineStart"){var _42=map.toScreen(_34[j],true),_43=map.toScreen(_34[j+1],true),_44=(_42.x>=_43.x)?_42:_43,_45=(_42.x>=_43.x)?_43:_42;if(_39!==-1){_44.x=_44.x%_39;if(_44.x<0){_44.x+=_39;}_45.x=_45.x%_39;if(_45.x<0){_45.x+=_39;}if(_45.x>_44.x){_45.x-=_39;}}var x1=_44.x,y1=_44.y,x2=_45.x,y2=_45.y;var _46,_47,_48,_49,_4a,_4b;if(x1===x2){_46=x1;_47=_35.y;_48=_49=x1;_4a=(y1<=y2)?y1:y2;_4b=(y1<=y2)?y2:y1;}else{if(y1===y2){_46=_35.x;_47=y1;_48=(x1<=x2)?x1:x2;_49=(x1<=x2)?x2:x1;_4a=_4b=y1;}else{var a=(y2-y1)/(x2-x1),b=(y1*x2-x1*y2)/(x2-x1),_4c=(x1-x2)/(y2-y1),_4d=(_35.y*y2-_35.y*y1-_35.x*x1+_35.x*x2)/(y2-y1);_46=(b-_4d)/(_4c-a);_47=a*_46+b;_48=(x1<=x2)?x1:x2;_49=(x1<=x2)?x2:x1;_4a=(y1<=y2)?y1:y2;_4b=(y1<=y2)?y2:y1;}}if(_46>=_48&&_46<=_49&&_47>=_4a&&_47<=_4b){var _4e=Math.sqrt((_35.x-_46)*(_35.x-_46)+(_35.y-_47)*(_35.y-_47));if(_4e<=_38){_38=_4e;_40=_46;_41=_47;}}else{var _4f=Math.sqrt((x1-_35.x)*(x1-_35.x)+(y1-_35.y)*(y1-_35.y));var _50=Math.sqrt((x2-_35.x)*(x2-_35.x)+(y2-_35.y)*(y2-_35.y));var _51;if(_4f<=_50){_51=_4f;_46=x1;_47=y1;}else{_51=_50;_46=x2;_47=y2;}if(_51<=_38){_38=_51;_40=_46;_41=_47;}}}if(_34[j]==="lineEnd"){i=j;break;}}}}if(_40){var _52=new esri.geometry.Point(_40,_41);_52=map.toMap(_52);_37=_52;}}return _37;},_setGraphic:function(_53){this._currentGraphic=_53;},_addSnappingPointGraphic:function(){var map=this.map;var _54=this.snapPointSymbol;this._snappingGraphic.setSymbol(_54);map.graphics.add(this._snappingGraphic);},_setUpSnapping:function(){var map=this.map;this._onSnapKeyDown_connect=_2.connect(map,"onKeyDown",this,"_onSnapKeyDownHandler");this._onSnapKeyUp_connect=_2.connect(map,"onKeyUp",this,"_onSnapKeyUpHandler");this._onSnappingMouseMove_connect=_2.connect(map,"onMouseMove",this,"_onSnappingMouseMoveHandler");this._onSnappingMouseDrag_connect=_2.connect(map,"onMouseDrag",this,"_onSnappingMouseMoveHandler");if(this.alwaysSnap){this._activateSnapping();}},_killOffSnapping:function(){_2.disconnect(this._onSnapKeyDown_connect);_2.disconnect(this._onSnapKeyUp_connect);_2.disconnect(this._onSnappingMouseMove_connect);_2.disconnect(this._onSnappingMouseDrag_connect);this._deactivateSnapping();},_onSnapKeyDownHandler:function(evt){if(evt.keyCode===this.snapKey){_2.disconnect(this._onSnapKeyDown_connect);if(this.alwaysSnap){this._deactivateSnapping();}else{this._activateSnapping();}}},_activateSnapping:function(){this._snappingActive=true;this._addSnappingPointGraphic();if(this._currentLocation){this._onSnappingMouseMoveHandler(this._currentLocation);}},_onSnapKeyUpHandler:function(evt){if(evt.keyCode===this.snapKey){this._onSnapKeyDown_connect=_2.connect(this.map,"onKeyDown",this,"_onSnapKeyDownHandler");if(this.alwaysSnap){this._activateSnapping();}else{this._deactivateSnapping();}}},_deactivateSnapping:function(){this._snappingActive=false;this._snappingPoint=null;this.map.graphics.remove(this._snappingGraphic);this._snappingGraphic.setGeometry(null);},_onSnappingMouseMoveHandler:function(evt){this._currentLocation=evt;this._snappingPoint=null;if(this._snappingActive){this._snappingGraphic.hide();var _55=this.getSnappingPoint(evt.screenPoint);_55.addCallback(this._snappingCallback);}},_snappingCallback:function(_56){this._snappingPoint=_56;if(_56){this._snappingGraphic.show();this._snappingGraphic.setGeometry(_56);}}});});