/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dojox/collections/ArrayList,esri/layers/layer,esri/geometry,dojox/gfx/matrix"],function(_1,_2,_3){_2.provide("esri.layers.tiled");_2.require("dojox.collections.ArrayList");_2.require("esri.layers.layer");_2.require("esri.geometry");_2.require("dojox.gfx.matrix");_2.declare("esri.layers.TiledMapServiceLayer",esri.layers.Layer,{constructor:function(_4,_5){_2.connect(this,"onLoad",this,"_initTiledLayer");this._displayLevels=_5?_5.displayLevels:null;var dh=_2.hitch;this._addImage=dh(this,this._addImage);this._tileLoadHandler=dh(this,this._tileLoadHandler);this._tileErrorHandler=dh(this,this._tileErrorHandler);this._tilePopPop=dh(this,this._tilePopPop);this._cleanUpRemovedImages=dh(this,this._cleanUpRemovedImages);this._fireOnUpdateEvent=dh(this,this._fireOnUpdateEvent);this._transitionEnd=dh(this,this._transitionEnd);},opacity:1,isPNG32:false,_initTiledLayer:function(){var ti=this.tileInfo,_6=ti.lods;this._tileW=ti.width;this._tileH=ti.height;var _7=(this.scales=[]),dl=this._displayLevels,_8=(this.declaredClass==="esri.layers.WMTSLayer"&&ti.dpi!=96),_9=-Infinity,_a=Infinity,fe=this.fullExtent,ul=new esri.geometry.Point(fe.xmin,fe.ymax),lr=new esri.geometry.Point(fe.xmax,fe.ymin),_b=esri.TileUtils.getContainingTileCoords,_c,_d,i,_e=_6.length;for(i=0;i<_e;i++){_d=_6[i];if(_8){_d.scale=_d.scale*96/ti.dpi;}_c=_b(ti,ul,_d);_d.startTileRow=_c.row<0?0:_c.row;_d.startTileCol=_c.col<0?0:_c.col;_c=_b(ti,lr,_d);_d.endTileRow=_c.row;_d.endTileCol=_c.col;if(!dl||_2.indexOf(dl,_d.level)!==-1){_7[i]=_d.scale;_9=(_d.scale>_9)?_d.scale:_9;_a=(_d.scale<_a)?_d.scale:_a;}}if(_8){ti.dpi=96;}if(_9!==-Infinity&&!this._hasMin){this.setMinScale(_9);}if(_a!==Infinity&&!this._hasMax){this.setMaxScale(_a);}this._patchIE=_2.isIE>=6&&_2.isIE<7&&(this.isPNG32||ti.format==="Mixed");},_isMapAtVisibleScale:function(){var _f=this.inherited(arguments);if(_f){var i,map=this._map,_10=this.scales,_11=map.getScale(),_12=false,_13=(map.width>map.height)?map.width:map.height;for(i=0;i<_10.length;i++){if((Math.abs(_10[i]-_11)/_10[i])<(1/_13)){_12=true;break;}}_f=_12;}return _f;},_setMap:function(map,_14,_15,lod){this.inherited(arguments);this._map=map;var d=(this._div=_2.create("div",null,_14)),_16=map.__visibleDelta,dc=_2.connect,_17=esri._css.names,css={position:"absolute",width:map.width+"px",height:map.height+"px",overflow:"visible"};if(map.navigationMode==="css-transforms"){css[_17.transform]=esri._css.translate(-_16.x,-_16.y);_2.style(d,css);delete css[_17.transform];css[_17.transition]=_17.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease";_2.style((this._active=_2.create("div",null,d)),css);this._active._remove=0;this._passives=[];}else{css.left=-_16.x+"px";css.top=-_16.y+"px";_2.style(d,css);}this._onResizeHandler_connect=dc(map,"onResize",this,"_onResizeHandler");this._opacityChangeHandler_connect=dc(this,"onOpacityChange",this,"_opacityChangeHandler");var _18=this.tileInfo,sr=_18.spatialReference,_19=sr._getInfo();this._wrap=map.wrapAround180&&sr._isWrappable()&&Math.abs(_19.origin[0]-_18.origin.x)<=_19.dx;if(this._wrap){esri.TileUtils._addFrameInfo(_18,_19);}this.evaluateSuspension();if(this.suspended&&!map.loaded){var _1a=_2.connect(map,"onLoad",this,function(){_2.disconnect(_1a);_1a=null;this.evaluateSuspension();});}return d;},_unsetMap:function(map,_1b){if(!this.suspended){this._suspendImpl();}_2.destroy(this._div);this._map=this._div=null;var dd=_2.disconnect;dd(this._onResizeHandler_connect);dd(this._opacityChangeHandler_connect);this.inherited(arguments);},onSuspend:function(){this.inherited(arguments);this._suspendImpl();},_suspendImpl:function(){esri.hide(this._div);clearTimeout(this._wakeTimer);this._wakeTimer=null;this._disableDrawConnectors();var _1c=this._tiles,_1d=this._tileIds,_1e=this._loadingList,img,i,id,_1f=_2.disconnect,_20=_2.destroy;if(_1e&&_1e.count>0){_1e.forEach(function(_21){img=_1c[_21];if(img){_1f(img._onload_connect);_1f(img._onerror_connect);_1f(img._onabort_connect);img._onload_connect=img._onerror_connect=img._onabort_connect=null;}});_1e.clear();this._fireUpdateEnd();}this._removeList.clear();for(i=_1d.length-1;i>=0;i--){id=_1d[i];img=id&&_1c[id];if(img){_20(img);}}if(this._map.navigationMode==="css-transforms"){var _22=this._active,_23=this._passives,_24;this._noDom=0;for(i=_23.length-1;i>=0;i--){_24=_23[i];if(_24._endHandle){_1f(_24._endHandle);}_24._matrix=_24._multiply=_24._endHandle=null;_24._marked=_24._remove=0;_23.splice(i,1);_20(_24);}_22._matrix=_22._multiply=null;_22._marked=_22._remove=0;}this._tileIds=this._tiles=this._tileBounds=this._ct=this._loadingList=this._removeList=this._standby=null;},onResume:function(){this.inherited(arguments);this._tileIds=[];this._tiles=[];this._tileBounds=[];this._ct=null;this._removeList=new _3.collections.ArrayList();this._loadingList=new _3.collections.ArrayList();esri.show(this._div);this._enableDrawConnectors();this._wakeTimer=this._wakeTimer||setTimeout(_2.hitch(this,function(){if(!this.suspended){this._onExtentChangeHandler(this._map.extent,null,true,this._map.__LOD);}}),0);},_enableDrawConnectors:function(){var map=this._map,_25=_2.connect;if(map.navigationMode==="css-transforms"){this._onScaleHandler_connect=_25(map,"onScale",this,this._onScaleHandler);if(esri.isTouchEnabled){this._standby=[];var _26=this,_27=function(){_26._noDom=1;};this._onPanStartHandler_connect=_25(map,"onPanStart",_27);this._onZoomStartHandler_connect=_25(map,"onZoomStart",_27);}}else{this._onZoomHandler_connect=_25(map,"onZoom",this,"_onZoomHandler");}this._onPanHandler_connect=_25(map,"onPan",this,"_onPanHandler");this._onExtentChangeHandler_connect=_25(map,"onExtentChange",this,"_onExtentChangeHandler");},_disableDrawConnectors:function(){var _28=_2.disconnect;_28(this._onPanHandler_connect);_28(this._onZoomHandler_connect);_28(this._onScaleHandler_connect);_28(this._onExtentChangeHandler_connect);_28(this._onPanStartHandler_connect);_28(this._onZoomStartHandler_connect);this._onPanHandler_connect=this._onZoomHandler_connect=this._onScaleHandler_connect=this._onExtentChangeHandler_connect=this._onPanStartHandler_connect=this._onZoomStartHandler_connect=null;},_onResizeHandler:function(_29,_2a,_2b){var css={width:_2a+"px",height:_2b+"px"},ds=_2.style,i;ds(this._div,css);if(this._map.navigationMode==="css-transforms"){if(this._active){ds(this._active,css);}for(i=this._passives.length-1;i>=0;i--){ds(this._passives[i],css);}}},_onExtentChangeHandler:function(_2c,_2d,_2e,lod){var map=this._map,i,_2f=this._standby,img,_30;clearTimeout(this._wakeTimer);this._wakeTimer=null;if(map._isPanningOrZooming()){return;}if(map.navigationMode==="css-transforms"){if(_2e){for(i=this._passives.length-1;i>=0;i--){_30=this._passives[i];_2.style(_30,esri._css.names.transition,"none");if(_30._marked){this._passives.splice(i,1);if(_30.parentNode){_30.parentNode.removeChild(_30);}_2.destroy(_30);}else{if(_30.childNodes.length>0){_30._multiply=_30._multiply?_3.gfx.matrix.multiply(_30._matrix,_30._multiply):_30._matrix;}}}}this._noDom=0;if(_2f&&_2f.length){for(i=_2f.length-1;i>=0;i--){img=_2f[i];_2.style(img,"visibility","visible");this._tilePopPop(img);_2f.splice(i,1);}}}this._fireUpdateStart();this._rrIndex=0;var ct=esri.TileUtils.getCandidateTileInfo(map,this.tileInfo,_2c),mv=map.__visibleDelta,id;if(!this._ct||ct.lod.level!==this._ct.lod.level||_2e){var _31=(ct&&this._ct&&ct.lod.level!==this._ct.lod.level);this._ct=ct;var _32=this._tiles,_33=this._tileIds,_34=this._tileBounds,_35=this._removeList,_36,il=_33.length;this._cleanUpRemovedImages();for(i=0;i<il;i++){id=_33[i];_36=_32[id];_34[id]=_33[i]=null;if((map.navigationMode==="css-transforms")&&_31&&_36.parentNode&&map.fadeOnZoom){_36._fadeOut=_31;_36.parentNode._remove++;}_35.add(_36);}if(_2e){this._tileIds=[];this._tiles=[];this._tileBounds=[];}}var mx=mv.x,my=mv.y;if(map.navigationMode==="css-transforms"){var css={};css[esri._css.names.transform]=esri._css.translate(mx,my);_2.style(this._div,css);}else{_2.style(this._div,{left:mx+"px",top:my+"px"});}this.__coords_dx=mx;this.__coords_dy=my;this._updateImages(new esri.geometry.Rect(0,0,mv.width,mv.height));if(this._loadingList.count===0){this.onUpdate();this._fireUpdateEnd();}else{this._fireOnUpdate=true;}var _37,_38,_39=this._tileW,_3a=this._tileH;mv=new esri.geometry.Rect(-mv.x,-mv.y,mv.width,mv.height);for(i=this._tileIds.length-1;i>=0;i--){id=this._tileIds[i];if(id){img=this._tiles[id];_37=_2.coords(img);_38=new esri.geometry.Rect(_37.l,_37.t,_39,_3a);if(map.navigationMode==="css-transforms"){_38.x=img._left;_38.y=img._top;}if(mv.intersects(_38)){this._tileBounds[id]=_38;}else{if(this._loadingList.contains(id)){this._tilePopPop(img);}_2.destroy(img);this._tileIds.splice(i,1);delete this._tileBounds[id];delete this._tiles[id];}}else{this._tileIds.splice(i,1);delete this._tileBounds[id];delete this._tiles[id];}}},_onPanHandler:function(_3b,_3c){var map=this._map,mv=map.__visibleDelta.offset(_3c.x,_3c.y);this.__coords_dx=this.__coords_dy=0;if(map.navigationMode==="css-transforms"){var css={};css[esri._css.names.transform]=esri._css.translate(mv.x,mv.y);_2.style(this._div,css);if(!esri.isTouchEnabled){this._updateImages({x:-mv.x,y:-mv.y,width:mv.width,height:mv.height});}}else{_2.style(this._div,{left:mv.x+"px",top:mv.y+"px"});this._updateImages({x:-mv.x,y:-mv.y,width:mv.width,height:mv.height});}if(this._loadingList.count>0){this._fireUpdateStart();this._fireOnUpdate=true;}},_onScaleHandler:function(mtx,_3d){var i,css={},_3e=esri._css.names,map=this._map;for(i=this._passives.length-1;i>=0;i--){var _3f=this._passives[i];if(_3f.childNodes.length===0){this._passives.splice(i,1);_2.destroy(_3f);}else{if(_3f.style[_3e.transition]==="none"){_2.style(_3f,_3e.transition,_3e.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease");}_2.style(_3f,_3e.transition,_3d?"none":(_3e.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease"));_3f._matrix=mtx;css[_3e.transform]=esri._css.matrix(_3f._multiply?_3.gfx.matrix.multiply(mtx,_3f._multiply):mtx);_2.style(_3f,css);}}if(this._active&&this._active.childNodes.length===0){return;}_2.style(this._active,_3e.transition,_3d?"none":(_3e.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease"));this._active._matrix=mtx;css[_3e.transform]=esri._css.matrix(this._active._matrix);_2.style(this._active,css);this._passives.push(this._active);css={position:"absolute",width:map.width+"px",height:map.height+"px",overflow:"visible"};css[_3e.transition]=_3e.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease";_2.style((this._active=_2.create("div",null,this._div)),css);this._active._remove=0;if(map.fadeOnZoom){_2.place(this._active,this._div,"first");}},_onZoomHandler:function(_40,_41,_42){var _43=_2.coords(this._div);_42=_42.offset(-_43.l,-_43.t);var _44,_45=this._tileW*_41,_46=this._tileH*_41,_47=this._tileBounds,_48=this._tiles,es=_2.style;var _49=_2.isIE;if(_49&&_49<8){_2.forEach(this._tileIds,function(id){_44=_47[id];es(_48[id],{left:(_44.x-((_45-_44.width)*(_42.x-_44.x)/_44.width))+"px",top:(_44.y-((_46-_44.height)*(_42.y-_44.y)/_44.height))+"px",zoom:_41});});}else{_2.forEach(this._tileIds,function(id){_44=_47[id];es(_48[id],{left:(_44.x-((_45-_44.width)*(_42.x-_44.x)/_44.width))+"px",top:(_44.y-((_46-_44.height)*(_42.y-_44.y)/_44.height))+"px",width:_45+"px",height:_46+"px"});});}},_updateImages:function(_4a){if(!this._ct){return;}var id,_4b=this._tileW,_4c=this._tileH,_4d=this._ct,lod=_4d.lod,_4e=_4d.tile,off=_4e.offsets,_4f=_4e.coords,cr=_4f.row,cc=_4f.col,_50=lod.level,_51=this.opacity,_52=this._tileIds,_53=this._loadingList,_54=this._addImage,mId=this._map.id,tId=this.id,rx=_4a.x,ry=_4a.y,str=lod.startTileRow,etr=lod.endTileRow,stc=lod.startTileCol,etc=lod.endTileCol,_55=_2.indexOf,r,c,mvx=-_4a.x,mvy=-_4a.y,_56=off.x-this.__coords_dx,_57=off.y-this.__coords_dy,vx=((_4b-_56)+mvx),vy=((_4c-_57)+mvy),_58=Math.ceil,_59=(vx>0)?(vx%_4b):((_4b-(Math.abs(vx)%_4b))),_5a=(vy>0)?(vy%_4c):((_4c-(Math.abs(vy)%_4c))),_5b=(rx>0)?Math.floor((rx+_56)/_4b):_58((rx-(_4b-_56))/_4b),_5c=(ry>0)?Math.floor((ry+_57)/_4c):_58((ry-(_4c-_57))/_4c),_5d=_5b+_58((_4a.width-_59)/_4b),_5e=_5c+_58((_4a.height-_5a)/_4c),_5f,_60,_61,_62,col,row;if(this._wrap){_5f=lod._frameInfo;_60=_5f[0];_61=_5f[1];_62=_5f[2];}for(col=_5b;col<=_5d;col++){for(row=_5c;row<=_5e;row++){r=cr+row;c=cc+col;if(this._wrap){if(c<_61){c=c%_60;c=c<_61?c+_60:c;}else{if(c>_62){c=c%_60;}}}if(r>=str&&r<=etr&&c>=stc&&c<=etc){id=mId+"_"+tId+"_tile_"+_50+"_"+row+"_"+col;if(_55(_52,id)===-1){_53.add(id);_52.push(id);_54(_50,row,r,col,c,id,_4b,_4c,_51,_4e,off);}}}}},_cleanUpRemovedImages:function(){var _63=this._removeList,dd=_2.destroy,i,_64=esri._css.names;_63.forEach(function(img){if(!img._fadeOut){img.style.filter="";img.style.zoom=1;dd(img);}});if(this._map.navigationMode==="css-transforms"){for(i=this._passives.length-1;i>=0;i--){var _65=this._passives[i];if(_65.childNodes.length===0){this._passives.splice(i,1);dd(_65);}else{if(this._map.fadeOnZoom&&!_65._marked&&(_65._remove===_65.childNodes.length)){_2.style(_65,_64.transition,"opacity 0.65s");_2.style(_65,"opacity",0);_65._marked=1;if(_2.isIE>=10){_65.addEventListener(_64.endEvent,this._transitionEnd,false);}else{_65._endHandle=_2.connect(_65,_64.endEvent,this._transitionEnd);}}}}}_63.clear();},_transitionEnd:function(evt){var _66=evt.target,idx;if(evt.propertyName!=="opacity"){return;}if(_2.isIE>=10){_66.removeEventListener(esri._css.names.endEvent,this._transitionEnd,false);}else{_2.disconnect(_66._endHandle);_66._endHandle=null;}idx=_2.indexOf(this._passives,_66);if(idx>-1){this._passives.splice(idx,1);}if(_66.parentNode){_66.parentNode.removeChild(_66);}_2.destroy(_66);},_addImage:function(_67,row,r,col,c,id,_68,_69,_6a,_6b,_6c){if(this._patchIE){var div=(this._tiles[id]=_2.create("div"));div.id=id;_2.addClass(div,"layerTile");_2.style(div,{left:((_68*col)-_6c.x)+"px",top:((_69*row)-_6c.y)+"px",width:_68+"px",height:_69+"px",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+this.getTileUrl(_67,r,c)+"', sizingMethod='scale')"});if(_6a<1){_2.style(div,"opacity",_6a);}var _6d=div.appendChild(_2.create("div"));_2.style(_6d,{opacity:0,width:_68+"px",height:_69+"px"});this._div.appendChild(div);div=null;this._loadingList.remove(id);this._fireOnUpdateEvent();}else{var img=(this._tiles[id]=_2.create("img")),dc=_2.connect;img.id=id;_2.addClass(img,"layerTile");var _6e=(_68*col)-_6c.x,top=(_69*row)-_6c.y,map=this._map,_6f=esri._css.names,css={width:_68+"px",height:_69+"px",visibility:"hidden"};if(map.navigationMode==="css-transforms"){css[_6f.transform]=esri._css.translate(_6e,top);_2.style(img,css);img._left=_6e;img._top=top;}else{css.left=_6e+"px";css.top=top+"px";_2.style(img,css);}if(_6a<1){_2.style(img,"opacity",_6a);}img._onload_connect=dc(img,"onload",this,"_tileLoadHandler");img._onerror_connect=dc(img,"onerror",this,"_tileErrorHandler");img._onabort_connect=dc(img,"onabort",this,"_tileErrorHandler");var url=this.getTileUrl(_67,r,c,img);if(url){img.src=url;}if(map.navigationMode==="css-transforms"){this._active.appendChild(img);}else{this._div.appendChild(img);}img=null;}},getTileUrl:function(_70,row,col){},refresh:function(){if(!this.suspended){this._onExtentChangeHandler(this._map.extent,null,true,this._map.__LOD);}},_tilePopPop:function(img){var dd=_2.disconnect;dd(img._onload_connect);dd(img._onerror_connect);dd(img._onabort_connect);img._onload_connect=img._onerror_connect=img._onabort_connect=null;this._loadingList.remove(img.id);this._fireOnUpdateEvent();},_tileLoadHandler:function(evt){var img=evt.currentTarget;if(this._noDom){this._standby.push(img);return;}_2.style(img,"visibility","visible");this._tilePopPop(img);},_tileErrorHandler:function(evt){var img=evt.currentTarget;this.onError(new Error(esri.bundle.layers.tiled.tileError+": "+img.src));_2.style(img,"visibility","hidden");this._tilePopPop(img);},_fireOnUpdateEvent:function(){if(this._loadingList.count===0){this._cleanUpRemovedImages();if(this._fireOnUpdate){this._fireOnUpdate=false;this.onUpdate();this._fireUpdateEnd();}}},setOpacity:function(o){if(this.opacity!=o){this.onOpacityChange(this.opacity=o);}},onOpacityChange:function(){},_opacityChangeHandler:function(_71){var djs=_2.style,i,j,_72;if(this._map.navigationMode==="css-transforms"){if(this._active){_72=this._active.childNodes;for(i=_72.length-1;i>=0;i--){djs(_72[i],"opacity",_71);}}for(i=this._passives.length-1;i>=0;i--){_72=this._passives[i].childNodes;for(j=_72.length-1;j>=0;j--){djs(_72[j],"opacity",_71);}}return;}_72=this._div.childNodes;for(i=_72.length-1;i>=0;i--){djs(_72[i],"opacity",_71);}}});_2.declare("esri.layers.TileInfo",null,{constructor:function(_73){this.width=_73.cols||_73.width;this.height=_73.rows||_73.height;this.dpi=_73.dpi;this.format=_73.format;var sr=_73.spatialReference,ori=_73.origin;if(sr){sr=(this.spatialReference=new esri.SpatialReference(sr.declaredClass?sr.toJson():sr));}if(ori){ori=(this.origin=new esri.geometry.Point(ori.declaredClass?ori.toJson():ori));if(!ori.spatialReference&&sr){ori.setSpatialReference(new esri.SpatialReference(sr.toJson()));}}var _74=(this.lods=[]);_2.forEach(_73.lods,function(lod,i){_74[i]=new esri.layers.LOD(lod);});}});_2.declare("esri.layers.LOD",null,{constructor:function(_75){_2.mixin(this,_75);}});});